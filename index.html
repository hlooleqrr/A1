<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù†ØµØ© FINO -ØªØ±Ø´ÙŠØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠFINO â€” Smart Finance Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ø®Ø· Tajawal -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body{
      font-family:'Tajawal',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:#f3f4f6;
      margin:0;
      text-align:center;
      font-size:20px;
      direction:rtl;
      color:#111827;
    }
    header{
      background:linear-gradient(135deg,#0f172a,#1e3a8a);
      color:#fff;
      padding:14px 10px;
      position:sticky;
      top:0;
      z-index:10;
    }
    header h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    header p{
      margin:6px 0 0;
      font-size:13px;
      opacity:.9;
    }
    .wrap{
      max-width:780px;
      margin:16px auto 80px;
      padding:0 12px;
    }
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:16px;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      text-align:right;
    }
    .center{ text-align:center; }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:none;
      border-radius:14px;
      padding:12px 16px;
      font-size:18px;
      cursor:pointer;
      transition:.15s;
      font-weight:800;
      font-family:inherit;
    }
    .btn.primary{ background:#1e3a8a; color:#fff; }
    .btn.primary:hover{ filter:brightness(1.05); }
    .btn.secondary{ background:#eef2ff; color:#1e3a8a; border:1px solid #c7d2fe; }
    .btn.secondary:hover{ filter:brightness(1.02); }
    .btn.small{ padding:8px 12px; font-size:14px; border-radius:12px; font-weight:800; }
    .btn.icon{
      background:rgba(255,255,255,.16);
      color:#fff;
      border:1px solid rgba(255,255,255,.2);
      padding:8px 10px;
      border-radius:12px;
      font-size:14px;
      font-weight:900;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .muted{ color:#6b7280; font-size:14px; line-height:1.7; }
    label{
      display:block;
      font-weight:900;
      font-size:18px;
      margin:10px 0 8px;
      color:#111827;
    }
    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      font-size:18px;
      font-family:inherit;
      outline:none;
      background:#fff;
    }
    input:focus,select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.18);
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .grid2{ grid-template-columns:1fr; } }

    .notice{
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      border-radius:14px;
      padding:10px 12px;
      font-size:15px;
      line-height:1.8;
      margin-top:12px;
    }
    .notice-soft{
      background:#f0f9ff;
      border:1px solid #bae6fd;
      color:#075985;
      border-radius:14px;
      padding:10px 12px;
      font-size:15px;
      line-height:1.8;
      margin:12px 0;
    }
    .danger{
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#991b1b;
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      line-height:1.8;
      font-weight:900;
      margin:10px 0;
    }

    .instalment-row{
      background:#f9fafb;
      border:1px dashed #e5e7eb;
      padding:10px 12px;
      border-radius:14px;
      margin:8px 0;
      font-size:16px;
      line-height:1.8;
    }

    footer{
      position:fixed;
      bottom:0;
      left:0; right:0;
      background:#0b1220;
      color:#e5e7eb;
      padding:8px 10px;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      z-index:20;
    }
    footer .small{ font-size:12px; opacity:.95; }
    a{ color:inherit; }
    .hidden{ display:none !important; }

    /* Admin */
    .admin-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:520px){ .admin-grid{ grid-template-columns:1fr; } }
    .admin-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid #e5e7eb;
      font-size:14px;
      background:#fff;
    }
    .admin-table th, .admin-table td{
      padding:10px 10px;
      border-bottom:1px solid #eef2f7;
      vertical-align:top;
      text-align:right;
    }
    .admin-table th{
      background:#f8fafc;
      font-weight:900;
      color:#0f172a;
      font-size:13px;
    }
  </style>
</head>

<body>

<header>
  <div class="row" style="max-width:900px;margin:0 auto;padding:0 10px;">
    <div style="text-align:right">
      <h1>FINO â€” Ù…Ù†ØµØ© ØªØ±Ø´ÙŠØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</h1>
      <p>ØªØ­Ø³Ø¨ Ù„Ùƒ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆØªÙˆØ¶Ø­ Ø§Ù„ÙØªØ±Ø§Øª Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†Ù</p>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn icon" onclick="toggleAdminLogin()">âš™ï¸ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- Landing -->
  <section id="landingPage" class="card center">
    <h2 style="margin:0 0 6px; font-size:22px; font-weight:900; color:#0f172a;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø¨Ø© Ø§Ù„Ø¢Ù†</h2>
    <p class="muted" style="text-align:center;margin:0 0 12px;">
      ØªÙ†ÙˆÙŠÙ‡: Ù„Ø³Ù†Ø§ Ø¬Ù‡Ø© ØªÙ…ÙˆÙŠÙ„ÙŠØ©ØŒ ÙˆØ¯ÙˆØ±Ù†Ø§ ÙŠÙ‚ØªØµØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ³Ø§Ø·Ø© ÙˆØªØ±Ø´ÙŠØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙˆØ´Ø±ÙƒØ§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø±Ø®Ù‘ØµØ©.
    </p>
    <button class="btn primary" onclick="startFlow()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø¨Ø©</button>

    <!-- Admin login (hidden) -->
    <div id="adminLoginBox" class="hidden" style="margin-top:14px; text-align:right;">
      <div class="notice-soft" style="margin-bottom:10px;">
        Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø³Ø±ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
      </div>
      <div class="grid2">
        <div>
          <label>Ø±Ù‚Ù… Ø³Ø±ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
          <input id="adminPin" type="password" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢" />
        </div>
        <div style="display:flex;align-items:end;gap:10px;">
          <button class="btn secondary" style="width:100%" onclick="loginAdmin()">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn secondary" style="width:100%" onclick="toggleAdminLogin()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Questions -->
  <section id="questionPage" class="card hidden">
    <div class="row" style="margin-bottom:10px;">
      <div style="font-weight:900; font-size:18px; color:#0f172a;">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø³Ø¨Ø©</div>
      <button class="btn secondary small" onclick="resetAll()">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø¨Ø©</button>
    </div>

    <div id="questionContainer"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn secondary" onclick="prevQuestion()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button class="btn primary" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </section>

  <!-- Coming soon / disabled product -->
  <section id="comingSoonPage" class="card hidden center">
    <h2 style="margin:0 0 6px; font-size:22px; font-weight:900; color:#0f172a;">Ù‚Ø±ÙŠØ¨Ø§Ù‹</h2>
    <p id="comingSoonText" class="muted" style="text-align:center;margin:0 0 12px;"></p>
    <button class="btn primary" onclick="resetAll()">Ø±Ø¬ÙˆØ¹</button>
  </section>

  <!-- Result -->
  <section id="resultPage" class="card hidden">
    <div class="row" style="margin-bottom:10px;">
      <div style="font-weight:900; font-size:18px; color:#0f172a;">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø¨Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)</div>
      <button class="btn secondary small" onclick="resetAll()">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø¨Ø©</button>
    </div>

    <div id="resultBox"></div>
  </section>

  <!-- Sorry -->
  <section id="sorryPage" class="card hidden center">
    <div class="danger" style="text-align:center;">
      Ù†Ø¹ØªØ°Ø± Ù…Ù†Ùƒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙˆÙŠÙ„Ùƒ
    </div>
    <button class="btn primary" onclick="resetAll()">Ø±Ø¬ÙˆØ¹</button>
  </section>

  <!-- Admin -->
  <section id="adminPage" class="card hidden">
    <div class="row" style="margin-bottom:10px;">
      <div style="font-weight:900; font-size:18px; color:#0f172a;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
      <button class="btn secondary small" onclick="logoutAdmin()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <p class="muted" style="margin-top:0;">
      Ù‡Ù†Ø§ ØªØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ + Ø§Ø¹ØªØ°Ø§Ø±/Ø¨Ø¯ÙˆÙ† Ø§Ø¹ØªØ°Ø§Ø±) ÙˆØªØ¶ÙŠÙ/ØªØ­Ø°Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ø«Ù„ Ø¥Ø¶Ø§ÙØ© â€œØ«Ø±ÙˆØ©â€.
    </p>

    <hr style="margin:14px 0; border:none; border-top:1px solid #e5e7eb;">

    <h2 style="margin:0; font-size:19px; color:#111827;">Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

    <form onsubmit="saveProduct(event)">
      <div class="admin-grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input id="pName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø«Ø±ÙˆØ©">
        </div>

        <div>
          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
          <select id="pEnabled">
            <option value="true">Ù…ÙØ¹Ù‘Ù„</option>
            <option value="false">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option>
          </select>
        </div>

        <div>
          <label>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ØŸ</label>
          <select id="pApology">
            <option value="true">Ù†Ø¹Ù… (Ø§Ø¹ØªØ°Ø§Ø±)</option>
            <option value="false">Ù„Ø§ (Ø¨Ø¯ÙˆÙ† Ø§Ø¹ØªØ°Ø§Ø±)</option>
          </select>
        </div>

        <div>
          <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ (%)</label>
          <input id="pDeduction" type="number" min="0" step="0.01" value="45">
        </div>

        <div>
          <label>Ø³Ù‚Ù 33.33% (Ù…Ø¹Ø§Ù…Ù„Ø© Ø´Ø®ØµÙŠ)ØŸ</label>
          <select id="pCap33">
            <option value="true">Ù†Ø¹Ù…</option>
            <option value="false">Ù„Ø§</option>
          </select>
        </div>

        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="pJobType">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option>Ø¹Ø³ÙƒØ±ÙŠ</option>
            <option>Ù…Ø¯Ù†ÙŠ (Ù‚Ø·Ø§Ø¹ Ø­ÙƒÙˆÙ…ÙŠ)</option>
            <option>Ø®Ø§Øµ (Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ)</option>
            <option>Ø®Ø§Øµ (Ø´Ø±ÙƒØ© Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
            <option>Ø®Ø§Øµ (Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
          </select>
        </div>
      </div>

      <input type="hidden" id="pEditIndex" value="">
      <div class="row" style="margin-top:10px;">
        <button type="submit" class="btn primary small">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        <button type="button" class="btn secondary small" onclick="clearProductForm()">Ù…Ø³Ø­</button>
      </div>
    </form>

    <table class="admin-table" id="productTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ø¹ØªØ°Ø§Ø±ØŸ</th>
          <th>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹</th>
          <th>33.33ØŸ</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
          <th>ØªØ­ÙƒÙ…</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </section>

</div>

<footer>
  <div class="small">Â© FINO â€” Ù…Ù†ØµØ© ØªØ±Ø´ÙŠØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</div>
  <div class="small" id="dateTimeBox">â€”</div>
</footer>

<script>
/* ==========================
   Utils
========================== */
function escapeHtml(str){
  return String(str||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
function fmtMoney(n){
  const x = Number(n||0);
  if(!isFinite(x)) return '0 Ø±ÙŠØ§Ù„';
  return x.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' Ø±ÙŠØ§Ù„';
}
function showPage(page){
  const ids = ['landingPage','questionPage','resultPage','adminPage','comingSoonPage','sorryPage'];
  ids.forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById(page).classList.remove('hidden');
}
function updateDateTime(){
  const now = new Date();
  let greg = now.toLocaleString('ar-SA', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });

  let hijri = '';
  try{
    hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { year:'numeric', month:'2-digit', day:'2-digit' }).format(now);
  }catch(e){
    hijri = 'â€”';
  }
  document.getElementById('dateTimeBox').textContent = `Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ: ${greg} | Ø§Ù„Ù‡Ø¬Ø±ÙŠ: ${hijri}`;
}

/* ==========================
   Hijri helpers
========================== */
function getTodayHijriParts(){
  try{
    const fmt = new Intl.DateTimeFormat('en-SA-u-ca-islamic', { day:'numeric', month:'numeric', year:'numeric' });
    const parts = fmt.formatToParts(new Date());
    const obj = {};
    parts.forEach(p=>{
      if(p.type==='day') obj.d = parseInt(p.value,10);
      if(p.type==='month') obj.m = parseInt(p.value,10);
      if(p.type==='year') obj.y = parseInt(p.value,10);
    });
    return { d: obj.d||1, m: obj.m||1, y: obj.y||1446 };
  }catch(e){
    return { d: 1, m: 1, y: 1446 };
  }
}
function hijriToIndex(y,m,d){
  return (parseInt(y,10)*12) + (parseInt(m,10)-1) + ((parseInt(d,10)>=1)?0:0);
}
function monthsBetweenHijri(a,b){
  const ia = hijriToIndex(a.y,a.m,a.d);
  const ib = hijriToIndex(b.y,b.m,b.d);
  let diff = ib - ia;
  if (parseInt(b.d,10) < parseInt(a.d,10)) diff -= 1;
  return diff;
}
function describeMonths(m){
  m = Math.max(0, parseInt(m||0));
  const years = Math.floor(m/12);
  const months = m % 12;
  // ØµÙŠØ§ØºØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙˆØ§Ø¶Ø­Ø©
  let yTxt = '';
  if(years===0) yTxt = '';
  else if(years===1) yTxt = 'Ø³Ù†Ø©';
  else if(years===2) yTxt = 'Ø³Ù†ØªÙŠÙ†';
  else if(years>=3 && years<=10) yTxt = `${years} Ø³Ù†ÙˆØ§Øª`;
  else yTxt = `${years} Ø³Ù†Ø©`;

  let mTxt = '';
  if(months===0) mTxt = '';
  else if(months===1) mTxt = 'Ø´Ù‡Ø±';
  else if(months===2) mTxt = 'Ø´Ù‡Ø±ÙŠÙ†';
  else if(months>=3 && months<=10) mTxt = `${months} Ø£Ø´Ù‡Ø±`;
  else mTxt = `${months} Ø´Ù‡Ø±`;

  if(!yTxt && !mTxt) return `${m} Ø´Ù‡Ø±`;
  if(yTxt && !mTxt) return `${m} Ø´Ù‡Ø± (${yTxt})`;
  if(!yTxt && mTxt) return `${m} Ø´Ù‡Ø± (${mTxt})`;
  return `${m} Ø´Ù‡Ø± (${yTxt} Ùˆ${mTxt})`;
}

/* ==========================
   Military pension + retirement
========================== */
function calcMilitaryPension(lastBasicSalary, serviceMonths){
  const basic = Number(lastBasicSalary||0);
  const m = Number(serviceMonths||0);
  if(!basic || !m) return 0;
  let pension = (basic * m) / 420;
  if(pension > basic) pension = basic;
  return pension;
}

// Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ù„Ù„Ø±ØªØ¨ (ØªÙ‚Ø±ÙŠØ¨ÙŠ - Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³Ø¹ Ù„Ø§Ø­Ù‚Ø§Ù‹)
function getRetirementAge(rank){
  const map = {
    'Ø¬Ù†Ø¯ÙŠ':44,'Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„':44,'Ø¹Ø±ÙŠÙ':44,'ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨':44,'Ø±Ù‚ÙŠØ¨':44,'Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„':44,'Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡':44,
    'Ù…Ù„Ø§Ø²Ù…':48,'Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„':48,'Ù†Ù‚ÙŠØ¨':48,'Ø±Ø§Ø¦Ø¯':50,'Ù…Ù‚Ø¯Ù…':52,'Ø¹Ù‚ÙŠØ¯':54,'Ø¹Ù…ÙŠØ¯':56,'Ù„ÙˆØ§Ø¡':58
  };
  return map[rank] || 44;
}
function getMilitaryRemainingMonthsToRetirement(){
  const todayH = getTodayHijriParts();
  const birthY = parseInt(answers.birthYear||todayH.y);
  const age = todayH.y - birthY;
  const retAge = getRetirementAge(answers.militaryRank || 'Ø¬Ù†Ø¯ÙŠ');
  return (retAge - age) * 12;
}
function getRemainingMonthsToAge60(){
  const todayH = getTodayHijriParts();
  const birthY = parseInt(answers.birthYear||todayH.y);
  const age = todayH.y - birthY;
  return (60 - age) * 12;
}

/* ==========================
   Support (Ø³ÙƒÙ†ÙŠ) - ØªÙ‚Ø¯ÙŠØ± Ø´Ù‡Ø±ÙŠ Ø¨Ø³ÙŠØ·
   (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„Ù‡ Ø­Ø³Ø¨ Ø¬Ø¯ÙˆÙ„Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
========================== */
function getHousingSupportMonthlyBySalary(salary){
  salary = Number(salary||0);
  if(salary<=0) return 0;
  // ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ (Ù…ÙƒØ§Ù†Ù‡ Ù†ÙØ³ Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
  if(salary < 8000) return 1000;
  if(salary < 10000) return 900;
  if(salary < 12000) return 800;
  if(salary < 15000) return 700;
  return 0;
}

/* ==========================
   Product Admin
========================== */
let productConfigs = [];
const defaultProductConfigs = [
  { name:'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ', enabled:true, apology:false, deduction:45, cap33:true, jobType:'' },
  { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ', enabled:true, apology:false, deduction:45, cap33:false, jobType:'' },
  { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ', enabled:true, apology:false, deduction:45, cap33:true, jobType:'' },
  { name:'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', enabled:true, apology:false, deduction:65, cap33:false, jobType:'' },
  { name:'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ', enabled:true, apology:false, deduction:45, cap33:true, jobType:'' },
  { name:'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', enabled:false, apology:true, deduction:65, cap33:false, jobType:'' },
  { name:'Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù†', enabled:false, apology:true, deduction:25, cap33:false, jobType:'' },
  { name:'ØªÙ…ÙˆÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹', enabled:false, apology:true, deduction:45, cap33:false, jobType:'' },
  { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª', enabled:false, apology:true, deduction:45, cap33:false, jobType:'' },
  { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„', enabled:false, apology:true, deduction:45, cap33:false, jobType:'' },
];

function loadProductConfigs(){
  try{
    const s = localStorage.getItem('stProductConfigs');
    if(s) productConfigs = JSON.parse(s);
    else { productConfigs = defaultProductConfigs; saveProductConfigs(); }
  }catch(e){
    productConfigs = defaultProductConfigs;
    saveProductConfigs();
  }
  renderProductTable();
}
function saveProductConfigs(){
  localStorage.setItem('stProductConfigs', JSON.stringify(productConfigs));
}
function getProductCfgByName(name){
  return productConfigs.find(p=>p.name===name);
}
function getFinanceTypeOptionsDynamic(){
  return productConfigs.map(p=>p.name);
}
function shouldShowApologyForProduct(name){
  const p = getProductCfgByName(name);
  if(!p) return true;
  if(p.enabled) return false;
  return Boolean(p.apology);
}
function renderProductTable(){
  const tbody = document.querySelector('#productTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  productConfigs.forEach((p, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.name)}</td>
      <td>${p.enabled ? 'Ù…ÙØ¹Ù‘Ù„' : 'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'}</td>
      <td>${p.apology ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td>
      <td>${escapeHtml(p.deduction || '')}%</td>
      <td>${p.cap33 ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td>
      <td>${escapeHtml(p.jobType || 'Ø§Ù„ÙƒÙ„')}</td>
      <td>
        <button class="btn small secondary" onclick="editProduct(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn small secondary" onclick="deleteProduct(${idx})">Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function clearProductForm(){
  document.getElementById('pName').value='';
  document.getElementById('pEnabled').value='true';
  document.getElementById('pApology').value='true';
  document.getElementById('pDeduction').value='45';
  document.getElementById('pCap33').value='false';
  document.getElementById('pJobType').value='';
  document.getElementById('pEditIndex').value='';
}
function saveProduct(e){
  e.preventDefault();
  const name = (document.getElementById('pName').value||'').trim();
  const enabled = (document.getElementById('pEnabled').value === 'true');
  const apology = (document.getElementById('pApology').value === 'true');
  const deduction = Number(document.getElementById('pDeduction').value||0);
  const cap33 = (document.getElementById('pCap33').value === 'true');
  const jobType = document.getElementById('pJobType').value || '';
  const editIndex = document.getElementById('pEditIndex').value;

  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'); return; }

  const obj = { name, enabled, apology, deduction, cap33, jobType };
  if(editIndex==='') productConfigs.push(obj);
  else productConfigs[Number(editIndex)] = obj;

  saveProductConfigs();
  renderProductTable();
  clearProductForm();
}
function editProduct(idx){
  const p = productConfigs[idx];
  document.getElementById('pName').value=p.name||'';
  document.getElementById('pEnabled').value=String(Boolean(p.enabled));
  document.getElementById('pApology').value=String(Boolean(p.apology));
  document.getElementById('pDeduction').value=String(p.deduction||0);
  document.getElementById('pCap33').value=String(Boolean(p.cap33));
  document.getElementById('pJobType').value=p.jobType||'';
  document.getElementById('pEditIndex').value=String(idx);
}
function deleteProduct(idx){
  if(!confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
  productConfigs.splice(idx,1);
  saveProductConfigs();
  renderProductTable();
}

/* ==========================
   Flow state
========================== */
let step = 0;
let answers = {};
let history = [];

function resetAll(){
  step = 0;
  answers = {};
  history = [];
  showPage('landingPage');
}

/* ==========================
   Admin auth
========================== */
const ADMIN_PIN = '9999';
function toggleAdminLogin(){
  const box = document.getElementById('adminLoginBox');
  box.classList.toggle('hidden');
}
function loginAdmin(){
  const pin = (document.getElementById('adminPin').value || '').trim();
  if(pin !== ADMIN_PIN){
    alert('Ø±Ù‚Ù… Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
    return;
  }
  showPage('adminPage');
}
function logoutAdmin(){
  document.getElementById('adminPin').value='';
  showPage('landingPage');
}

/* ==========================
   Questions
========================== */
function buildOptions(from, to){
  const arr = [];
  for(let i=from;i<=to;i++) arr.push(String(i));
  return arr;
}

const jobTypeOptions = [
  'Ø¹Ø³ÙƒØ±ÙŠ',
  'Ù…Ø¯Ù†ÙŠ (Ù‚Ø·Ø§Ø¹ Ø­ÙƒÙˆÙ…ÙŠ)',
  'Ø®Ø§Øµ (Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ)',
  'Ø®Ø§Øµ (Ø´Ø±ÙƒØ© Ù…Ø¹ØªÙ…Ø¯Ø©)',
  'Ø®Ø§Øµ (Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)'
];

function getMaxAllowedMonths(){
  const todayH = getTodayHijriParts();
  const birthY = parseInt(answers.birthYear||todayH.y);
  const age = todayH.y - birthY;
  const isMilitary = (answers.jobType === 'Ø¹Ø³ÙƒØ±ÙŠ');
  const financeType = answers.financeType || '';

  const isPersonalLike = (
    financeType.includes('Ø´Ø®ØµÙŠ') ||
    financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ' ||
    financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ' ||
    financeType === 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ'
  );

  const isMortgage = (financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ');

  // Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ
  if(isMilitary){
    const monthsTo60 = getRemainingMonthsToAge60();
    if(monthsTo60 <= 0){
      showSorryPage(answers.clientName || "Ø§Ù„Ø¹Ù…ÙŠÙ„");
      return 0;
    }
    if(isMortgage){
      return Math.min(monthsTo60, 300); // Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
    }
    // Ø´Ø®ØµÙŠ/Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ/ØªØ£Ø¬ÙŠØ±ÙŠ: Ø³Ù‚Ù 60 Ø£Ùˆ Ø­ØªÙ‰ 60 Ø³Ù†Ø© (Ø§Ù„Ø£Ù‚Ù„)
    return Math.min(monthsTo60, isPersonalLike ? 60 : 360);
  }

  // ØºÙŠØ± Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ: Ø­ØªÙ‰ 60 Ø³Ù†Ø©
  const remainingYears = 60 - age;
  const remainingMonths = remainingYears * 12;
  if(remainingMonths <= 0){
    showSorryPage(answers.clientName || "Ø§Ù„Ø¹Ù…ÙŠÙ„");
    return 0;
  }

  if(isPersonalLike) return Math.min(remainingMonths, 60);
  return Math.min(remainingMonths, 360);
}

const generalQuestions = [
  {
    id:'financeType',
    label:'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ØªØ±ÙŠØ¯ Ø­Ø³Ø¨ØªÙ‡:',
    type:'select',
    options:[],
    dynamicFinance:true
  },
  { id:'clientName', label:'Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…', type:'text', placeholder:'Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯' },

  { id:'jobType', label:'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©', type:'select', options:jobTypeOptions },

  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ø¨Ø§Ù„Ù‡Ø¬Ø±ÙŠ (1370/07/01 Ø¥Ù„Ù‰ 1430/01/01) Ø§ÙØªØ±Ø§Ø¶ÙŠ 1412/01/01
  { id:'birthDay', label:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù‡Ø¬Ø±ÙŠ) - Ø§Ù„ÙŠÙˆÙ…', type:'select', options:buildOptions(1,30), default:'1' },
  { id:'birthMonth', label:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù‡Ø¬Ø±ÙŠ) - Ø§Ù„Ø´Ù‡Ø±', type:'select', options:buildOptions(1,12), default:'1' },
  { id:'birthYear', label:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù‡Ø¬Ø±ÙŠ) - Ø§Ù„Ø³Ù†Ø©', type:'select', options:(function(){
      const arr=[]; for(let y=1430;y>=1370;y--) arr.push(String(y)); return arr;
    })(), default:'1412'
  },

  // Ø§Ù„Ø±ØªØ¨Ø© Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ
  {
    id:'militaryRank',
    label:'Ø§Ø°ÙƒØ± Ø§Ù„Ø±ØªØ¨Ø©',
    type:'select',
    options:['Ø¬Ù†Ø¯ÙŠ','Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„','Ø¹Ø±ÙŠÙ','ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨','Ø±Ù‚ÙŠØ¨','Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„','Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡','Ù…Ù„Ø§Ø²Ù…','Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„','Ù†Ù‚ÙŠØ¨','Ø±Ø§Ø¦Ø¯','Ù…Ù‚Ø¯Ù…','Ø¹Ù‚ÙŠØ¯','Ø¹Ù…ÙŠØ¯','Ù„ÙˆØ§Ø¡'],
    show:a => a.jobType==='Ø¹Ø³ÙƒØ±ÙŠ'
  },

  { id:'salary', label:'ÙƒÙ… Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØµØ§ÙÙŠØŸ', type:'number', placeholder:'Ù…Ø«Ø§Ù„: 10000' },

  // Ø¹Ù‚Ø§Ø±ÙŠ: Ù…Ø¯Ø¹ÙˆÙ…/ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… + Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø³ÙƒÙ†ÙŠØŸ (bundle)
  {
    id:'supported',
    label:'Ù‡Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ø¯Ø¹ÙˆÙ…ØŸ',
    type:'select',
    options:['Ù…Ø¯Ø¹ÙˆÙ…','ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'],
    show:a => a.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ'
  },
  {
    id:'bundle',
    label:'Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø³ÙƒÙ†ÙŠØŸ',
    type:'select',
    options:['Ù†Ø¹Ù…','Ù„Ø§'],
    show:a => a.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && a.supported === 'Ù…Ø¯Ø¹ÙˆÙ…'
  },

  // ØµÙØ­Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ (Ù„Ù„Ù…Ø¯Ø¹ÙˆÙ… + Ø§Ø®ØªØ§Ø± Ù„Ø§ Ù„Ù„Ø¯ÙØ¹Ø© + Ø±Ø§ØªØ¨Ù‡ Ø£Ù‚Ù„ Ù…Ù† 15000)
  {
    id:'addSupportToSalary',
    label:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ØŸ',
    type:'select',
    options:['Ù†Ø¹Ù…','Ù„Ø§'],
    show:a => a.financeType==='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && a.supported==='Ù…Ø¯Ø¹ÙˆÙ…' && a.bundle==='Ù„Ø§' && Number(a.salary||0) < 15000
  },

  // Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„
  { id:'months', label:'Ø¹Ù„Ù‰ ÙƒÙ… Ø´Ù‡Ø± ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ØŸ', type:'select', options:[], dynamic:true },

  // âœ… Ù‚Ø¨Ù„ ØµÙØ­Ø© Ø§Ù„Ù†Ø³Ø¨Ø©: Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù…ØªØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ø¹Ø³ÙƒØ±ÙŠ + Ø¹Ù‚Ø§Ø±ÙŠ + Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø© + Ø¹Ù…Ø±Ù‡ Ø£Ù‚Ù„ Ù…Ù† 60)
  {
    id:'extendAfterRetirement',
    label:'Ù‡Ù„ ØªØ±ØºØ¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØªÙ…ÙˆÙŠÙ„Ùƒ Ù…Ù…ØªØ¯ Ø¥Ù„Ù‰ Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ØŸ',
    type:'select',
    options:['Ù†Ø¹Ù…','Ù„Ø§'],
    show:a=>{
      if(a.jobType!=='Ø¹Ø³ÙƒØ±ÙŠ') return false;
      if(a.financeType!=='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ') return false;
      const monthsSel = parseInt(a.months||'0');
      if(!monthsSel) return false;
      const remToRet = getMilitaryRemainingMonthsToRetirement();
      const remTo60 = getRemainingMonthsToAge60();
      return (remTo60 > 0) && (remToRet > 0) && (remToRet < monthsSel) && (remToRet < 300);
    }
  },

  // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù‡Ø¬Ø±ÙŠ)
  { id:'retDay', label:'Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù‡Ø¬Ø±ÙŠ):', type:'select', options:buildOptions(1,30), default:'1', show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
  { id:'retMonth', label:'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù‡Ø¬Ø±ÙŠ):', type:'select', options:buildOptions(1,12), default:'1', show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
  { id:'retYear', label:'Ø§Ø®ØªØ± Ø³Ù†Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù‡Ø¬Ø±ÙŠ):', type:'select', options:(function(){ const arr=[]; const now=getTodayHijriParts().y; for(let y=now+35;y>=now-2;y--) arr.push(String(y)); return arr; })(), default:(function(){return String(getTodayHijriParts().y);})(), show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },

  // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ)
  { id:'hireDay', label:'Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ):', type:'select', options:buildOptions(1,30), default:'1', show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
  { id:'hireMonth', label:'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ):', type:'select', options:buildOptions(1,12), default:'1', show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
  { id:'hireYear', label:'Ø§Ø®ØªØ± Ø³Ù†Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ):', type:'select', options:(function(){ const arr=[]; const now=getTodayHijriParts().y; for(let y=now-1;y>=now-60;y--) arr.push(String(y)); return arr; })(), default:(function(){return String(getTodayHijriParts().y-25);})(), show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },

  // Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ±
  { id:'lastBasicSalary', label:'ÙƒÙ… Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± (Ù„Ù„Ø±ØªØ¨Ø©/Ø§Ù„Ø¯Ø±Ø¬Ø©)ØŸ', type:'number', placeholder:'Ù…Ø«Ø§Ù„: 6000', show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
];

function startFlow(){
  step = 0;
  answers = {};
  history = [];
  showPage('questionPage');
  showQuestion();
}

function showComingSoonForProduct(name){
  document.getElementById('comingSoonText').textContent = `Ø§Ù„Ù…Ù†ØªØ¬ "${name}" ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.`;
  showPage('comingSoonPage');
}

function showSorryPage(name){
  showPage('sorryPage');
}

function showQuestion(){
  const cont = document.getElementById('questionContainer');
  cont.innerHTML = '';

  // Ø§Ù†ØªÙ‚Ù„ Ù„Ø£Ù‚Ø±Ø¨ Ø³Ø¤Ø§Ù„ ÙØ¹Ù„ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¹Ø±Ø¶
  let q = generalQuestions[step];
  if(!q){ calculate(); return; }

  // ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©
  while(q && q.show && q.show(answers) === false){
    step++;
    q = generalQuestions[step];
    if(!q){ calculate(); return; }
  }

  // financeType Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
  if(q.id === 'financeType'){
    const opts = getFinanceTypeOptionsDynamic();
    if(!opts.length){
      cont.innerHTML = `<div class="danger">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</div>`;
      return;
    }
    const div = document.createElement('div');
    div.innerHTML = `<label>${escapeHtml(q.label)}</label>`;
    const sel = document.createElement('select');
    sel.id = 'answerInput';
    opts.forEach(opt => {
      sel.innerHTML += `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`;
    });
    if(answers[q.id]) sel.value = answers[q.id];
    div.appendChild(sel);
    cont.appendChild(div);
    return;
  }

  // coming soon Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  if(q.id === 'salary'){
    if(shouldShowApologyForProduct(answers.financeType)){
      showComingSoonForProduct(answers.financeType);
      return;
    }
  }

  // dynamic months options
  if(q.id === 'months' && q.dynamic){
    const maxM = getMaxAllowedMonths();
    if(!maxM){ return; }
    q.options = [];
    for(let i=12;i<=maxM;i++){
      q.options.push(String(i));
    }
  }

  const div = document.createElement('div');
  div.innerHTML = `<label>${escapeHtml(q.label)}</label>`;

  let input;
  if(q.type === 'select'){
    input = document.createElement('select');
    input.id = 'answerInput';
    (q.options||[]).forEach(opt=>{
      const o = document.createElement('option');
      o.value = opt;
      o.textContent = opt;
      input.appendChild(o);
    });
    if(answers[q.id]) input.value = answers[q.id];
    else if(q.default) input.value = q.default;
  }else{
    input = document.createElement('input');
    input.id = 'answerInput';
    input.type = (q.type === 'number') ? 'number' : 'text';
    if(q.type === 'number') input.inputMode = 'numeric';
    if(q.placeholder) input.placeholder = q.placeholder;
    input.value = (answers[q.id] ?? '');
  }

  div.appendChild(input);
  cont.appendChild(div);

  // ØªÙ„Ù…ÙŠØ­Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
  if(q.id === 'months'){
    const maxM = getMaxAllowedMonths();
    cont.innerHTML += `<div class="notice-soft">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: <strong>${describeMonths(maxM)}</strong></div>`;
  }

  if(q.id === 'extendAfterRetirement'){
    cont.innerHTML += `<div class="notice-soft">ÙÙŠ Ø­Ø§Ù„Ø© (Ù†Ø¹Ù…) Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù‚Ø³Ø· Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹.</div>`;
  }
}

function getCurrentQuestion(){
  let i = step;
  while(i < generalQuestions.length){
    const q = generalQuestions[i];
    if(q.show && q.show(answers) === false){
      i++;
      continue;
    }
    return q;
  }
  return null;
}

function nextQuestion(){
  const q = getCurrentQuestion();
  if(!q){ calculate(); return; }

  const el = document.getElementById('answerInput');
  if(!el){ return; }
  const val = (el.value ?? '').toString().trim();

  // financeType coming soon Ø¨Ø¯ÙˆÙ† Ø³Ø¤Ø§Ù„ Ø¥Ø¶Ø§ÙÙŠ
  if(q.id === 'financeType'){
    answers[q.id] = val;

    // ØªØ­Ù‚Ù‚ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„Ù…Ù†ØªØ¬ (Ø¥Ø°Ø§ Ù…Ø­Ø¯Ø¯)
    const pCfg = getProductCfgByName(val);
    if(pCfg && pCfg.jobType && answers.jobType && pCfg.jobType !== answers.jobType){
      showComingSoonForProduct(val);
      return;
    }

    if(shouldShowApologyForProduct(val)){
      showComingSoonForProduct(val);
      return;
    }
  }else{
    answers[q.id] = val;
  }

  // Ø­ÙØ¸ Ù‚ÙŠÙ… Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù…Ø±ÙƒØ¨Ø©
  if(q.id === 'birthDay' || q.id === 'birthMonth' || q.id === 'birthYear'){
    answers.birthDay = answers.birthDay || '1';
    answers.birthMonth = answers.birthMonth || '1';
    answers.birthYear = answers.birthYear || '1412';
  }

  // Ù„Ùˆ Ø±ÙØ¶ Ø§Ù„Ù…Ù…ØªØ¯: Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù„Ø§ Ù†ØªØ¬Ø§ÙˆØ² Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯)
  if(q.id === 'extendAfterRetirement' && val === 'Ù„Ø§'){
    const monthsSel = parseInt(answers.months||'0');
    const remToRet = getMilitaryRemainingMonthsToRetirement();
    if(remToRet > 0 && monthsSel > remToRet){
      alert(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯: ${describeMonths(remToRet)}.`);
      answers.months = String(remToRet);
    }
  }

  // Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
  history.push(step);
  step++;

  // ØªØ®Ø·ÙŠ ØºÙŠØ± Ø§Ù„Ø¸Ø§Ù‡Ø±
  while(step < generalQuestions.length){
    const nq = generalQuestions[step];
    if(nq.show && nq.show(answers) === false){
      step++;
      continue;
    }
    break;
  }

  if(step >= generalQuestions.length){
    calculate();
    return;
  }
  showQuestion();
}

function prevQuestion(){
  if(!history.length){
    showPage('landingPage');
    return;
  }
  step = history.pop();
  showQuestion();
}

/* ==========================
   Calculation (ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)
   - ØªÙ‚Ø³ÙŠÙ… Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ (Ø§Ù„Ù…Ù…ØªØ¯)
   - Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ (Ù…Ø¯Ø¹ÙˆÙ… + bundle Ù„Ø§ + Ø±Ø§ØªØ¨ Ø£Ù‚Ù„ Ù…Ù† 15000)
========================== */
function calculate(){
  const financeType = answers.financeType || '';
  const name = answers.clientName || 'Ø¹Ø²ÙŠØ²ÙŠ';
  const salary = Number(answers.salary||0);
  const months = parseInt(answers.months||'0');

  if(!salary || salary <= 0 || !months || months <= 0){
    showSorryPage(name);
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„Ù…Ù†ØªØ¬ (Ø¥Ø°Ø§ Ù…Ø­Ø¯Ø¯)
  const pCfg = getProductCfgByName(financeType);
  if(pCfg && pCfg.jobType && answers.jobType && pCfg.jobType !== answers.jobType){
    showComingSoonForProduct(financeType);
    return;
  }

  const isMortgage = (financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ');
  const supported = answers.supported || 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…';
  const bundle = answers.bundle || 'Ù†Ø¹Ù…';
  const addSupport = (answers.addSupportToSalary === 'Ù†Ø¹Ù…');

  const isMilitary = (answers.jobType === 'Ø¹Ø³ÙƒØ±ÙŠ');
  const wantsExtend = (answers.extendAfterRetirement === 'Ù†Ø¹Ù…');

  // deductionRate Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  let deductionRate = 45;

  if(isMortgage){
    // Ø­Ø³Ø¨ Ø´Ø±Ø·Ùƒ: 65% Ø¥Ø°Ø§ Ø§Ù„Ø±Ø§ØªØ¨ >= 15000 Ø£Ùˆ Ø¥Ø°Ø§ (Ù…Ø¯Ø¹ÙˆÙ… + Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ø³ÙƒÙ†ÙŠ = Ù„Ø§)
    if(salary >= 15000) deductionRate = 65;
    else if(supported === 'Ù…Ø¯Ø¹ÙˆÙ…' && bundle === 'Ù„Ø§') deductionRate = 65;
    else deductionRate = 55;
  }else{
    // Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if(pCfg && typeof pCfg.deduction === 'number' && pCfg.deduction > 0){
      deductionRate = Number(pCfg.deduction);
    }
  }

  // Ø³Ù‚Ù 33.33% Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¥Ø°Ø§ Ù…ÙØ¹Ù‘Ù„ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
  const cap33 = pCfg ? Boolean(pCfg.cap33) : false;

  // ØªØ­Ø¯ÙŠØ¯ Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ + Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
  let retireAtMonth = 0;
  let expectedPension = 0;

  if(isMortgage && isMilitary && wantsExtend){
    const todayH = getTodayHijriParts();
    const retH = { d: parseInt(answers.retDay||'1'), m: parseInt(answers.retMonth||'1'), y: parseInt(answers.retYear||String(todayH.y)) };
    retireAtMonth = monthsBetweenHijri(todayH, retH);
    if(retireAtMonth < 1) retireAtMonth = 1;
    if(retireAtMonth > months) retireAtMonth = months;

    const hireH = { d: parseInt(answers.hireDay||'1'), m: parseInt(answers.hireMonth||'1'), y: parseInt(answers.hireYear||String(todayH.y-25)) };
    const serviceMonths = monthsBetweenHijri(hireH, retH);

    expectedPension = calcMilitaryPension(Number(answers.lastBasicSalary||0), serviceMonths);
  }

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡ÙˆØ±
  const futurePhases = [];
  let supportMonthly = 0;

  if(isMortgage && supported==='Ù…Ø¯Ø¹ÙˆÙ…' && bundle==='Ù„Ø§'){
    supportMonthly = getHousingSupportMonthlyBySalary(salary);
  }

  for(let mm=1; mm<=months; mm++){
    let phaseIncome = salary;
    let afterRet = false;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯
    if(isMortgage && supported==='Ù…Ø¯Ø¹ÙˆÙ…' && bundle==='Ù„Ø§' && addSupport && salary < 15000){
      phaseIncome = salary + supportMonthly;
    }

    // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ø§Ù„Ù…Ù…ØªØ¯)
    if(isMortgage && isMilitary && wantsExtend && retireAtMonth){
      afterRet = (mm > retireAtMonth);
      if(afterRet){
        phaseIncome = expectedPension || 0;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø±Ù‡ (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ)
        if(supported==='Ù…Ø¯Ø¹ÙˆÙ…' && bundle==='Ù„Ø§' && addSupport && salary < 15000){
          phaseIncome = phaseIncome + supportMonthly;
        }
      }
    }

    // allowed installment
    let allowed = (phaseIncome * deductionRate / 100);

    // Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ: Ø¥Ø°Ø§ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ (Ù…Ø¯Ø¹ÙˆÙ…+bundle Ù„Ø§+Ø±Ø§ØªØ¨<15000) ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ 65% Ù…Ù† (Ø§Ù„Ø±Ø§ØªØ¨+Ø§Ù„Ø¯Ø¹Ù…) Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯
    if(isMortgage && supported==='Ù…Ø¯Ø¹ÙˆÙ…' && bundle==='Ù„Ø§' && addSupport && salary < 15000){
      allowed = phaseIncome * 0.65;
    }

    // Ø³Ù‚Ù 33.33% Ù„Ùˆ Ù…Ù†ØªØ¬ Ø´Ø®ØµÙŠ ÙˆÙ…ÙØ¹Ù‘Ù„
    if(!isMortgage && cap33){
      allowed = Math.min(allowed, salary * 0.3333);
    }

    // Ù„Ùˆ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ (Ù…Ø«Ù„Ø§Ù‹ Ø±Ø§ØªØ¨ ØªÙ‚Ø§Ø¹Ø¯ÙŠ 0) Ù†Ø¹ØªØ°Ø±
    if(allowed < 0 || !isFinite(allowed)){
      showSorryPage(name);
      return;
    }

    futurePhases.push({ month:mm, inst: allowed, afterRetirement: afterRet });
  }

  // ØªØ¬Ù…ÙŠØ¹ ÙØªØ±Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø© Ù…Ø¹ ÙØµÙ„ Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø­ØªÙ‰ Ù„Ùˆ Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ø·
  const finalPhases = [];
  for(let i=0;i<futurePhases.length;i++){
    const cur = futurePhases[i];
    const prev = finalPhases[finalPhases.length-1];

    const changedInst = (!prev) || (cur.inst !== prev.inst);
    const changedFlag = (!prev) || (Boolean(cur.afterRetirement) !== Boolean(prev.afterRetirement));

    if(!prev || changedInst || changedFlag){
      finalPhases.push({ from:cur.month, to:cur.month, inst:cur.inst, afterRetirement:Boolean(cur.afterRetirement) });
    }else{
      prev.to = cur.month;
    }
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
  const box = document.getElementById('resultBox');
  let html = `
    <div class="notice-soft" style="margin-top:0;">
      <div style="font-weight:900; font-size:18px; color:#0f172a;">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙˆÙ…Ø³Ù‡Ù„Ø§ ÙŠØ§ ${escapeHtml(name)}</div>
      <div class="muted" style="margin-top:6px;">
        Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬: <strong>${escapeHtml(financeType)}</strong> â€” Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„: <strong>${describeMonths(months)}</strong>
      </div>
    </div>
  `;

  if(isMortgage && isMilitary && wantsExtend && expectedPension){
    html += `
      <div class="notice-soft">
        Ø±Ø§ØªØ¨Ùƒ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (ØªÙ‚Ø±ÙŠØ¨ÙŠ): <strong>${fmtMoney(expectedPension)}</strong>
      </div>
    `;
  }

  html += `<h3 style="margin:10px 0 6px; font-size:18px; font-weight:900; color:#0f172a;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø§Øª</h3>`;

  finalPhases.forEach(p=>{
    const tag = p.afterRetirement ? ' (Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯)' : '';
    html += `
      <div class="instalment-row">
        Ø§Ù„Ù‚Ø³Ø· Ù…Ù† Ø§Ù„Ø´Ù‡Ø± <strong>${p.from}</strong> Ø¥Ù„Ù‰ <strong>${p.to}</strong>${tag}:
        <strong>${fmtMoney(p.inst)}</strong>
      </div>
    `;
  });

  html += `
    <div class="notice" style="margin-top:12px;">
      ØªÙ†ÙˆÙŠÙ‡: Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØªØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ØŒ ÙˆÙ„ÙŠØ³Øª Ø¹Ø±Ø¶Ø§Ù‹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø¬Ù‡Ø© ØªÙ…ÙˆÙŠÙ„.
    </div>
  `;

  box.innerHTML = html;
  showPage('resultPage');
}

/* ==========================
   Coming soon / flow rules
========================== */
function showSorryPage(name){
  showPage('sorryPage');
}

/* ==========================
   Init
========================== */
document.addEventListener('DOMContentLoaded', () => {
  showPage('landingPage');
  loadProductConfigs();
  updateDateTime();
  setInterval(updateDateTime, 1000);
});
</script>

</body>
</html>