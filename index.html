<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù†ØµØ© FINO -ØªØ±Ø´ÙŠØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠFINO â€” Smart Finance Match </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Tajawal', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f3f4f6;
      margin: 0;
      text-align: center;
      font-size: 20px;
      direction: rtl;
      color: #111827;
    }
    header {
      background: linear-gradient(135deg, #0f172a, #1e3a8a);
      color: #fff;
      padding: 14px 10px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    header p {
      margin: 4px 0 0;
      font-size: 16px;
      opacity: 0.95;
    }
    .top-bar {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      max-width: 900px;
      margin: 0 auto;
    }

    .page-container {
      max-width: 900px;
      margin: 16px auto 32px;
      padding: 0 10px;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 16px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      margin-bottom: 14px;
      text-align: center;
      width: 100%;
    }

    button, .btn {
      border-radius: 999px;
      border: none;
      padding: 14px 22px;
      font-size: 19px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;
    }
    button.primary, .btn.primary {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35);
    }
    button.primary:hover, .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45);
      background: #1d4ed8;
    }
    button.secondary, .btn.secondary {
      background: #e0f2fe;
      color: #1d4ed8;
    }
    button.secondary:hover, .btn.secondary:hover {
      background: #dbeafe;
    }
    button.small, .btn.small {
      padding: 12px 20px;
      font-size: 18px;
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 12px;
      margin: 8px 0 2px;
      font-size: 18px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      text-align: right;
      background: #f9fafb;
      color: #111827;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
      background: #ffffff;
    }
    label {
      display: block;
      text-align: right;
      font-size: 17px;
      margin-top: 8px;
      margin-bottom: 2px;
      color: #374151;
    }

    .fade-in {
      animation: fadeInMove .3s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }
    @keyframes fadeInMove {
      to { opacity: 1; transform: translateY(0); }
    }

    .page { display: none; }
    .page.active { display: block; }

    .welcome-title {
      font-size: 23px;
      margin-bottom: 6px;
      color: #111827;
    }
    .welcome-sub {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 18px;
    }

    .steps-badge {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 6px;
      text-align: right;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }
    .client-chip {
      background: #e0f2fe;
      color: #1d4ed8;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 14px;
      border: 1px solid #bfdbfe;
    }
    .badge-mode {
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      display: inline-block;
    }
    .badge-duration {
      background: #e0f2fe;
      color: #1e3a8a;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      display: inline-block;
      margin-top: 3px;
    }

    .bank-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      background: #eff6ff;
      border: 1px dashed #2563eb;
      margin: 8px 0 12px;
      text-align: right;
    }
    .bank-logo {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
      border: 1px solid #e5e7eb;
    }
    .bank-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .bank-text-main {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
    }
    .bank-text-sub {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.5;
    }

    /* ====== ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ====== */
    .result-main-block {
      background: radial-gradient(circle at top, #e0f2fe 0, #ffffff 60%);
      border-radius: 18px;
      padding: 12px 14px;
      margin-top: 4px;
      text-align: right;
      border: 1px solid #bfdbfe;
    }
    .result-main-title {
      font-size: 14px;
      color: #1d4ed8;
      margin-bottom: 2px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 900;
    }
    .result-amount-main {
      font-size: 30px;
      font-weight: 900;
      color: #1e40af;
      margin: 2px 0 6px;
      letter-spacing: .2px;
      line-height: 1.2;
    }
    .result-amount-sub {
      font-size: 13px;
      color: #1d4ed8;
      margin: 2px 0;
      line-height: 1.6;
    }
    .result-amount-small {
      font-size: 13px;
      color: #374151;
      margin-top: 2px;
      line-height: 1.6;
    }

    .support-panel {
      margin-top: 10px;
      border-radius: 16px;
      padding: 10px 12px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
    }
    .support-title {
      font-size: 13px;
      font-weight: 900;
      color: #0f766e;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom: 6px;
    }
    .support-row {
      font-size: 13px;
      color: #0f172a;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .support-row:last-child{ border-bottom:none; }
    .support-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background:#ecfeff;
      color:#155e75;
      border: 1px solid #a5f3fc;
      margin-top: 6px;
    }

    .dual-main-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .dual-box {
      background: #eff6ff;
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 13px;
      text-align: right;
      border: 1px solid #dbeafe;
    }
    .dual-box-title {
      font-size: 12px;
      color: #1d4ed8;
      margin-bottom: 2px;
      font-weight: 900;
    }
    .dual-box-amount {
      font-size: 18px;
      font-weight: 900;
      color: #1e3a8a;
    }

    .result-section-title {
      text-align: right;
      font-size: 16px;
      font-weight: 900;
      margin: 12px 0 6px;
      color: #111827;
    }
    .result-section-box {
      border-radius: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      text-align: right;
    }

    /* Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø¨Ø®Ø· Ø£ÙˆØ¶Ø­ */
    .instalment-row {
      font-size: 15px;
      padding: 7px 0;
      border-bottom: 1px dashed #e5e7eb;
      text-align: right;
      color: #111827;
      line-height: 1.6;
      font-weight: 700;
    }
    .instalment-row strong { font-weight: 900; color:#1e3a8a; }
    .instalment-row:last-child { border-bottom: none; }

    .alert-error {
      color: #b91c1c;
      background: #fef2f2;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 14px;
      margin: 6px 0;
      text-align: right;
      border: 1px solid #fecaca;
      line-height: 1.55;
    }

    .notice-soft {
      color:#9f1239;
      background:#fff1f2;
      border:1px solid #fecdd3;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      text-align:right;
      line-height: 1.6;
      margin-top: 8px;
    }

    /* VAT small */
    .vat-small {
      font-size: 11px;
      color: #6b7280;
      font-weight: 600;
      margin-top: 2px;
    }

    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 8px 12px;
      margin-top: 6px;
      text-align: right;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .admin-table th, .admin-table td {
      border: 1px solid #e5e7eb;
      padding: 5px 6px;
      font-size: 12px;
      text-align: center;
      vertical-align: top;
    }
    .admin-table th {
      background: #f3f4f6;
      color: #374151;
    }

    footer {
      font-size: 13px;
      color: #6b7280;
      margin-top: 10px;
      padding: 8px 12px;
      position: relative;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }

    .footer-inner {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ØªØ­Øª Ø§Ù„ÙÙˆØªØ± */
    #miniAdminTools {
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px dashed #e5e7eb;
      background:#fff;
      color:#111827;
      font-size: 12px;
      user-select:none;
    }
    #miniAdminTools:hover { background:#f3f4f6; }

    /* Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØµÙˆØ±Ø© */
    .client-preview {
      background:#ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 12px 12px;
      text-align:right;
      line-height:1.7;
      font-size:14px;
      color:#111827;
    }
    .client-preview .h {
      font-weight: 900;
      color:#1e3a8a;
      font-size:16px;
      margin-bottom:6px;
    }
    .client-preview .k {
      color:#374151;
      font-weight: 800;
    }
    .client-preview .v {
      color:#0f172a;
      font-weight: 900;
    }
    .client-preview .hr {
      height:1px;background:#e5e7eb;margin:10px 0;
    }

    /* ====== (Ø¥Ø¶Ø§ÙØ©) Ø´Ø±ÙŠØ· ØµØºÙŠØ± Ù„Ù„Ù‡Ø¬Ø±ÙŠ ====== */
    .hijri-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      background:#eff6ff;
      color:#1d4ed8;
      border: 1px solid #dbeafe;
      margin-right:6px;
      font-weight:800;
      white-space:nowrap;
    }
  </style>
</head>
<body>

<header>
  <div class="top-bar">
    <div style="text-align:right">
      <h1>Ù…Ù†ØµØ© FINO</h1>
      <p>Ù…Ù†ØµØ© Ø°ÙƒÙŠØ© ØªØ­Ø³Ø¨ Ù„Ùƒ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØªÙØ±Ø´Ù‘Ø­ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù†Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø§ØªØ¨Ùƒ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†ÙØŒ Ø¨Ø¯ÙˆÙ† Ø­ÙŠØ±Ø© ÙˆÙ„Ø§ ØªØ¹Ø¨</p>
    </div>
  </div>
</header>

<div class="page-container">

  <!-- ØµÙØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
  <div id="landingPage" class="page active">
    <div class="card fade-in">
      <div class="welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</div>
      <div class="welcome-sub">
        Ù…Ù† Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØ­Ø³Ø¨ ØªÙ…ÙˆÙŠÙ„Ùƒ ÙˆØªØ´ÙˆÙ Ø£ÙØ¶Ù„ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ Ù„Ùƒ Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø±Ø§ØªØ¨Ùƒ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ.
      </div>
      <button class="primary" onclick="startClientFlow()">
        Ø§Ø¨Ø¯Ø£ Ø¨Ø£Ø³Ù… Ø§Ù„Ù„Ù‡
      </button>
      <div style="margin-top:12px; font-size:13px; color:#6b7280;">
        Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…ØµÙ…Ù…Ø© Ø¨Ø­ÙŠØ« ØªÙ‚Ø¯Ø± ØªØµÙˆÙ‘Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ ØªØ­ÙØ¸Ù‡Ø§ ÙƒØµÙˆØ±Ø© .
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© -->
  <div id="calculatorPage" class="page">
    <div class="card">
      <div class="steps-badge">
        Ø£Ø³Ø¦Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø£Ø¯Ù‚ Ø­Ø³Ø¨Ø© Ù…Ù…ÙƒÙ†Ø© ğŸ‘Œ
      </div>
      <div id="question"></div>
      <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
        <button id="nextButton" class="primary small" style="display:none;" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="mainButton" class="primary small" onclick="handleStartOrReset()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø¨Ø©</button>
      </div>
      <div id="resetButtonContainer" style="margin-top:8px; display:none;">
        <button class="secondary small" onclick="resetCalc()">ğŸ”Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø¨Ø© </button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
  <div id="resultPage" class="page">
    <div class="card fade-in" id="resultCard">
      <!-- ØªØ¹Ø¨Ø¦Ø© Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
    </div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
      <button class="secondary small" onclick="backToLanding()">ğŸ  Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary small" onclick="saveResultAsImage()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø©</button>
        <button class="secondary small" onclick="shareResultOnWhatsApp()">ğŸ“² Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="primary small" onclick="resetCalc(); showPage('calculator');">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© "Ù‚Ø±ÙŠØ¨Ø§Ù‹" Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø© -->
  <div id="comingSoonPage" class="page">
    <div class="card fade-in">
      <h2 id="comingSoonTitle" style="margin-top:0; font-size:19px; color:#111827;">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
      <p id="comingSoonText" style="font-size:14px; color:#6b7280;">
        Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø­ØªØ³Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ø¨Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©.<br>
        Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ ğŸ™
      </p>
      <div style="margin-top:12px;">
        <button class="secondary small" onclick="backToFinanceType()"> ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
  <div id="adminLoginPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
      <p style="font-size:13px; color:#b91c1c; text-align:right;">
        âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…Ø±Ø®Øµ Ù„Ù‡Ù… ÙÙ‚Ø·.<br>
        Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù‚Ø¯ ØªØ¹ØªØ¨Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡.
      </p>
      <label for="adminPin">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      <input id="adminPin" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù" />
      <div style="margin-top:12px;">
        <button class="primary small" onclick="handleAdminLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="secondary small" onclick="backToLanding()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div id="adminLoginError" class="alert-error" style="display:none; margin-top:8px;">
        Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </div>
    </div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Hub) -->
  <div id="adminHubPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ø§Ø®ØªØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
      </p>
      <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:10px;">
        <button class="primary small" onclick="showPage('admin')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨</button>
        <button class="secondary small" onclick="showPage('adminProducts')">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„</button>
        <button class="secondary small" onclick="showPage('adminArchive')">Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
        <button class="secondary small" onclick="backToLanding()">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨) -->
  <div id="adminPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ù…Ù† Ù‡Ù†Ø§ ØªØ¶ÙŠÙ ÙˆØªØ¹Ø¯Ù‘Ù„ Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆÙ†Ø³Ø¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ù„ÙƒÙ„ Ø¨Ù†Ùƒ / Ø´Ø±ÙƒØ© ØªÙ…ÙˆÙŠÙ„ ÙˆÙ†ÙˆØ¹ ØªÙ…ÙˆÙŠÙ„.
        Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³ØªØ®Ø¯Ù… ÙÙŠ Ø®ÙŠØ§Ø± <strong>ØªØ±Ø´ÙŠØ­ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</strong>.
      </p>

      <form id="adminForm" onsubmit="saveBankConfig(event)">
        <div class="admin-grid">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ / Ø´Ø±ÙƒØ© Ø§Ù„ØªÙ…ÙˆÙŠÙ„</label>
            <select id="adminBankName">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</option>
              <option>Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶</option>
              <option>Ø¨Ù†Ùƒ Ø³Ø§Ø¨</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ</option>
              <option>Ù…ØµØ±Ù Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¯ÙˆÙ„ÙŠ</option>
              <option>Ø¨Ù†Ùƒ Ø¯Ø§Ù„ 360 (D360 Bank)</option>
              <option>Ø¨Ù†Ùƒ Ø¥Ø³ ØªÙŠ Ø³ÙŠ (STC Bank)</option>
              <option>Ø¨Ù†Ùƒ ÙÙŠØ¬Ù† (Vision Bank)</option>
              <option>Ø¢ÙŠØ²ÙŠ Ø¨Ù†Ùƒ (EZ Bank)</option>

              <option>Amlak International Company</option>
              <option>Dar Al Tamleek Company</option>
              <option>Saudi Home Loans Company</option>
              <option>Deutsche Gulf Finance</option>
              <option>Abdul Latif Jameel United Real Estate Finance</option>
              <option>Saudi Real Estate Refinance Company</option>
              <option>Bidaya Home Finance</option>
              <option>Nayifat Finance Company</option>
              <option>Yanal Finance Company</option>
              <option>AlYusr Leasing &amp; Financing Company</option>
              <option>Ajil Financial Services Company</option>
              <option>National Finance Company</option>
              <option>Morabaha Marina Finance Company</option>
              <option>Kirnaf Finance Company</option>
              <option>Aljasriah Finance Company</option>
              <option>Matager Finance Company</option>
              <option>Saudi Finance Company</option>
              <option>Abdul Latif Jameel Finance Company</option>
              <option>Gulf Finance Company</option>
              <option>Tamwily International Company</option>
              <option>Alamthal Financing Company</option>
              <option>Osoul Modern Finance Company</option>
              <option>Dar Aletiman Alsaudi Company</option>
              <option>Tawkelat Financing Company</option>
              <option>Ijarah Finance Company</option>
              <option>Tayseer Finance Company</option>
              <option>Saudi Fransi For Finance Leasing Company</option>
              <option>Tamweel Aloula Finance Company</option>
              <option>American Express Saudi Arabia</option>
              <option>Aljabr Finance Company</option>
              <option>Alraedah Finance Company</option>
              <option>Raya Financing Company</option>
              <option>Quara Finance Company</option>
              <option>Taajeer Finance Company</option>
              <option>Gulf Lifting Financial Leasing Company</option>
              <option>Bab Rizq Jameel Microfinance Company</option>
              <option>United Company for Financial Services (Tasheel)</option>
              <option>Emkan Finance Company</option>
              <option>Tamam Finance Company</option>
              <option>National Home Finance Company</option>
              <option>Ø¨Ù†Ùƒ Ø¢Ø®Ø± (  )</option>
            </select>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</label>
            <select id="adminFinanceType">
              <option value="personal">ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ / ØªØ£Ø¬ÙŠØ±ÙŠ</option>
              <option value="consumer">ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ</option>
              <option value="mortgage">ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ</option>
              <option value="buyoutPersonal">Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ</option>
              <option value="buyoutMortgage">Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ</option>
            </select>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø¹Ù… (Ù„Ù„Ø¹Ù‚Ø§Ø±ÙŠ)</label>
            <select id="adminSupportedType">
              <option value="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</option>
              <option value="Ù…Ø¯Ø¹ÙˆÙ…">Ù…Ø¯Ø¹ÙˆÙ…</option>
              <option value="ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…">ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</option>
            </select>
          </div>
          <div>
            <label>Ù…Ù† Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„)</label>
            <input id="adminMinSalary" type="number" min="0" />
          </div>
          <div>
            <label>Ø¥Ù„Ù‰ Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„)</label>
            <input id="adminMaxSalary" type="number" min="0" />
          </div>
          <div>
            <label>Ù†Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ (%)</label>
            <input id="adminMargin" type="number" min="0" step="0.01" />
          </div>

          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="adminJobType">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>Ø¹Ø³ÙƒØ±ÙŠ</option>
              <option>Ù…Ø¯Ù†ÙŠ (Ù‚Ø·Ø§Ø¹ Ø­ÙƒÙˆÙ…ÙŠ)</option>
              <option>Ø®Ø§Øµ (Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ)</option>
              <option>Ø®Ø§Øµ (Ø´Ø±ÙƒØ© Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
              <option>Ø®Ø§Øµ (Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
            </select>
          </div>
          <div>
            <label>Ù…Ù† Ø´Ù‡Ø± (Ø§Ù„Ù…Ø¯Ø©)</label>
            <input id="adminMinMonths" type="number" min="1" />
          </div>
          <div>
            <label>Ø¥Ù„Ù‰ Ø´Ù‡Ø± (Ø§Ù„Ù…Ø¯Ø©)</label>
            <input id="adminMaxMonths" type="number" min="1" />
          </div>
          <div>
            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="adminProductDetail">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>ÙˆØ­Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚</option>
              <option>Ø¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ</option>
              <option>Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®Ø§Ø±Ø·Ø©</option>
              <option>ØªØ­Øª Ø§Ù„Ø§Ù†Ø´Ø§Ø¡ (Ø¨ÙŠØª ØªÙ…Ù„ÙƒÙ‡ Ø¹Ø¸Ù…)</option>
              <option>Ø§Ø±Ø¶ ÙˆÙ‚Ø±Ø¶ (Ø§Ø±Ø¶ ÙˆØ¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ)</option>
              <option>Ø§Ø±Ø¶ (Ø³ÙƒÙ†ÙŠØ©)</option>
              <option>Ø±Ù‡Ù†</option>
            </select>
          </div>
          <div>
            <label>Ø§Ø¹ØªØ²Ø§Ø² (Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…)</label>
            <select id="adminEtezaaz">
              <option value="">Ø¨Ø¯ÙˆÙ†</option>
              <option value="Ù†Ø¹Ù…">Ø§Ø¹ØªØ²Ø§Ø²</option>
            </select>
          </div>
        </div>
        <input type="hidden" id="adminEditIndex" value="" />
        <div style="text-align:left; margin-top:10px;">
          <button type="submit" class="primary small">ğŸ’¾ Ø­ÙØ¸</button>
          <button type="button" class="secondary small" onclick="clearAdminForm()">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        </div>
      </form>

      <table class="admin-table" id="adminTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ø¨Ù†Ùƒ / Ø§Ù„Ø´Ø±ÙƒØ©</th>
            <th>Ø§Ù„ØªÙ…ÙˆÙŠÙ„</th>
            <th>Ø§Ù„Ø¯Ø¹Ù…</th>
            <th>Ù…Ù† Ø±Ø§ØªØ¨</th>
            <th>Ø¥Ù„Ù‰ Ø±Ø§ØªØ¨</th>
            <th>Ø§Ù„Ù…Ø¯Ø© (Ù…Ù†)</th>
            <th>Ø§Ù„Ù…Ø¯Ø© (Ø¥Ù„Ù‰)</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
            <th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ø¹ØªØ²Ø§Ø²</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
            <th>ØªØ­ÙƒÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:8px; font-size:11px; color:#9ca3af; text-align:right;">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ ØªÙØ¬Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ.
        Ø¶Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± ÙÙŠ Ù…Ø¬Ù„Ø¯ <code>img</code> Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.
      </div>

      <div style="margin-top:12px; text-align:left;">
        <button class="secondary small" onclick="showPage('adminHub')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <!-- (Ø¥Ø¶Ø§ÙØ©) Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ -->
  <div id="adminProductsPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ù…Ù† Ù‡Ù†Ø§ ØªØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ "Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„": ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù + Ø±Ø³Ø§Ù„Ø© Ø§Ø¹ØªØ°Ø§Ø± + Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯.
      </p>

      <form id="adminProductsForm" onsubmit="saveFinanceProduct(event)">
        <div class="admin-grid">
          <div style="grid-column:1/-1;">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„)</label>
            <input id="fpName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„" />
          </div>

          <div>
            <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="fpEnabled">
              <option value="true">Ù…ÙØ¹Ù‘Ù„</option>
              <option value="false">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option>
            </select>
          </div>

          <div style="grid-column:1/-1;">
            <label>Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="fpMessage" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹." />
          </div>
        </div>

        <input type="hidden" id="fpEditIndex" value="" />

        <div style="text-align:left; margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button type="submit" class="primary small">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button type="button" class="secondary small" onclick="clearFinanceProductForm()">Ù…Ø³Ø­</button>
        </div>
      </form>

      <table class="admin-table" id="financeProductsTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù</th>
            <th>ØªØ­ÙƒÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px; text-align:left;">
        <button class="secondary small" onclick="showPage('adminHub')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
      </div>
    </div>

    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ØªÙ‚Ø¯ÙŠØ±ÙŠØ©) Ù„Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ù…ØªØ¯</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ù…Ù„Ø§Ø­Ø¸Ø©: "Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯" ÙŠØ­ØªØ§Ø¬ Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ ÙØ¹Ù„ÙŠØŒ ÙˆØ¨Ù…Ø§ Ø£Ù†Ùƒ Ù„Ø§ ØªØ±ÙŠØ¯ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ù‡ØŒ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯ "Ù…Ø¹Ø§Ù…Ù„" ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ Ø¥Ù„Ù‰ (Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø³Ø¨Ø© Ø§Ù„Ù…Ù…ØªØ¯Ø© ÙÙ‚Ø·.
      </p>
      <div class="admin-grid">
        <div>
          <label>Ù…Ø¹Ø§Ù…Ù„ ØªÙ‚Ø¯ÙŠØ±ÙŠ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ = Ø§Ù„ØµØ§ÙÙŠ Ã— Ø§Ù„Ù…Ø¹Ø§Ù…Ù„)</label>
          <input id="retBasicMultiplier" type="number" step="0.01" min="0" />
        </div>
        <div style="display:flex; align-items:flex-end; justify-content:flex-end; gap:8px;">
          <button class="primary small" onclick="saveRetirementSettings()">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="secondary small" onclick="loadRetirementSettingsToUI()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
        </div>
      </div>
      <div style="margin-top:8px; font-size:12px; color:#6b7280; text-align:right;">
        Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ = 1.00 (ÙŠØ¹Ù†ÙŠ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµØ§ÙÙŠ ÙƒØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø£Ø³Ø§Ø³ÙŠ) â€” ÙˆØªÙ‚Ø¯Ø± ØªØºÙŠØ±Ù‡ Ø­Ø³Ø¨ Ø®Ø¨Ø±ØªÙƒ.
      </div>
    </div>
  </div>

  <!-- Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <div id="adminArchivePage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ. ÙŠØ¸Ù‡Ø± "Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©" + "Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„" Ø¥Ù† ÙˆÙØ¬Ø¯Øª.
      </p>

      <div class="admin-grid">
        <div style="grid-column:1/-1;">
          <label>Ø¨Ø­Ø« (Ø¬ÙˆØ§Ù„ / Ø³Ø¬Ù„ Ù…Ø¯Ù†ÙŠ)</label>
          <input id="archiveSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ..." oninput="renderArchiveTable()" />
        </div>
      </div>

      <table class="admin-table" id="archiveTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…ÙØªØ§Ø­ (Ø¬ÙˆØ§Ù„/Ø³Ø¬Ù„)</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</th>
            <th>ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±Ø´Ø­</th>
            <th>ØªØ­ÙƒÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px; text-align:left;">
        <button class="secondary small" onclick="showPage('adminHub')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
      </div>
    </div>
  </div>

</div>

<footer>
  <div class="footer-inner">
    <div>
      Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© -  Ø³Ø±Ø¹Ø© ØªÙ…Ù„Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ© -
      <span id="datetime"></span>
      <span class="hijri-chip">Ù‡Ø¬Ø±ÙŠ: <span id="datetimeHijri"></span></span>
    </div>

    <!-- â–«ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ØªØ­Øª Ø§Ù„ÙÙˆØªØ± -->
    <div id="miniAdminTools" title="Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ù…Ø®ÙÙŠØ©) â€” â–«ï¸" onclick="openMiniAdminTools()">
      â–«ï¸
      <span style="font-size:11px; color:#6b7280;">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (â–«ï¸) -->
<div id="miniAdminAuthModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">
  <div style="max-width:700px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900; color:#111827;">â–«ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
      <button class="secondary small" onclick="closeMiniAdminAuth()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="alert-error" style="margin-top:10px;">
      âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·. Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡ Ù‚Ø¯ ÙŠØ¹Ø±Ù‘Ø¶Ùƒ Ù„Ù„Ù…Ø³Ø§Ø¡Ù„Ø©.
    </div>

    <label>Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
    <input id="miniAdminPin" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" />

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="primary small" onclick="verifyMiniAdminPin()">ØªØ£ÙƒÙŠØ¯</button>
      <button class="secondary small" onclick="closeMiniAdminAuth()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="miniAdminPinError" class="alert-error" style="display:none; margin-top:8px;">
      Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ -->
<div id="miniAdminActionsModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">
  <div style="max-width:820px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900; color:#111827;">â–«ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
      <button class="secondary small" onclick="closeMiniAdminActions()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <p style="font-size:13px; color:#6b7280; margin:10px 0 0;">
      Ø§Ø®ØªØ±:
    </p>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
      <button class="primary small" onclick="openClientResultModal(true)">Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
      <button class="secondary small" onclick="openArchiveSaveModal()">Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
      <button class="secondary small" onclick="openAdminLoginFromMiniTools()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</button>
    </div>

    <div style="margin-top:10px; font-size:12px; color:#6b7280;">
      * â€œÙ†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„â€ = Ù†ÙØ³ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø®ØªØµØ±Ø© + Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª + Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„. ÙˆÙŠÙ…ÙƒÙ† Ø­ÙØ¸Ù‡Ø§ ÙƒØµÙˆØ±Ø©.
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø­ÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
<div id="archiveSaveModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">
  <div style="max-width:820px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900; color:#111827;">ğŸ—‚ï¸ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
      <button class="secondary small" onclick="closeArchiveSaveModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="alert-error" style="margin-top:10px;">
      âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² (LocalStorage) â€” Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
    </div>

    <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
    <input id="archiveKeyInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 05xxxxxxxx Ø£Ùˆ 1xxxxxxxxx" />

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
      <button class="primary small" onclick="saveCurrentResultToArchive()">Ø­ÙØ¸</button>
      <button class="secondary small" onclick="closeArchiveSaveModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="archiveSaveMsg" style="display:none; margin-top:10px; font-size:13px; color:#0f766e; font-weight:900;"></div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø¨Ø¹Ø¯ ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„) -->
<div id="clientResultModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">
  <div style="max-width:900px; margin:40px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900; color:#111827;">ğŸ“„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø®ØªØµØ±Ø©)</div>
      <button class="secondary small" onclick="closeClientResultModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div style="margin-top:10px; font-size:13px; color:#6b7280;">
      * Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© â€” Ø¥Ø°Ø§ ØªØ±ÙƒØªÙ‡Ø§ ÙØ§Ø¶ÙŠØ© Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ â€œØ§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©â€ Ù…Ù† Ø§Ù„Ø­Ø§Ø³Ø¨Ø©.
    </div>

    <div class="admin-grid" style="margin-top:10px;">
      <div>
        <label>Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="clientNetOverride" type="number" min="0" placeholder="Ù…Ø«Ø§Ù„: 450000">
      </div>
      <div>
        <label>Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="clientInstOverride" type="number" min="0" placeholder="Ù…Ø«Ø§Ù„: 3200">
      </div>
      <div style="grid-column:1/-1;">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</label>
        <input id="clientNoteOverride" type="text" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="primary small" onclick="generateClientResultText()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø®ØªØµØ±Ø©</button>
      <button class="secondary small" onclick="copyClientResultText()">ğŸ“‹ Ù†Ø³Ø®</button>
      <button class="secondary small" onclick="shareClientResultOnWhatsApp()">ğŸ“² Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button class="secondary small" onclick="saveClientResultAsImage()">ğŸ–¼ï¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
    </div>

    <div style="margin-top:10px;">
      <label>Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</label>
      <textarea id="clientResultText" style="width:100%; min-height:180px; padding:10px; font-size:14px; border-radius:12px; border:1px solid #e5e7eb; background:#f9fafb; direction:rtl;"></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Ù…Ø¹Ø§ÙŠÙ†Ø© (Ù„Ù„ØµÙˆØ±Ø©)</label>
      <div id="clientPreviewCard" class="client-preview">
        <div class="h">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø¨Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)</div>
        <div style="color:#6b7280; font-size:12px;">Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø®ØªØµØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§.</div>
      </div>
    </div>
  </div>
</div>

<script>
  function showPage(name) {
    ['landing','calculator','result','adminLogin','adminHub','admin','adminProducts','adminArchive','comingSoon'].forEach(id => {
      const el = document.getElementById(id + 'Page');
      if (!el) return;
      el.classList.toggle('active', id === name);
    });
  }

  function backToLanding() { showPage('landing'); }

  function startClientFlow() {
    showPage('calculator');
    resetCalc();
  }

  function backToFinanceType(){
    showPage('calculator');
    hasStarted = true;
    const idx = generalQuestions.findIndex(q => q.id === 'financeType');
    step = idx >= 0 ? idx : 0;
    commitmentStep = 0;
    currentCommitment = {};
    document.getElementById('mainButton').style.display = 'none';
    document.getElementById('resetButtonContainer').style.display = 'block';
    document.getElementById('nextButton').style.display = 'inline-flex';
    showQuestion();
  }

  const bankLogoMap = {
    'Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ': 'img/alrajhi.png',
    'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ': 'img/alahli.png',
    'Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶': 'img/riyad.png',
    'Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯': 'img/bilad.png',
    'Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©': 'img/jazira.png',
    'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ': 'img/bsf.png',
    'Ø¨Ù†Ùƒ Ø³Ø§Ø¨': 'img/sab.png',
    'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ': 'img/anb.png',
    'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±': 'img/saib.png'
  };

  let bankConfigs = [];
  const defaultBankConfigs = [
    { bankName: 'Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', bankType:'Ø¨Ù†Ùƒ', financeType: 'personal', supportedType: 'Ø§Ù„ÙƒÙ„', minSalary: 4000, maxSalary: 8000, margin: 5.5 },
    { bankName: 'Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', bankType:'Ø¨Ù†Ùƒ', financeType: 'personal', supportedType: 'Ø§Ù„ÙƒÙ„', minSalary: 8001, maxSalary: 20000, margin: 4.9 },
    { bankName: 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ', bankType:'Ø¨Ù†Ùƒ', financeType: 'mortgage', supportedType: 'Ù…Ø¯Ø¹ÙˆÙ…', minSalary: 4000, maxSalary: 15000, margin: 4.3 },
    { bankName: 'Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶', bankType:'Ø¨Ù†Ùƒ', financeType: 'mortgage', supportedType: 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', minSalary: 6000, maxSalary: 20000, margin: 4.8 }
  ];

  function loadBankConfigs() {
    try {
      const saved = localStorage.getItem('stBankConfigs');
      if (saved) {
        bankConfigs = JSON.parse(saved);
      } else {
        bankConfigs = defaultBankConfigs;
        saveBankConfigs();
      }
    } catch (e) {
      bankConfigs = defaultBankConfigs;
    }
    renderBankTable();
  }
  function saveBankConfigs() {
    localStorage.setItem('stBankConfigs', JSON.stringify(bankConfigs));
  }

  function renderBankTable() {
    const tbody = document.querySelector('#adminTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    bankConfigs.forEach((cfg, index) => {
      let financeLabel =
        cfg.financeType === 'personal' ? 'Ø´Ø®ØµÙŠ/ØªØ£Ø¬ÙŠØ±ÙŠ' :
        cfg.financeType === 'consumer' ? 'Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ' :
        cfg.financeType === 'mortgage' ? 'Ø¹Ù‚Ø§Ø±ÙŠ' :
        cfg.financeType === 'buyoutPersonal' ? 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø´Ø®ØµÙŠ' :
        cfg.financeType === 'buyoutMortgage' ? 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¹Ù‚Ø§Ø±ÙŠ' :
        cfg.financeType;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${cfg.bankName || ''}</td>
        <td>${financeLabel}</td>
        <td>${cfg.supportedType || ''}</td>
        <td>${(cfg.minSalary || 0).toLocaleString()}</td>
        <td>${(cfg.maxSalary || 0).toLocaleString()}</td>
        <td>${cfg.minMonths || ''}</td>
        <td>${cfg.maxMonths || ''}</td>
        <td>${cfg.jobType || ''}</td>
        <td>${cfg.productDetail || ''}</td>
        <td>${cfg.etezaaz || ''}</td>
        <td>${cfg.margin}</td>
        <td>
          <button class="btn small secondary" onclick="editBankConfig(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small secondary" onclick="deleteBankConfig(${index})">Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function clearAdminForm() {
    document.getElementById('adminBankName').value = '';
    document.getElementById('adminFinanceType').value = 'personal';
    document.getElementById('adminSupportedType').value = 'Ø§Ù„ÙƒÙ„';
    document.getElementById('adminMinSalary').value = '';
    document.getElementById('adminMaxSalary').value = '';
    document.getElementById('adminMargin').value = '';
    document.getElementById('adminJobType').value = '';
    document.getElementById('adminMinMonths').value = '';
    document.getElementById('adminMaxMonths').value = '';
    document.getElementById('adminProductDetail').value = '';
    document.getElementById('adminEtezaaz').value = '';
    document.getElementById('adminEditIndex').value = '';
  }

  function saveBankConfig(e) {
    e.preventDefault();
    const bankName = document.getElementById('adminBankName').value;
    const financeType = document.getElementById('adminFinanceType').value;
    const supportedType = document.getElementById('adminSupportedType').value;
    const minSalary = parseFloat(document.getElementById('adminMinSalary').value || '0');
    const maxSalary = parseFloat(document.getElementById('adminMaxSalary').value || '0');
    const margin = parseFloat(document.getElementById('adminMargin').value || '0');
    const jobType = document.getElementById('adminJobType').value;
    const minMonths = parseInt(document.getElementById('adminMinMonths').value || '0');
    const maxMonths = parseInt(document.getElementById('adminMaxMonths').value || '0');
    const productDetail = document.getElementById('adminProductDetail').value;
    const etezaaz = document.getElementById('adminEtezaaz').value;
    const editIndex = document.getElementById('adminEditIndex').value;

    if (!bankName || !margin || !minSalary || !maxSalary) {
      alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.');
      return;
    }
    const cfg = { bankName, financeType, supportedType, minSalary, maxSalary, margin };

    if (jobType) cfg.jobType = jobType;
    if (minMonths) cfg.minMonths = minMonths;
    if (maxMonths) cfg.maxMonths = maxMonths;
    if (productDetail) cfg.productDetail = productDetail;
    if (etezaaz) cfg.etezaaz = etezaaz;

    if (editIndex === '') bankConfigs.push(cfg);
    else bankConfigs[parseInt(editIndex)] = cfg;

    saveBankConfigs();
    renderBankTable();
    clearAdminForm();
  }

  function editBankConfig(index) {
    const cfg = bankConfigs[index];
    document.getElementById('adminBankName').value = cfg.bankName || '';
    document.getElementById('adminFinanceType').value = cfg.financeType || 'personal';
    document.getElementById('adminSupportedType').value = cfg.supportedType || 'Ø§Ù„ÙƒÙ„';
    document.getElementById('adminMinSalary').value = cfg.minSalary || '';
    document.getElementById('adminMaxSalary').value = cfg.maxSalary || '';
    document.getElementById('adminMargin').value = cfg.margin || '';
    document.getElementById('adminJobType').value = cfg.jobType || '';
    document.getElementById('adminMinMonths').value = cfg.minMonths || '';
    document.getElementById('adminMaxMonths').value = cfg.maxMonths || '';
    document.getElementById('adminProductDetail').value = cfg.productDetail || '';
    document.getElementById('adminEtezaaz').value = cfg.etezaaz || '';
    document.getElementById('adminEditIndex').value = index;
  }

  function deleteBankConfig(index) {
    if (!confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ')) return;
    bankConfigs.splice(index, 1);
    saveBankConfigs();
    renderBankTable();
  }

  function getMatchingBanksForAnswers() {
    const salary = parseFloat(answers.salary || '0');
    if (!salary) return [];

    let fType;
    if (answers.financeType === 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ') fType = 'buyoutPersonal';
    else if (answers.financeType === 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ') fType = 'buyoutMortgage';
    else if (answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ') fType = 'consumer';
    else if (answers.financeType && (answers.financeType.includes('Ø´Ø®ØµÙŠ') || answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ')) fType = 'personal';
    else if (answers.financeType && answers.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ')) fType = 'mortgage';
    else fType = 'personal';

    const supp = answers.supported || 'Ø§Ù„ÙƒÙ„';
    const jobType = answers.jobType || '';
    const months = parseInt(answers.months || '0');
    const mortgageDetail = answers.mortgageProductType || '';
    const wantsEtezaaz = (answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && answers.supported === 'Ù…Ø¯Ø¹ÙˆÙ…' && answers.isEtezaaz === 'Ù†Ø¹Ù…');

    const list = bankConfigs.filter(cfg => {
      if (cfg.financeType !== fType) return false;
      if (!(salary >= cfg.minSalary && salary <= cfg.maxSalary)) return false;
      if (!(cfg.supportedType === 'Ø§Ù„ÙƒÙ„' || cfg.supportedType === supp)) return false;

      if (cfg.jobType && jobType && cfg.jobType !== jobType) return false;
      if (cfg.minMonths && months && months < cfg.minMonths) return false;
      if (cfg.maxMonths && months && months > cfg.maxMonths) return false;
      if (cfg.productDetail && mortgageDetail && cfg.productDetail !== mortgageDetail) return false;
      if (wantsEtezaaz && cfg.etezaaz && cfg.etezaaz !== 'Ù†Ø¹Ù…') return false;

      return true;
    });

    list.sort((a,b)=> a.margin - b.margin);
    return list;
  }

  const ADMIN_PIN = '11qq11qQ@';

  function handleAdminLogin() {
    const pin = document.getElementById('adminPin').value;
    const err = document.getElementById('adminLoginError');
    if (pin === ADMIN_PIN) {
      err.style.display = 'none';
      showPage('adminHub');
      renderArchiveTable();
      renderFinanceProductsTable();
      loadRetirementSettingsToUI();
    } else {
      err.style.display = 'block';
    }
  }

  // ====== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (â–«ï¸) ======
  let _miniAdminVerified = false;
  function openMiniAdminTools(){
    document.getElementById('miniAdminPin').value = '';
    document.getElementById('miniAdminPinError').style.display = 'none';
    document.getElementById('miniAdminAuthModal').style.display = 'block';
  }
  function closeMiniAdminAuth(){
    document.getElementById('miniAdminAuthModal').style.display = 'none';
  }
  function verifyMiniAdminPin(){
    const pin = document.getElementById('miniAdminPin').value;
    if(pin === ADMIN_PIN){
      _miniAdminVerified = true;
      document.getElementById('miniAdminPinError').style.display = 'none';
      document.getElementById('miniAdminAuthModal').style.display = 'none';
      document.getElementById('miniAdminActionsModal').style.display = 'block';
    } else {
      document.getElementById('miniAdminPinError').style.display = 'block';
    }
  }
  function closeMiniAdminActions(){
    document.getElementById('miniAdminActionsModal').style.display = 'none';
  }

  function openAdminLoginFromMiniTools(){
    closeMiniAdminActions();
    showPage('adminLogin');
  }

  function openArchiveSaveModal(){
    closeMiniAdminActions();
    const lc = answers._lastCalc;
    if(!lc){
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø­Ø³Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø­ÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ.');
      return;
    }
    document.getElementById('archiveKeyInput').value = '';
    document.getElementById('archiveSaveMsg').style.display = 'none';
    document.getElementById('archiveSaveModal').style.display = 'block';
  }
  function closeArchiveSaveModal(){
    document.getElementById('archiveSaveModal').style.display = 'none';
  }

  // ====== (Ø¥Ø¶Ø§ÙØ©) Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ======
  const FIN_PRODUCTS_KEY = 'stFinanceProducts';
  let financeProducts = [];

  function getDefaultFinanceProducts(){
    return [
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ', enabled:true, message:'' },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ', enabled:true, message:'' },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ', enabled:true, message:'' },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', enabled:true, message:'' },
      { name:'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ', enabled:true, message:'' },
      { name:'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', enabled:false, message:'Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø­ØªØ³Ø§Ø¨ Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø¹Ø¨Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©.' },
      { name:'Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù†', enabled:false, message:'Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©.' },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹', enabled:false, message:'Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©.' },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª', enabled:false, message:'Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©.' },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„', enabled:false, message:'Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©.' }
    ];
  }

  function loadFinanceProducts(){
    try{
      const s = localStorage.getItem(FIN_PRODUCTS_KEY);
      if(s){
        const arr = JSON.parse(s);
        financeProducts = Array.isArray(arr) ? arr : getDefaultFinanceProducts();
      } else {
        financeProducts = getDefaultFinanceProducts();
        saveFinanceProducts();
      }
    }catch(e){
      financeProducts = getDefaultFinanceProducts();
    }
  }

  function saveFinanceProducts(){
    localStorage.setItem(FIN_PRODUCTS_KEY, JSON.stringify(financeProducts || []));
  }

  function getFinanceProductNames(){
    const list = (financeProducts && financeProducts.length) ? financeProducts : getDefaultFinanceProducts();
    return list.map(x=>x.name);
  }

  function findFinanceProduct(name){
    const list = (financeProducts && financeProducts.length) ? financeProducts : getDefaultFinanceProducts();
    return list.find(x=>x.name===name) || null;
  }

  function isFinanceProductEnabled(name){
    const p = findFinanceProduct(name);
    if(!p) return true;
    return !!p.enabled;
  }

  function getFinanceProductMessage(name){
    const p = findFinanceProduct(name);
    return (p && p.message) ? String(p.message) : '';
  }

  function clearFinanceProductForm(){
    document.getElementById('fpName').value = '';
    document.getElementById('fpEnabled').value = 'true';
    document.getElementById('fpMessage').value = '';
    document.getElementById('fpEditIndex').value = '';
  }

  function saveFinanceProduct(e){
    e.preventDefault();
    const name = (document.getElementById('fpName').value || '').trim();
    const enabled = (document.getElementById('fpEnabled').value === 'true');
    const message = (document.getElementById('fpMessage').value || '').trim();
    const editIndex = document.getElementById('fpEditIndex').value;

    if(!name){
      alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.');
      return;
    }

    const item = { name, enabled, message };

    if(editIndex === ''){
      const exists = financeProducts.some(x=>x.name===name);
      if(exists){
        alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ø¹Ø¯Ù‘Ù„Ù‡ Ø¨Ø¯Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.');
        return;
      }
      financeProducts.push(item);
    } else {
      financeProducts[parseInt(editIndex)] = item;
    }

    saveFinanceProducts();
    renderFinanceProductsTable();
    clearFinanceProductForm();
  }

  function renderFinanceProductsTable(){
    const tbody = document.querySelector('#financeProductsTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    (financeProducts || []).forEach((p, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(p.name || '')}</td>
        <td>${p.enabled ? 'Ù…ÙØ¹Ù‘Ù„' : 'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'}</td>
        <td style="text-align:right;">${escapeHtml(p.message || '')}</td>
        <td>
          <button class="btn small secondary" onclick="editFinanceProduct(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small secondary" onclick="deleteFinanceProduct(${idx})">Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function editFinanceProduct(idx){
    const p = financeProducts[idx];
    if(!p) return;
    document.getElementById('fpName').value = p.name || '';
    document.getElementById('fpEnabled').value = p.enabled ? 'true' : 'false';
    document.getElementById('fpMessage').value = p.message || '';
    document.getElementById('fpEditIndex').value = idx;
  }

  function deleteFinanceProduct(idx){
    if(!confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
    financeProducts.splice(idx, 1);
    saveFinanceProducts();
    renderFinanceProductsTable();
  }

  // ====== (Ø¥Ø¶Ø§ÙØ©) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù…Ø¹Ø§Ù…Ù„) ======
  const RET_SETTINGS_KEY = 'stRetirementSettings';
  let retirementSettings = { basicMultiplier: 1.00 };

  function loadRetirementSettings(){
    try{
      const s = localStorage.getItem(RET_SETTINGS_KEY);
      if(s){
        const obj = JSON.parse(s);
        if(obj && typeof obj.basicMultiplier === 'number'){
          retirementSettings = obj;
        } else {
          retirementSettings = { basicMultiplier: 1.00 };
        }
      } else {
        retirementSettings = { basicMultiplier: 1.00 };
        localStorage.setItem(RET_SETTINGS_KEY, JSON.stringify(retirementSettings));
      }
    }catch(e){
      retirementSettings = { basicMultiplier: 1.00 };
    }
  }

  function loadRetirementSettingsToUI(){
    const el = document.getElementById('retBasicMultiplier');
    if(!el) return;
    el.value = (retirementSettings.basicMultiplier ?? 1.00).toFixed(2);
  }

  function saveRetirementSettings(){
    const el = document.getElementById('retBasicMultiplier');
    if(!el) return;
    const v = parseFloat(el.value || '1');
    if(!isFinite(v) || v <= 0){
      alert('Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
      return;
    }
    retirementSettings.basicMultiplier = v;
    localStorage.setItem(RET_SETTINGS_KEY, JSON.stringify(retirementSettings));
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ âœ…');
  }

  // ====== Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (LocalStorage) ======
  function loadArchive(){
    try{
      const s = localStorage.getItem('stClientArchive');
      if(!s) return [];
      const a = JSON.parse(s);
      return Array.isArray(a) ? a : [];
    }catch(e){ return []; }
  }
  function saveArchive(list){
    localStorage.setItem('stClientArchive', JSON.stringify(list || []));
  }

  function saveCurrentResultToArchive(){
    const key = (document.getElementById('archiveKeyInput').value || '').trim();
    if(!key){
      alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ.');
      return;
    }
    const lc = answers._lastCalc;
    if(!lc){
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø­ÙØ¸.');
      return;
    }

    const clientText = (document.getElementById('clientResultText') && document.getElementById('clientResultText').value.trim())
      ? document.getElementById('clientResultText').value.trim()
      : (lc._lastClientText || '');

    const rec = {
      id: Date.now(),
      key: key,
      clientName: lc.clientName || '',
      financeType: lc.financeType || '',
      calcDateTimeStr: lc.calcDateTimeStr || '',
      recommendedBankName: lc.recommendedBankName || '',
      real: lc,
      clientText: clientText || '',
    };

    const list = loadArchive();
    list.unshift(rec);
    saveArchive(list);

    document.getElementById('archiveSaveMsg').style.display = 'block';
    document.getElementById('archiveSaveMsg').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ âœ…';
    renderArchiveTable();
  }

  function renderArchiveTable(){
    const table = document.querySelector('#archiveTable tbody');
    if(!table) return;
    table.innerHTML = '';
    const q = (document.getElementById('archiveSearch')?.value || '').trim();
    const list = loadArchive().filter(r=>{
      if(!q) return true;
      return (String(r.key||'').includes(q));
    });

    list.forEach((r, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.key || '')}</td>
        <td>${escapeHtml(r.clientName || '')}</td>
        <td>${escapeHtml(r.financeType || '')}</td>
        <td>${escapeHtml(r.calcDateTimeStr || '')}</td>
        <td>${escapeHtml(r.recommendedBankName || '')}</td>
        <td>
          <button class="btn small secondary" onclick="viewArchiveRecord(${idx})">Ø¹Ø±Ø¶</button>
          <button class="btn small secondary" onclick="deleteArchiveRecord(${idx})">Ø­Ø°Ù</button>
        </td>
      `;
      table.appendChild(tr);
    });
  }

  function deleteArchiveRecord(indexFiltered){
    const q = (document.getElementById('archiveSearch')?.value || '').trim();
    const all = loadArchive();
    const filtered = all.filter(r=> !q || String(r.key||'').includes(q));
    const rec = filtered[indexFiltered];
    if(!rec) return;
    if(!confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ')) return;
    const newAll = all.filter(x => x.id !== rec.id);
    saveArchive(newAll);
    renderArchiveTable();
  }

  function viewArchiveRecord(indexFiltered){
    const q = (document.getElementById('archiveSearch')?.value || '').trim();
    const all = loadArchive();
    const filtered = all.filter(r=> !q || String(r.key||'').includes(q));
    const rec = filtered[indexFiltered];
    if(!rec) return;

    const lc = rec.real;
    answers._lastCalc = lc;

    openClientResultModal(true);

    setTimeout(()=>{
      if(rec.clientText){
        document.getElementById('clientResultText').value = rec.clientText;
        _clientResultTextCache = rec.clientText;
        renderClientPreviewFromText(rec.clientText);
      } else {
        generateClientResultText();
      }
    }, 200);
  }

  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // ====== (Ø¥Ø¶Ø§ÙØ©) Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰) ======
  function getHijriNowParts(){
    try{
      const fmt = new Intl.DateTimeFormat('en-US-u-ca-islamic-umalqura', {year:'numeric', month:'numeric', day:'numeric'});
      const parts = fmt.formatToParts(new Date());
      const y = parseInt(parts.find(p=>p.type==='year')?.value || '0', 10);
      const m = parseInt(parts.find(p=>p.type==='month')?.value || '0', 10);
      const d = parseInt(parts.find(p=>p.type==='day')?.value || '0', 10);
      return {y, m, d};
    }catch(e){
      return {y:1446, m:1, d:1};
    }
  }

  function getHijriNowDisplay(){
    try{
      const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {year:'numeric', month:'2-digit', day:'2-digit'});
      return fmt.format(new Date());
    }catch(e){
      return '';
    }
  }

  function monthsDiffHijri(fromY,fromM,fromD,toY,toM,toD){
    let months = (toY*12 + toM) - (fromY*12 + fromM);
    if(toD < fromD) months -= 1;
    return Math.max(0, months);
  }

  // ====== Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ======
  let answers = { commitments: [] }, step = 0, commitmentStep = 0, currentCommitment = {};
  let hasStarted = false;

  const generalQuestions = [
    { id:'clientName',label:'ØªØ¹Ø±ÙÙ†Ø§ Ø¨Ø£Ø³Ù…Ùƒ  ',type:'text' },
    { id:'birthDay',label:'Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù‡Ø¬Ø±ÙŠ:',type:'select',options:Array.from({length:30},(_,i)=>i+1),default:1 },
    { id:'birthMonth',label:'Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù‡Ø¬Ø±ÙŠ:',type:'select',options:Array.from({length:12},(_,i)=>i+1),default:1 },
    { id:'birthYear',label:'Ø§Ø®ØªØ± Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù‡Ø¬Ø±ÙŠ:',type:'select',options:Array.from({length:61},(_,i)=>1430 - i),default:1412 },
    { id:'jobType',label:'Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©',type:'select',options:['Ø¹Ø³ÙƒØ±ÙŠ','Ù…Ø¯Ù†ÙŠ (Ù‚Ø·Ø§Ø¹ Ø­ÙƒÙˆÙ…ÙŠ)','Ø®Ø§Øµ (Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ)','Ø®Ø§Øµ (Ø´Ø±ÙƒØ© Ù…Ø¹ØªÙ…Ø¯Ø©)','Ø®Ø§Øµ (Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)'] },
    {
      id:'militaryRank',
      label:'Ø§Ø°ÙƒØ± Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©',
      type:'select',
      options:[
        'Ø¬Ù†Ø¯ÙŠ','Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„','Ø¹Ø±ÙŠÙ','ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨','Ø±Ù‚ÙŠØ¨','Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„',
        'Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡','Ù…Ù„Ø§Ø²Ù…','Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„','Ù†Ù‚ÙŠØ¨','Ø±Ø§Ø¦Ø¯','Ù…Ù‚Ø¯Ù…','Ø¹Ù‚ÙŠØ¯','Ø¹Ù…ÙŠØ¯','Ù„ÙˆØ§Ø¡'
      ],
      show:a=>a.jobType==='Ø¹Ø³ÙƒØ±ÙŠ'
    },
    {
      id:'financeType',
      label:'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ØªØ±ÙŠØ¯ Ø­Ø³Ø¨ØªÙ‡:',
      type:'select',
      options:[
        'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ',
        'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ',
        'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ',
        'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ',
        'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ',
        'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ',
        'Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù†',
        'ØªÙ…ÙˆÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹',
        'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª',
        'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„'
      ]
    },
    {
      id:'mortgageProductType',
      label:'Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ',
      type:'select',
      options:[
        'ÙˆØ­Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚',
        'Ø¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ',
        'Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®Ø§Ø±Ø·Ø©',
        'ØªØ­Øª Ø§Ù„Ø§Ù†Ø´Ø§Ø¡ (Ø¨ÙŠØª ØªÙ…Ù„ÙƒÙ‡ Ø¹Ø¸Ù…)',
        'Ø§Ø±Ø¶ ÙˆÙ‚Ø±Ø¶ (Ø§Ø±Ø¶ ÙˆØ¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ)',
        'Ø§Ø±Ø¶ (Ø³ÙƒÙ†ÙŠØ©)',
        'Ø±Ù‡Ù†'
      ],
      show:a=>a.financeType==='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ'
    },
    { id:'supported',label:'Ù‡Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ø¯Ø¹ÙˆÙ…ØŸ',type:'select',options:['Ù…Ø¯Ø¹ÙˆÙ…','ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'],
      show:a=>a.financeType==='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && ['ÙˆØ­Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚','Ø¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ','Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®Ø§Ø±Ø·Ø©','ØªØ­Øª Ø§Ù„Ø§Ù†Ø´Ø§Ø¡ (Ø¨ÙŠØª ØªÙ…Ù„ÙƒÙ‡ Ø¹Ø¸Ù…)','Ø§Ø±Ø¶ ÙˆÙ‚Ø±Ø¶ (Ø§Ø±Ø¶ ÙˆØ¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ)'].includes(a.mortgageProductType)
    },
    {
      id:'isEtezaaz',
      label:'Ù‡Ù„ Ø£Ù†Øª Ù…Ù† Ù…Ù†Ø³ÙˆØ¨ÙŠ ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯ÙØ§Ø¹ (Ù…Ø¤Ù‡Ù„ Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ø¹ØªØ²Ø§Ø²)ØŸ',
      type:'select',
      options:['Ù†Ø¹Ù…','Ù„Ø§'],
      show:a=>a.financeType==='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && a.supported==='Ù…Ø¯Ø¹ÙˆÙ…' && a.jobType==='Ø¹Ø³ÙƒØ±ÙŠ'
    },
    { id:'bundle',label:'Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø³ÙƒÙ†ÙŠØŸ',type:'select',options:['Ù†Ø¹Ù…','Ù„Ø§'],show:a=>a.supported==='Ù…Ø¯Ø¹ÙˆÙ…' },
    { id:'salary',label:'ÙƒÙ… Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØµØ§ÙÙŠØŸ',type:'number' },

    {
      id:'includeSupportInSalary',
      label:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ (Ù„Ù„Ø§Ø­ØªØ³Ø§Ø¨)ØŸ',
      type:'select',
      options:['Ù†Ø¹Ù…','Ù„Ø§'],
      show:a=>{
        const sal = parseFloat(a.salary || '0');
        return (a.financeType==='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && a.supported==='Ù…Ø¯Ø¹ÙˆÙ…' && a.bundle==='Ù„Ø§' && sal > 0 && sal < 15000);
      }
    },

    {
      id:'extendAfterRetirement',
      label:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù…ØªØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø­ØªÙ‰ Ø¹Ù…Ø± 60 Ø³Ù†Ø©ØŸ',
      type:'select',
      options:['Ù†Ø¹Ù…','Ù„Ø§'],
      show:a=>{
        if(a.jobType!=='Ø¹Ø³ÙƒØ±ÙŠ') return false;
        if(!a.militaryRank) return false;
        const ft = a.financeType || '';
        const allowed = (ft==='ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' || ft==='ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ' || ft==='ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ' || ft==='Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ');
        if(!allowed) return false;

        const info = getMilitaryTimingInfoFromAnswers(a);
        return (info.rankRemainingMonths > 0 && info.rankRemainingMonths <= (25*12) && info.monthsTo60 > info.rankRemainingMonths);
      }
    },
    { id:'appointDay',label:'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ) - Ø§Ù„ÙŠÙˆÙ…',type:'select',options:Array.from({length:30},(_,i)=>i+1),default:1, show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
    { id:'appointMonth',label:'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ) - Ø§Ù„Ø´Ù‡Ø±',type:'select',options:Array.from({length:12},(_,i)=>i+1),default:1, show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },
    { id:'appointYear',label:'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ) - Ø§Ù„Ø³Ù†Ø©',type:'select',options:[],dynamic:true, show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' },

    { id:'months',label:'Ø¹Ù„Ù‰ ÙƒÙ… Ø´Ù‡Ø± ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ØŸ',type:'select',options:[],dynamic:true },
    { id:'calcMode',label:'ÙƒÙŠÙ ØªÙØ¶Ù‘Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø³Ø¨Ø©ØŸ',type:'select',options:['Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨Ù†ÙØ³ÙŠ','ØªØ±Ø´ÙŠØ­ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'] },
    { id:'profitMargin',label:'Ù†Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ (%)ØŸ',type:'number' },
    {
      id:'buyoutAmount',
      label:'ÙƒÙ… Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨ÙƒØ± Ù„Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)ØŸ',
      type:'number',
      show:a=>a.financeType==='Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ'
    },
    { id:'hasCommitments',label:'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŸ',type:'select',options:['Ù†Ø¹Ù…','Ù„Ø§'] }
  ];

  const commitmentQuestions = [
    { id:'type',label:'Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',type:'select',options:['Ù‚Ø±Ø¶ Ø´Ø®ØµÙŠ','Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©','Ù‚Ø±Ø¶ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ','Ù‚Ø±Ø¶ Ø¹Ù‚Ø§Ø±ÙŠ'] },
    { id:'amount',label:'ÙƒÙ… Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØŸ',type:'number' },
    { id:'months',label:'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©ØŸ',type:'select',options:[],dynamic:true },
    { id:'balloon',label:'Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø¯ÙØ¹Ø© Ø£Ø®ÙŠØ±Ø© (Ù„Ù‚Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø©)ØŸ',type:'select',options:['Ù†Ø¹Ù…','Ù„Ø§'],show:c=>c.type==='Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©' },
    { id:'balloonAmount',label:'ÙƒÙ… Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©ØŸ',type:'number',show:c=>c.balloon==='Ù†Ø¹Ù…' },
    { id:'more',label:'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø£Ø®Ø±Ù‰ØŸ',type:'select',options:['Ù†Ø¹Ù…','Ù„Ø§'] }
  ];

  function getRetirementAge(rank) {
    const retirementAges = {
      'Ø¬Ù†Ø¯ÙŠ': 44,'Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„': 44,'Ø¹Ø±ÙŠÙ': 46,'ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨': 48,'Ø±Ù‚ÙŠØ¨': 50,'Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„': 50,
      'Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡': 52,'Ù…Ù„Ø§Ø²Ù…': 44,'Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„': 44,'Ù†Ù‚ÙŠØ¨': 48,'Ø±Ø§Ø¦Ø¯': 50,'Ù…Ù‚Ø¯Ù…': 52,
      'Ø¹Ù‚ÙŠØ¯': 54,'Ø¹Ù…ÙŠØ¯': 56,'Ù„ÙˆØ§Ø¡': 58
    };
    return retirementAges[rank] || 60;
  }

  function getMilitaryTimingInfoFromAnswers(a){
    const nowH = getHijriNowParts();
    const by = parseInt(a.birthYear || '0', 10);
    const bm = parseInt(a.birthMonth || '0', 10);
    const bd = parseInt(a.birthDay || '0', 10);

    const rankAge = getRetirementAge(a.militaryRank || 'Ø¬Ù†Ø¯ÙŠ');
    const retY = by + rankAge;
    const retM = bm;
    const retD = bd;

    const y60 = by + 60;
    const m60 = bm;
    const d60 = bd;

    const rankRemainingMonths = monthsDiffHijri(nowH.y, nowH.m, nowH.d, retY, retM, retD);
    const monthsTo60 = monthsDiffHijri(nowH.y, nowH.m, nowH.d, y60, m60, d60);

    return {
      nowH,
      birth:{y:by,m:bm,d:bd},
      rankAge,
      rankRemainingMonths,
      monthsTo60,
      rankRetHijriStr: `${retY}/${String(retM).padStart(2,'0')}/${String(retD).padStart(2,'0')}`
    };
  }

  function getMaxAllowedMonths(){
    const info = getMilitaryTimingInfoFromAnswers(answers);
    const by = info.birth.y;
    if(!by){ return 0; }

    let maxAge = 60;

    if(answers.jobType === 'Ø¹Ø³ÙƒØ±ÙŠ'){
      maxAge = info.rankAge;
      if(answers.extendAfterRetirement === 'Ù†Ø¹Ù…'){
        maxAge = 60;
      }
    }

    const retY = by + maxAge;
    const retM = info.birth.m;
    const retD = info.birth.d;
    const remainingMonths = monthsDiffHijri(info.nowH.y, info.nowH.m, info.nowH.d, retY, retM, retD);

    answers.retirementYearHijri = retY;

    if(remainingMonths <= 0){
      showSorryPage(answers.clientName || "Ø§Ù„Ø¹Ù…ÙŠÙ„");
      return 0;
    }

    const isPersonal = answers.financeType && (
      answers.financeType.includes('Ø´Ø®ØµÙŠ') ||
      answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ' ||
      answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ' ||
      answers.financeType === 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ'
    );

    return Math.min(remainingMonths, isPersonal ? 60 : 360);
  }

  function describeMonths(m){
    const y = Math.floor(m / 12), mo = m % 12;
    let result = `${m} Ø´Ù‡Ø±`;
    let yTxt = y === 1 ? "Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©" : y === 2 ? "Ø³Ù†ØªØ§Ù†" : y >= 3 && y <= 10 ? `${y} Ø³Ù†ÙˆØ§Øª` : y > 10 ? `${y} Ø³Ù†Ø©` : '';
    let mTxt = mo === 1 ? "ÙˆØ´Ù‡Ø± ÙˆØ§Ø­Ø¯" : mo === 2 ? "ÙˆØ´Ù‡Ø±ÙŠÙ†" : mo >= 3 && mo <= 10 ? `Ùˆ${mo} Ø£Ø´Ù‡Ø±` : mo > 10 ? `Ùˆ${mo} Ø´Ù‡Ø±` : '';
    if (yTxt || mTxt) result += ` (${yTxt} ${mTxt})`;
    return result.trim();
  }

  function numberToArabicWords(n){
    if (n < 1000) return `${n} Ø±ÙŠØ§Ù„`;
    let parts = [];
    if(n >= 1_000_000){
      let mil = Math.floor(n / 1_000_000);
      parts.push(mil === 1 ? "Ù…Ù„ÙŠÙˆÙ†" : mil === 2 ? "Ù…Ù„ÙŠÙˆÙ†Ø§Ù†" : mil <= 10 ? `${mil} Ù…Ù„Ø§ÙŠÙŠÙ†` : `${mil} Ù…Ù„ÙŠÙˆÙ†`);
      n %= 1_000_000;
    }
    if(n >= 1000){
      let th = Math.floor(n / 1000);
      parts.push(th === 1 ? "Ø£Ù„Ù" : th === 2 ? "Ø£Ù„ÙØ§Ù†" : th <= 10 ? `${th} Ø¢Ù„Ø§Ù` : `${th} Ø£Ù„Ù`);
      n %= 1000;
    }
    if(n > 0) parts.push(`${n}`);
    return parts.join(" Ùˆ ") + " Ø±ÙŠØ§Ù„";
  }

  function getHousingSupportMonthlyBySalary(salary){
    const s = Number(salary || 0);
    if (s <= 3000) return 1350;
    if (s <= 4000) return 1206;
    if (s <= 5000) return 1073;
    if (s <= 6000) return 955;
    if (s <= 7000) return 850;
    if (s <= 8000) return 757;
    if (s <= 9000) return 673;
    if (s <= 10000) return 599;
    return 416;
  }

  function fmtMoney(n){
    const x = Number(n || 0);
    return x.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " Ø±ÙŠØ§Ù„";
  }

  function showSorryPage(name){
    showPage('calculator');
    const cont = document.getElementById('question');
    document.getElementById('nextButton').style.display = 'none';
    cont.innerHTML = `<div class="fade-in alert-error">
      <strong>Ù…Ø¹Ù„ÙŠØ´ ${escapeHtml(name)}ØŒ ÙŠØ¸Ù‡Ø± Ø¥Ù† Ø¹Ù…Ø±Ùƒ ØªØ¹Ø¯Ù‘Ù‰ Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„ØªÙ…ÙˆÙŠÙ„.</strong><br>
      Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…ØªÙ‚Ø§Ø¹Ø¯ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±.
    </div>`;
  }

  function handleStartOrReset(){
    if(!hasStarted){
      hasStarted = true;
      document.getElementById('mainButton').style.display = 'none';
      document.getElementById('resetButtonContainer').style.display = 'block';
      document.getElementById('nextButton').style.display = 'inline-flex';
      showQuestion();
    }else{ resetCalc(); }
  }

  function resetCalc(){
    answers = { commitments: [] };
    step = 0;
    commitmentStep = 0;
    currentCommitment = {};
    hasStarted = true;
    document.getElementById('mainButton').style.display = 'none';
    document.getElementById('resetButtonContainer').style.display = 'block';
    document.getElementById('nextButton').style.display = 'inline-flex';
    showQuestion();
  }

  function showComingSoonForProduct(productName){
    const titleEl = document.getElementById('comingSoonTitle');
    const textEl = document.getElementById('comingSoonText');

    titleEl.textContent = productName || 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹';

    const msg = getFinanceProductMessage(productName);
    if(msg){
      textEl.innerHTML = `${escapeHtml(msg)}<br><br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ØªÙ…ÙˆÙŠÙ„ Ø¢Ø®Ø± Ù„Ù„Ø§Ø­ØªØ³Ø§Ø¨.`;
    } else if (productName === 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ') {
      textEl.innerHTML = 'Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø­ØªØ³Ø§Ø¨ Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ© Ø¹Ø¨Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©.<br>Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ ğŸ™<br><br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ØªÙ…ÙˆÙŠÙ„ Ø¢Ø®Ø± Ù„Ù„Ø§Ø­ØªØ³Ø§Ø¨.';
    } else {
      textEl.innerHTML = 'Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©.<br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø­ØªØ³Ø§Ø¨ ØªÙ…ÙˆÙŠÙ„ Ø¢Ø®Ø± Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡.';
    }
    showPage('comingSoon');
  }

  function showQuestion(){
    const cont = document.getElementById('question');
    cont.innerHTML = '';
    let q;

    if(step < generalQuestions.length){
      q = generalQuestions[step];

      if(q.id === 'financeType'){
        q.options = getFinanceProductNames();
      }

      if(q.show && !q.show(answers)){ step++; showQuestion(); return; }

      if(q.id === 'salary'){
        const ft = answers.financeType;
        if(ft && !isFinanceProductEnabled(ft)){
          showComingSoonForProduct(ft);
          return;
        }
      }

      if(q.id === 'profitMargin' && answers.calcMode === 'ØªØ±Ø´ÙŠØ­ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'){
        const list = getMatchingBanksForAnswers();
        const rec = list[0];
        if(rec){
          answers.recommendedBank = rec;
          answers.profitMargin = rec.margin;
          step++;
          showQuestion();
          return;
        } else {
          alert('Ù„Ù„Ø§Ø³Ù Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø§ÙŠÙ…ÙƒÙ†Ù†Ø§ ØªØ±Ø´ÙŠØ­ Ø¨Ù†Ùƒ Ù…Ø¹ÙŠÙ‘Ù†    ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙŠ ØªØ¯Ø®Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
        }
      }
    }else if(answers.hasCommitments === 'Ù†Ø¹Ù…'){
      q = commitmentQuestions[commitmentStep];
      if(q.show && !q.show(currentCommitment)){ commitmentStep++; showQuestion(); return; }
    }else{
      document.getElementById('nextButton').style.display = 'none';
      calculate();
      return;
    }

    const div = document.createElement('div');
    div.classList.add('fade-in');
    div.innerHTML = `<label>${q.label}</label>`;

    if(q.type === 'select'){
      const sel = document.createElement('select');
      sel.id = q.id;
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>';

      if(q.dynamic && q.id === 'months'){
        const limit = (step < generalQuestions.length)
          ? getMaxAllowedMonths()
          : (currentCommitment.type === 'Ù‚Ø±Ø¶ Ø¹Ù‚Ø§Ø±ÙŠ' ? 360 : 60);
        for(let i=1; i<=limit; i++){
          sel.innerHTML += `<option value="${i}">${i} Ø´Ù‡Ø±</option>`;
        }
      } else if(q.dynamic && q.id === 'appointYear'){
        const nowH = getHijriNowParts();
        const start = Math.max(1300, nowH.y - 40);
        for(let y = nowH.y; y >= start; y--){
          sel.innerHTML += `<option value="${y}">${y}</option>`;
        }
      } else {
        q.options.forEach(opt => {
          sel.innerHTML += `<option value="${opt}">${opt}</option>`;
        });
      }
      div.appendChild(sel);
    } else {
      div.innerHTML += `<input type="${q.type}" id="${q.id}" ${q.default ? `value="${q.default}"` : ''}>`;
    }

    cont.appendChild(div);
  }

  function nextQuestion(){
    const q = step < generalQuestions.length ? generalQuestions[step] : commitmentQuestions[commitmentStep];
    const el = document.getElementById(q.id);
    const val = el ? el.value : '';

    if(!val){
      alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
      return;
    }

    if(step < generalQuestions.length){
      answers[q.id] = val;

      if(q.id === 'financeType'){
        if(!isFinanceProductEnabled(val)){
          showComingSoonForProduct(val);
          return;
        }
      }

      if(q.id === 'months'){
        const max = getMaxAllowedMonths();
        if(parseInt(val) > max){
          alert(`Ø£Ù‚ØµÙ‰ Ù…Ø¯Ø© Ù…Ø³Ù…ÙˆØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„ØªÙ‚Ø§Ø¹Ø¯: ${describeMonths(max)}.`);
          answers[q.id] = String(max);
        }
      }

      step++;
    } else {
      // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
      if(q.id === 'months') currentCommitment[q.id] = parseInt(val,10);
      else if(q.id === 'amount' || q.id === 'balloonAmount') currentCommitment[q.id] = parseFloat(val);
      else currentCommitment[q.id] = val;

      if(q.id === 'more'){
        answers.commitments.push(currentCommitment);
        currentCommitment = {};
        if(val === 'Ù†Ø¹Ù…'){
          commitmentStep = 0;
          showQuestion();
          return;
        } else {
          document.getElementById('nextButton').style.display = 'none';
          calculate();
          return;
        }
      }

      commitmentStep++;
    }

    showQuestion();
  }

  // ====== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© / Ù…Ø´Ø§Ø±ÙƒØ© ======
  async function saveResultAsImage(){
    const card = document.getElementById('resultCard');
    if(!card){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø­ÙØ¸.'); return; }
    try{
      const canvas = await html2canvas(card, {scale: 2, backgroundColor: '#ffffff'});
      const link = document.createElement('a');
      link.download = 'FINO-result.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }catch(e){
      alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©.');
    }
  }

  function shareResultOnWhatsApp(){
    const lc = answers._lastCalc;
    if(!lc){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.'); return; }
    const text = (lc._lastClientText || buildSimpleShareText(lc)).trim();
    const url = 'https://wa.me/?text=' + encodeURIComponent(text);
    window.open(url, '_blank');
  }

  function buildSimpleShareText(lc){
    const n = lc.clientName || 'Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„';
    const inst = lc.mainInstText || '';
    const net = lc.finalNetText || '';
    return `Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø¨Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)\n\nÙ…Ø±Ø­Ø¨Ø§Ù‹ ÙˆÙ…Ø³Ù‡Ù„Ø§Ù‹ ÙŠØ§ ${n}\n${inst}\n${net}\n\n*Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙˆÙ‚Ø¯ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©.*`;
  }

  // ====== Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø®ØªØµØ±Ø©) ======
  let _clientResultTextCache = '';

  function openClientResultModal(skipCheck){
    if(!skipCheck && !_miniAdminVerified){
      openMiniAdminTools();
      return;
    }
    document.getElementById('clientNetOverride').value = '';
    document.getElementById('clientInstOverride').value = '';
    document.getElementById('clientNoteOverride').value = '';
    document.getElementById('clientResultModal').style.display = 'block';
  }
  function closeClientResultModal(){
    document.getElementById('clientResultModal').style.display = 'none';
  }

  function renderClientPreviewFromText(txt){
    const box = document.getElementById('clientPreviewCard');
    if(!box) return;
    const safe = escapeHtml(txt).replace(/\n/g,'<br>');
    box.innerHTML = `<div class="h">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø¨Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)</div><div>${safe}</div>`;
  }

  function generateClientResultText(){
    const lc = answers._lastCalc;
    if(!lc){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.'); return; }

    const n = lc.clientName || '';
    const netOverride = parseFloat(document.getElementById('clientNetOverride').value || '0');
    const instOverride = parseFloat(document.getElementById('clientInstOverride').value || '0');
    const note = (document.getElementById('clientNoteOverride').value || '').trim();

    const netText = netOverride ? fmtMoney(netOverride) : (lc.finalNetText || '');
    const instText = instOverride ? fmtMoney(instOverride) : (lc.mainInstText || '');

    let txt = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙˆÙ…Ø³Ù‡Ù„Ø§Ù‹ ÙŠØ§ ${n}\n\n`;
    if(instText) txt += `Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${instText}\n`;
    if(netText) txt += `Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${netText}\n`;

    if(lc.durationText) txt += `\nÙ…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„: ${lc.durationText}\n`;
    if(note) txt += `\nÙ…Ù„Ø§Ø­Ø¸Ø©: ${note}\n`;

    txt += `\n*Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙˆÙ‚Ø¯ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©.*`;

    document.getElementById('clientResultText').value = txt;
    _clientResultTextCache = txt;
    lc._lastClientText = txt;
    renderClientPreviewFromText(txt);
  }

  function copyClientResultText(){
    const ta = document.getElementById('clientResultText');
    if(!ta) return;
    ta.select();
    ta.setSelectionRange(0, 999999);
    try{
      document.execCommand('copy');
      alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');
    }catch(e){
      alert('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®.');
    }
  }

  function shareClientResultOnWhatsApp(){
    const txt = (document.getElementById('clientResultText').value || _clientResultTextCache || '').trim();
    if(!txt){ alert('Ø£Ù†Ø´Ø¦ Ø§Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹.'); return; }
    const url = 'https://wa.me/?text=' + encodeURIComponent(txt);
    window.open(url, '_blank');
  }

  async function saveClientResultAsImage(){
    const box = document.getElementById('clientPreviewCard');
    if(!box){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø©.'); return; }
    try{
      const canvas = await html2canvas(box, {scale: 2, backgroundColor:'#ffffff'});
      const link = document.createElement('a');
      link.download = 'FINO-client-result.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }catch(e){
      alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©.');
    }
  }

  // ====== Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© ======
  function updateFooterDateTime(){
    const now = new Date();
    const dt = now.toLocaleString('ar-SA', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'});
    const hij = getHijriNowDisplay();
    const el = document.getElementById('datetime');
    const elH = document.getElementById('datetimeHijri');
    if(el) el.textContent = dt;
    if(elH) elH.textContent = hij;
  }

  // ====== (Ø¥Ø¶Ø§ÙØ©) ØªÙ‚Ø¯ÙŠØ± Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ ======
  function estimateMilitaryPensionFromAnswers(currentNetSalary){
    if(answers.jobType !== 'Ø¹Ø³ÙƒØ±ÙŠ') return 0;
    if(answers.extendAfterRetirement !== 'Ù†Ø¹Ù…') return 0;

    const ad = parseInt(answers.appointDay || '0', 10);
    const am = parseInt(answers.appointMonth || '0', 10);
    const ay = parseInt(answers.appointYear || '0', 10);
    if(!ad || !am || !ay) return 0;

    const info = getMilitaryTimingInfoFromAnswers(answers);
    const retY = info.birth.y + info.rankAge;
    const retM = info.birth.m;
    const retD = info.birth.d;

    const serviceMonths = monthsDiffHijri(ay, am, ad, retY, retM, retD);

    const basic = Number(currentNetSalary || 0) * Number(retirementSettings.basicMultiplier || 1.0);

    const pension = Math.min(basic, basic * (serviceMonths / 420));
    return Math.max(0, pension);
  }

  // ====== Ø§Ù„Ø­Ø³Ø¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ÙƒÙ…Ø§ Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) ======
  function calculate(){
    const salary = parseFloat(answers.salary || '0');
    const months = parseInt(answers.months || '0', 10);
    const years  = months / 12;
    const financeType = answers.financeType || '';
    const supported = answers.supported;
    const bundle = answers.bundle;

    let profitMargin = parseFloat(answers.profitMargin || '0');
    if (!profitMargin || isNaN(profitMargin)) {
      alert('Ù†Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
      return;
    }

    const now = new Date();
    const dayNames = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
    const dayName = dayNames[now.getDay()];
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    const calcDateTimeStr = `${dayName} ${y}-${m}-${d} ${hh}:${mm}:${ss}`;

    const isExtended = (answers.jobType === 'Ø¹Ø³ÙƒØ±ÙŠ' && answers.extendAfterRetirement === 'Ù†Ø¹Ù…');
    const timing = getMilitaryTimingInfoFromAnswers(answers);
    const preRetMonths = isExtended ? Math.min(months, timing.rankRemainingMonths) : months;
    const pensionSalaryEst = isExtended ? estimateMilitaryPensionFromAnswers(salary) : 0;

    const isBuyoutPersonal = financeType === 'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ';
    const isConsumer = financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ';
    const isLeasing = financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ';
    const isMortgage = financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ');
    const isPersonalLike = (financeType.includes('Ø´Ø®ØµÙŠ') || isLeasing || isBuyoutPersonal || isConsumer);

    // Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹
    let deductionRate = 0;
    let salaryForDeductionPre = salary;

    const housingSupportMonthlyTmp = (financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ' && supported === 'Ù…Ø¯Ø¹ÙˆÙ…' && bundle === 'Ù„Ø§')
      ? getHousingSupportMonthlyBySalary(salary)
      : 0;

    if(isPersonalLike){
      deductionRate = 45;
    } else if(isMortgage){
      if(answers.includeSupportInSalary === 'Ù†Ø¹Ù…' && salary < 15000 && supported === 'Ù…Ø¯Ø¹ÙˆÙ…' && bundle === 'Ù„Ø§'){
        deductionRate = 65;
        salaryForDeductionPre = salary + housingSupportMonthlyTmp;
      } else {
        if(supported === 'Ù…Ø¯Ø¹ÙˆÙ…'){
          if(answers.isEtezaaz === 'Ù†Ø¹Ù…') deductionRate = 65;
          else if(bundle === 'Ù„Ø§') deductionRate = 65;
          else deductionRate = salary < 15000 ? 55 : 65;
        } else {
          deductionRate = salary < 15000 ? 55 : 65;
        }
      }
    } else {
      deductionRate = 45;
    }

    const allowedInstPre = salaryForDeductionPre * deductionRate / 100;
    const allowedInstPost = (isExtended ? (pensionSalaryEst * (isPersonalLike ? 25 : deductionRate) / 100) : allowedInstPre);

    // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    let commits = [...(answers.commitments || [])].sort((a,b)=>parseInt(a.months)-parseInt(b.months));
    let balloonPhases = [];

    // âœ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©: ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ù†Ù‡Ø§ÙŠØ© Ù‚Ø³Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø©
    commits.forEach((c) => {
      if (c.type === 'Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©' && c.balloon === 'Ù†Ø¹Ù…' && c.balloonAmount) {
        const start = parseInt(c.months) + 1; // ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ù‚Ø³Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        const end = start + 24;               // 24 Ø´Ù‡Ø±
        balloonPhases.push({ start, end, value: (Number(c.balloonAmount) / 24) });
      }
    });

    // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…ØªØ§Ø­ Ø´Ù‡Ø± Ø¨Ø´Ù‡Ø±
    let monthList = [];
    for(let mo=1; mo<=months; mo++){
      let activeCommits = commits
        .filter(c => mo <= parseInt(c.months))
        .reduce((sum, c) => sum + (Number(c.amount) || 0), 0);

      let balloonExtra = balloonPhases.reduce((sum, b) =>
        (mo >= b.start && mo < b.end) ? sum + (b.value || 0) : sum, 0);

      const monthAllowed = (isExtended && mo > preRetMonths) ? allowedInstPost : allowedInstPre;

      let available = monthAllowed - activeCommits - balloonExtra;

      // Ø³Ù‚Ù Ø§Ù„Ø´Ø®ØµÙŠ 33.33% Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©
      if(isPersonalLike){
        const baseForCap = (isExtended && mo > preRetMonths) ? (pensionSalaryEst || 0) : salary;
        available = Math.min(available, baseForCap * 0.3333);
      }

      monthList.push({month: mo, inst: available});
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª
    let finalPhases = [];
    for(let i=0;i<monthList.length;i++){
      const cur = monthList[i];
      if(i===0 || cur.inst !== finalPhases[finalPhases.length-1].inst){
        finalPhases.push({from: cur.month, to: cur.month, inst: cur.inst});
      } else {
        finalPhases[finalPhases.length-1].to = cur.month;
      }
    }

    // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
    const totalInst = finalPhases.reduce((s,p)=> s + (p.inst * (p.to - p.from + 1)), 0);

    // ØµØ§ÙÙŠ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
    const profitFactor = (years * profitMargin / 100) + 1;
    const netFinance = totalInst / profitFactor;

    // Ø±Ø³ÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù…Ø«Ù„ Ù…Ù†Ø·Ù‚Ùƒ)
    let adminFee = 0, vat = 0;
    if(isPersonalLike){
      adminFee = netFinance * 0.005;
      if(adminFee > 2500) adminFee = 2500;
      vat = adminFee * 0.15;
    } else {
      adminFee = netFinance * 0.01;
      vat = adminFee * 0.15;
      if(adminFee + vat > 5750){ adminFee = 5000; vat = 750; }
    }

    const finalNet = netFinance - (adminFee + vat);

    // âœ… ØªÙ†Ø¨ÙŠÙ‡ Ø³Ø§Ù„Ø¨: Ø¥Ø°Ø§ Ø£ÙŠ ÙØªØ±Ø© Ø³Ø§Ù„Ø¨
    const hasNegative = finalPhases.some(p => (p.inst || 0) < 0);

    // Ù†ØµÙˆØµ Ø¹Ø±Ø¶
    const clientName = answers.clientName || '';
    const durationText = describeMonths(months);

    // Ù‚Ø³Ø· Ø±Ø¦ÙŠØ³ÙŠ (Ø£ÙˆÙ„ ÙØªØ±Ø©)
    const firstPhase = finalPhases[0];
    const mainInstText = firstPhase
      ? `Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± ${firstPhase.from} Ø¥Ù„Ù‰ ${firstPhase.to}: ${fmtMoney(firstPhase.inst)}`
      : '';

    const finalNetText = `ØªÙ…ÙˆÙŠÙ„Ùƒ Ø§Ù„ØµØ§ÙÙŠ ÙŠØ§ ${clientName} Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ…: ${fmtMoney(finalNet)}`;

    // Ø­ÙØ¸ Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
    answers._lastCalc = {
      clientName,
      financeType,
      calcDateTimeStr,
      durationText,
      recommendedBankName: (answers.recommendedBank && answers.recommendedBank.bankName) ? answers.recommendedBank.bankName : '',
      phases: finalPhases,
      finalNet,
      adminFee,
      vat,
      profitMargin,
      mainInstText,
      finalNetText,
      _lastClientText: ''
    };

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    let html = '';

    html += `
      <div class="result-header">
        <div class="client-chip">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙˆÙ…Ø³Ù‡Ù„Ø§Ù‹ ÙŠØ§ ${escapeHtml(clientName || 'Ø¶ÙŠÙÙ†Ø§')}</div>
        <div>
          <div class="badge-mode">${escapeHtml(financeType)}</div>
          <div class="badge-duration">${escapeHtml(durationText)}</div>
        </div>
      </div>
      <div style="font-size:12px; color:#6b7280; text-align:right;">${escapeHtml(calcDateTimeStr)}</div>
    `;

    if(answers.recommendedBank && answers.recommendedBank.bankName){
      const bn = answers.recommendedBank.bankName;
      const logo = bankLogoMap[bn] || '';
      html += `
        <div class="bank-card">
          <div class="bank-logo">${logo ? `<img src="${logo}" alt="${escapeHtml(bn)}">` : 'ğŸ¦'}</div>
          <div>
            <div class="bank-text-main">Ø§Ù„Ø¨Ù†Ùƒ/Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø©: ${escapeHtml(bn)}</div>
            <div class="bank-text-sub">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù‚Ù„ Ù‡Ø§Ù…Ø´Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.</div>
          </div>
        </div>
      `;
    }

    if(hasNegative){
      html += `<div class="alert-error">Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ…ÙˆÙŠÙ„.</div>`;
    }

    html += `
      <div class="result-main-block">
        <div class="result-main-title">ğŸ’° Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ…</div>
        <div class="result-amount-main">${fmtMoney(finalNet)}</div>
        <div class="result-amount-sub">${escapeHtml(numberToArabicWords(Math.round(finalNet)))}</div>
        <div class="result-amount-small">Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© + Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${fmtMoney(adminFee + vat)}</div>
      </div>
    `;

    html += `<div class="result-section-title">Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø§Øª</div>`;
    html += `<div class="result-section-box">`;
    finalPhases.forEach(p=>{
      html += `<div class="instalment-row">Ù…Ù† Ø§Ù„Ø´Ù‡Ø± <strong>${p.from}</strong> Ø¥Ù„Ù‰ <strong>${p.to}</strong> = <strong>${fmtMoney(p.inst)}</strong></div>`;
    });
    html += `</div>`;

    document.getElementById('resultCard').innerHTML = html;
    showPage('result');
  }

  // ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ======
  (function init(){
    loadBankConfigs();
    loadFinanceProducts();
    loadRetirementSettings();
    renderFinanceProductsTable();
    updateFooterDateTime();
    setInterval(updateFooterDateTime, 1000);
  })();
</script>

</body>
</html>