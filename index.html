<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù†ØµØ© FINO -ØªØ±Ø´ÙŠØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠFINO â€” Smart Finance Match </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Tajawal', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f3f4f6;
      margin: 0;
      text-align: center;
      font-size: 20px;
      direction: rtl;
      color: #111827;
    }
    header {
      background: linear-gradient(135deg, #0f172a, #1e3a8a);
      color: #fff;
      padding: 14px 10px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 24px; font-weight: 700; letter-spacing: 0.03em; }
    header p { margin: 4px 0 0; font-size: 16px; opacity: 0.95; }
    .top-bar { display: flex; justify-content: flex-start; align-items: center; max-width: 900px; margin: 0 auto; }
    .page-container { max-width: 900px; margin: 16px auto 32px; padding: 0 10px; }
    .card { background: #ffffff; border-radius: 18px; padding: 18px 16px; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06); margin-bottom: 14px; text-align: center; width: 100%; }
    button, .btn { border-radius: 999px; border: none; padding: 14px 22px; font-size: 19px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease; }
    button.primary, .btn.primary { background: #2563eb; color: #ffffff; box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35); }
    button.primary:hover, .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45); background: #1d4ed8; }
    button.secondary, .btn.secondary { background: #e0f2fe; color: #1d4ed8; }
    button.secondary:hover, .btn.secondary:hover { background: #dbeafe; }
    button.small, .btn.small { padding: 12px 20px; font-size: 18px; }
    input, select, textarea { width: 100%; padding: 11px 12px; margin: 8px 0 2px; font-size: 18px; border-radius: 10px; border: 1px solid #d1d5db; text-align: right; background: #f9fafb; color: #111827; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35); background: #ffffff; }
    label { display: block; text-align: right; font-size: 17px; margin-top: 8px; margin-bottom: 2px; color: #374151; }
    .fade-in { animation: fadeInMove .3s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeInMove { to { opacity: 1; transform: translateY(0); } }
    .page { display: none; }
    .page.active { display: block; }
    .welcome-title { font-size: 23px; margin-bottom: 6px; color: #111827; }
    .welcome-sub { font-size: 15px; color: #6b7280; margin-bottom: 18px; }
    .steps-badge { font-size: 14px; color: #6b7280; margin-bottom: 6px; text-align: right; }
    .result-header { display: flex; justify-content: space-between; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 6px; }
    .client-chip { background: #e0f2fe; color: #1d4ed8; border-radius: 999px; padding: 6px 14px; font-size: 14px; border: 1px solid #bfdbfe; }
    .badge-mode { background: #eff6ff; color: #1d4ed8; border-radius: 999px; padding: 4px 10px; font-size: 12px; display: inline-block; }
    .badge-duration { background: #e0f2fe; color: #1e3a8a; border-radius: 999px; padding: 4px 10px; font-size: 12px; display: inline-block; margin-top: 3px; }
    .bank-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 16px; background: #eff6ff; border: 1px dashed #2563eb; margin: 8px 0 12px; text-align: right; position: relative; }
    .bank-logo { width: 48px; height: 48px; border-radius: 14px; background: #ffffff; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; border: 1px solid #e5e7eb; }
    .bank-logo img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .bank-text-main { font-size: 16px; font-weight: 600; color: #0f172a; }
    .bank-text-sub { font-size: 13px; color: #4b5563; line-height: 1.5; }
    .promo-note { font-size: 11px; color: #d97706; background: #fffbeb; padding: 2px 6px; border-radius: 4px; border: 1px solid #fcd34d; margin-right: 6px; font-weight: bold; }

    /* ====== ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ====== */
    .result-main-block { background: radial-gradient(circle at top, #e0f2fe 0, #ffffff 60%); border-radius: 18px; padding: 12px 14px; margin-top: 4px; text-align: right; border: 1px solid #bfdbfe; }
    .result-main-title { font-size: 14px; color: #1d4ed8; margin-bottom: 2px; display:flex; align-items:center; gap:8px; font-weight: 900; }
    .result-amount-main { font-size: 30px; font-weight: 900; color: #1e40af; margin: 2px 0 6px; letter-spacing: .2px; line-height: 1.2; }
    .result-amount-sub { font-size: 13px; color: #1d4ed8; margin: 2px 0; line-height: 1.6; }
    .result-amount-small { font-size: 13px; color: #374151; margin-top: 2px; line-height: 1.6; }
    .support-panel { margin-top: 10px; border-radius: 16px; padding: 10px 12px; background: #f8fafc; border: 1px solid #e5e7eb; }
    .support-title { font-size: 13px; font-weight: 900; color: #0f766e; display:flex; align-items:center; gap:8px; margin-bottom: 6px; }
    .support-row { font-size: 13px; color: #0f172a; display:flex; justify-content: space-between; gap: 10px; padding: 4px 0; border-bottom: 1px dashed #e5e7eb; }
    .support-row:last-child{ border-bottom:none; }
    .support-badge { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; background:#ecfeff; color:#155e75; border: 1px solid #a5f3fc; margin-top: 6px; }
    .dual-main-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 8px; margin-top: 10px; }
    .dual-box { background: #eff6ff; border-radius: 14px; padding: 8px 10px; font-size: 13px; text-align: right; border: 1px solid #dbeafe; }
    .dual-box-title { font-size: 12px; color: #1d4ed8; margin-bottom: 2px; font-weight: 900; }
    .dual-box-amount { font-size: 18px; font-weight: 900; color: #1e3a8a; }
    .result-section-title { text-align: right; font-size: 16px; font-weight: 900; margin: 12px 0 6px; color: #111827; }
    .result-section-box { border-radius: 16px; background: #f9fafb; border: 1px solid #e5e7eb; padding: 10px 12px; text-align: right; }
    .instalment-row { font-size: 15px; padding: 7px 0; border-bottom: 1px dashed #e5e7eb; text-align: right; color: #111827; line-height: 1.6; font-weight: 700; }
    .instalment-row strong { font-weight: 900; color:#1e3a8a; }
    .instalment-row:last-child { border-bottom: none; }
    .alert-error { color: #b91c1c; background: #fef2f2; border-radius: 12px; padding: 8px 10px; font-size: 14px; margin: 6px 0; text-align: right; border: 1px solid #fecaca; line-height: 1.55; }
    .notice-soft { color:#9f1239; background:#fff1f2; border:1px solid #fecdd3; border-radius: 14px; padding: 10px 12px; font-size: 13px; text-align:right; line-height: 1.6; margin-top: 8px; }
    .vat-small { font-size: 11px; color: #6b7280; font-weight: 600; margin-top: 2px; }
    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 8px 12px; margin-top: 6px; text-align: right; }
    .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .admin-table th, .admin-table td { border: 1px solid #e5e7eb; padding: 5px 6px; font-size: 12px; text-align: center; vertical-align: top; }
    .admin-table th { background: #f3f4f6; color: #374151; }
    footer { font-size: 13px; color: #6b7280; margin-top: 10px; padding: 8px 12px; position: relative; background: #f9fafb; border-top: 1px solid #e5e7eb; }
    .footer-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    #miniAdminTools { display:inline-flex; align-items:center; gap:6px; cursor:pointer; padding: 4px 8px; border-radius: 10px; border: 1px dashed #e5e7eb; background:#fff; color:#111827; font-size: 12px; user-select:none; }
    #miniAdminTools:hover { background:#f3f4f6; }
    .client-preview { background:#ffffff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 12px 12px; text-align:right; line-height:1.7; font-size:14px; color:#111827; }
    .client-preview .h { font-weight: 900; color:#1e3a8a; font-size:16px; margin-bottom:6px; }
    .client-preview .k { color:#374151; font-weight: 800; }
    .client-preview .v { color:#0f172a; font-weight: 900; }
    .client-preview .hr { height:1px;background:#e5e7eb;margin:10px 0; }
    .hijri-chip{ display:inline-flex; align-items:center; gap:6px; padding: 3px 10px; border-radius: 999px; font-size: 11px; background:#eff6ff; color:#1d4ed8; border: 1px solid #dbeafe; margin-right:6px; font-weight:800; white-space:nowrap; }
    
    /* Ù…Ø¸Ù‡Ø± ÙˆØ§ØªØ³Ø§Ø¨ */
    .btn-whatsapp { background-color: #25D366; color: white; border: none; }
    .btn-whatsapp:hover { background-color: #128C7E; }
  </style>
</head>
<body>

<header>
  <div class="top-bar">
    <div style="text-align:right">
      <h1>Ù…Ù†ØµØ© FINO</h1>
      <p>Ù…Ù†ØµØ© Ø°ÙƒÙŠØ© ØªØ­Ø³Ø¨ Ù„Ùƒ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØªÙØ±Ø´Ù‘Ø­ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù†Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø§ØªØ¨Ùƒ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†ÙØŒ Ø¨Ø¯ÙˆÙ† Ø­ÙŠØ±Ø© ÙˆÙ„Ø§ ØªØ¹Ø¨</p>
    </div>
  </div>
</header>

<div class="page-container">

  <div id="landingPage" class="page active">
    <div class="card fade-in">
      <div class="welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</div>
      <div class="welcome-sub">
        Ù…Ù† Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØ­Ø³Ø¨ ØªÙ…ÙˆÙŠÙ„Ùƒ ÙˆØªØ´ÙˆÙ Ø£ÙØ¶Ù„ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ Ù„Ùƒ Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø±Ø§ØªØ¨Ùƒ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ.
      </div>
      <button class="primary" onclick="startClientFlow()">
        Ø§Ø¨Ø¯Ø£ Ø¨Ø£Ø³Ù… Ø§Ù„Ù„Ù‡
      </button>
      <div style="margin-top:12px; font-size:13px; color:#6b7280;">
        Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…ØµÙ…Ù…Ø© Ø¨Ø­ÙŠØ« ØªÙ‚Ø¯Ø± ØªØµÙˆÙ‘Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ ØªØ­ÙØ¸Ù‡Ø§ ÙƒØµÙˆØ±Ø© .
      </div>
    </div>
  </div>

  <div id="calculatorPage" class="page">
    <div class="card">
      <div class="steps-badge">
        Ø£Ø³Ø¦Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø£Ø¯Ù‚ Ø­Ø³Ø¨Ø© Ù…Ù…ÙƒÙ†Ø© ğŸ‘Œ
      </div>
      <div id="question"></div>
      <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
        <button id="nextButton" class="primary small" style="display:none;" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="mainButton" class="primary small" onclick="handleStartOrReset()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø¨Ø©</button>
      </div>
      <div id="resetButtonContainer" style="margin-top:8px; display:none;">
        <button class="secondary small" onclick="resetCalc()">ğŸ”Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø¨Ø© </button>
      </div>
    </div>
  </div>

  <div id="resultPage" class="page">
    <div class="card fade-in" id="resultCard">
      </div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
      <button class="secondary small" onclick="backToLanding()">ğŸ  Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="secondary small" onclick="saveResultAsImage()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø©</button>
        <button class="primary small btn-whatsapp" onclick="shareResultOnWhatsAppWithDetails()">ğŸ“² Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="primary small" onclick="resetCalc(); showPage('calculator');">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
    </div>
  </div>

  <div id="comingSoonPage" class="page">
    <div class="card fade-in">
      <h2 id="comingSoonTitle" style="margin-top:0; font-size:19px; color:#111827;">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
      <p id="comingSoonText" style="font-size:14px; color:#6b7280;"></p>
      <div style="margin-top:12px;">
        <button class="secondary small" onclick="backToFinanceType()"> ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</button>
      </div>
    </div>
  </div>

  <div id="adminLoginPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
      <p style="font-size:13px; color:#b91c1c; text-align:right;">
        âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…Ø±Ø®Øµ Ù„Ù‡Ù… ÙÙ‚Ø·.
      </p>
      <label for="adminPin">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      <input id="adminPin" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù" />
      <div style="margin-top:12px;">
        <button class="primary small" onclick="handleAdminLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="secondary small" onclick="backToLanding()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div id="adminLoginError" class="alert-error" style="display:none; margin-top:8px;">
        Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </div>
    </div>
  </div>

  <div id="adminHubPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</p>
      <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:10px;">
        <button class="primary small" onclick="showPage('admin')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨</button>
        <button class="secondary small" onclick="showPage('adminProducts')">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„</button>
        <button class="secondary small" onclick="showPage('adminArchive')">Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
        <button class="secondary small" onclick="backToLanding()">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </div>

  <div id="adminPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ù…Ù† Ù‡Ù†Ø§ ØªØ¶ÙŠÙ ÙˆØªØ¹Ø¯Ù‘Ù„ Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆÙ†Ø³Ø¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ÙƒÙ„ Ø¨Ù†Ùƒ.
      </p>

      <form id="adminForm" onsubmit="saveBankConfig(event)">
        <div class="admin-grid">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ / Ø´Ø±ÙƒØ© Ø§Ù„ØªÙ…ÙˆÙŠÙ„</label>
            <select id="adminBankName">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</option>
              <option>Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶</option>
              <option>Ø¨Ù†Ùƒ Ø³Ø§Ø¨</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ</option>
              <option>Ù…ØµØ±Ù Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ</option>
              <option>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©</option>
              <option>Ø¨Ù†Ùƒ Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¯ÙˆÙ„ÙŠ</option>
              <option>Ø¨Ù†Ùƒ Ø¯Ø§Ù„ 360 (D360 Bank)</option>
              <option>Ø¨Ù†Ùƒ Ø¥Ø³ ØªÙŠ Ø³ÙŠ (STC Bank)</option>
              <option>Ø¨Ù†Ùƒ ÙÙŠØ¬Ù† (Vision Bank)</option>
              <option>Ø¢ÙŠØ²ÙŠ Ø¨Ù†Ùƒ (EZ Bank)</option>
              <option>Amlak International Company</option>
              <option>Dar Al Tamleek Company</option>
              <option>Saudi Home Loans Company</option>
              <option>Deutsche Gulf Finance</option>
              <option>Abdul Latif Jameel United Real Estate Finance</option>
              <option>Saudi Real Estate Refinance Company</option>
              <option>Bidaya Home Finance</option>
              <option>Nayifat Finance Company</option>
              <option>Yanal Finance Company</option>
              <option>AlYusr Leasing & Financing Company</option>
              <option>Ajil Financial Services Company</option>
              <option>National Finance Company</option>
              <option>Morabaha Marina Finance Company</option>
              <option>Kirnaf Finance Company</option>
              <option>Aljasriah Finance Company</option>
              <option>Matager Finance Company</option>
              <option>Saudi Finance Company</option>
              <option>Abdul Latif Jameel Finance Company</option>
              <option>Gulf Finance Company</option>
              <option>Tamwily International Company</option>
              <option>Alamthal Financing Company</option>
              <option>Osoul Modern Finance Company</option>
              <option>Dar Aletiman Alsaudi Company</option>
              <option>Tawkelat Financing Company</option>
              <option>Ijarah Finance Company</option>
              <option>Tayseer Finance Company</option>
              <option>Saudi Fransi For Finance Leasing Company</option>
              <option>Tamweel Aloula Finance Company</option>
              <option>American Express Saudi Arabia</option>
              <option>Aljabr Finance Company</option>
              <option>Alraedah Finance Company</option>
              <option>Raya Financing Company</option>
              <option>Quara Finance Company</option>
              <option>Taajeer Finance Company</option>
              <option>Gulf Lifting Financial Leasing Company</option>
              <option>Bab Rizq Jameel Microfinance Company</option>
              <option>United Company for Financial Services (Tasheel)</option>
              <option>Emkan Finance Company</option>
              <option>Tamam Finance Company</option>
              <option>National Home Finance Company</option>
              <option>Ø¨Ù†Ùƒ Ø¢Ø®Ø± (  )</option>
            </select>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</label>
            <select id="adminFinanceType">
               </select>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø¹Ù… (Ù„Ù„Ø¹Ù‚Ø§Ø±ÙŠ)</label>
            <select id="adminSupportedType">
              <option value="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</option>
              <option value="Ù…Ø¯Ø¹ÙˆÙ…">Ù…Ø¯Ø¹ÙˆÙ…</option>
              <option value="ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…">ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</option>
            </select>
          </div>
          <div>
            <label>Ù…Ù† Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„)</label>
            <input id="adminMinSalary" type="number" min="0" />
          </div>
          <div>
            <label>Ø¥Ù„Ù‰ Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„)</label>
            <input id="adminMaxSalary" type="number" min="0" />
          </div>
          <div>
            <label>Ù†Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ (%)</label>
            <input id="adminMargin" type="number" min="0" step="0.01" />
          </div>
           <div style="grid-column: 1 / -1;">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¹Ø±Ø¶ (ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©)</label>
            <input id="adminNote" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ø±Ø¶ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…" />
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="adminJobType">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>Ø¹Ø³ÙƒØ±ÙŠ</option>
              <option>Ù…Ø¯Ù†ÙŠ (Ù‚Ø·Ø§Ø¹ Ø­ÙƒÙˆÙ…ÙŠ)</option>
              <option>Ø®Ø§Øµ (Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ)</option>
              <option>Ø®Ø§Øµ (Ø´Ø±ÙƒØ© Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
              <option>Ø®Ø§Øµ (Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)</option>
            </select>
          </div>
          <div>
            <label>Ù…Ù† Ø´Ù‡Ø± (Ø§Ù„Ù…Ø¯Ø©)</label>
            <input id="adminMinMonths" type="number" min="1" />
          </div>
          <div>
            <label>Ø¥Ù„Ù‰ Ø´Ù‡Ø± (Ø§Ù„Ù…Ø¯Ø©)</label>
            <input id="adminMaxMonths" type="number" min="1" />
          </div>
          <div>
            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="adminProductDetail">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>ÙˆØ­Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚</option>
              <option>Ø¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ</option>
              <option>Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®Ø§Ø±Ø·Ø©</option>
              <option>ØªØ­Øª Ø§Ù„Ø§Ù†Ø´Ø§Ø¡ (Ø¨ÙŠØª ØªÙ…Ù„ÙƒÙ‡ Ø¹Ø¸Ù…)</option>
              <option>Ø§Ø±Ø¶ ÙˆÙ‚Ø±Ø¶ (Ø§Ø±Ø¶ ÙˆØ¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ)</option>
              <option>Ø§Ø±Ø¶ (Ø³ÙƒÙ†ÙŠØ©)</option>
              <option>Ø±Ù‡Ù†</option>
            </select>
          </div>
          <div>
            <label>Ø§Ø¹ØªØ²Ø§Ø² (Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…)</label>
            <select id="adminEtezaaz">
              <option value="">Ø¨Ø¯ÙˆÙ†</option>
              <option value="Ù†Ø¹Ù…">Ø§Ø¹ØªØ²Ø§Ø²</option>
            </select>
          </div>
        </div>
        <input type="hidden" id="adminEditIndex" value="" />
        <div style="text-align:left; margin-top:10px;">
          <button type="submit" class="primary small">ğŸ’¾ Ø­ÙØ¸</button>
          <button type="button" class="secondary small" onclick="clearAdminForm()">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        </div>
      </form>

      <table class="admin-table" id="adminTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ø¨Ù†Ùƒ / Ø§Ù„Ø´Ø±ÙƒØ©</th>
            <th>Ø§Ù„ØªÙ…ÙˆÙŠÙ„</th>
            <th>Ø§Ù„Ø¯Ø¹Ù…</th>
            <th>Ù…Ù† Ø±Ø§ØªØ¨</th>
            <th>Ø¥Ù„Ù‰ Ø±Ø§ØªØ¨</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            <th>ØªØ­ÙƒÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px; text-align:left;">
        <button class="secondary small" onclick="showPage('adminHub')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <div id="adminProductsPage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„</h2>
      <p style="font-size:13px; color:#6b7280; text-align:right;">
        Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ (Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©).
      </p>

      <form id="adminProductsForm" onsubmit="saveFinanceProduct(event)">
        <div class="admin-grid">
          <div style="grid-column:1/-1;">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„)</label>
            <input id="fpName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„" />
          </div>
          <div>
            <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="fpEnabled">
              <option value="true">Ù…ÙØ¹Ù‘Ù„</option>
              <option value="false">ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</option>
            </select>
          </div>
          <div>
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ % (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ â“)</label>
            <input id="fpDeduction" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 33 Ø£Ùˆ 45" />
          </div>
          <div style="grid-column:1/-1;">
            <label>Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="fpMessage" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹." />
          </div>
        </div>

        <input type="hidden" id="fpEditIndex" value="" />

        <div style="text-align:left; margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button type="submit" class="primary small">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button type="button" class="secondary small" onclick="clearFinanceProductForm()">Ù…Ø³Ø­</button>
        </div>
      </form>

      <table class="admin-table" id="financeProductsTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ %</th>
            <th>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù</th>
            <th>ØªØ­ÙƒÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px; text-align:left;">
        <button class="secondary small" onclick="showPage('adminHub')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <div id="adminArchivePage" class="page">
    <div class="card fade-in">
      <h2 style="margin-top:0; font-size:19px; color:#111827;">Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
      <div class="admin-grid">
        <div style="grid-column:1/-1;">
          <label>Ø¨Ø­Ø« (Ø¬ÙˆØ§Ù„ / Ø³Ø¬Ù„ Ù…Ø¯Ù†ÙŠ)</label>
          <input id="archiveSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ..." oninput="renderArchiveTable()" />
        </div>
      </div>
      <table class="admin-table" id="archiveTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…ÙØªØ§Ø­ (Ø¬ÙˆØ§Ù„/Ø³Ø¬Ù„)</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</th>
            <th>ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±Ø´Ø­</th>
            <th>ØªØ­ÙƒÙ…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:12px; text-align:left;">
        <button class="secondary small" onclick="showPage('adminHub')">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
      </div>
    </div>
  </div>

</div>

<footer>
  <div class="footer-inner">
    <div>
      Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© -  Ø³Ø±Ø¹Ø© ØªÙ…Ù„Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ© -
      <span id="datetime"></span>
      <span class="hijri-chip">Ù‡Ø¬Ø±ÙŠ: <span id="datetimeHijri"></span></span>
    </div>
    <div id="miniAdminTools" title="Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ù…Ø®ÙÙŠØ©) â€” â–«ï¸" onclick="openMiniAdminTools()">
      â–«ï¸ <span style="font-size:11px; color:#6b7280;">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<div id="miniAdminAuthModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">
  <div style="max-width:700px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900; color:#111827;">â–«ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
      <button class="secondary small" onclick="closeMiniAdminAuth()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="alert-error" style="margin-top:10px;">âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·.</div>
    <label>Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
    <input id="miniAdminPin" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" />
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="primary small" onclick="verifyMiniAdminPin()">ØªØ£ÙƒÙŠØ¯</button>
      <button class="secondary small" onclick="closeMiniAdminAuth()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div id="miniAdminPinError" class="alert-error" style="display:none; margin-top:8px;">Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.</div>
  </div>
</div>

<script>
  // ==========================================
  // 1. Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù„Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ (Ø§Ù„Ø¶Ø¨Ø§Ø· ÙˆØ§Ù„Ø£ÙØ±Ø§Ø¯)
  // ==========================================
  const MILITARY_SALARY_TABLE = {
      // Ø§Ù„Ø¶Ø¨Ø§Ø·
      "Ù…Ù„Ø§Ø²Ù…":  { inc: 380, steps: [7590,7970,8350,8730,9110,9490,9870,10250,10630,11010,11390,11770,12150,12530,12910] },
      "Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„": { inc: 440, steps: [8835,9275,9715,10155,10595,11035,11475,11915,12355,12795,13235,13675,14115,14555,14995] },
      "Ù†Ù‚ÙŠØ¨":   { inc: 495, steps: [10600,11095,11590,12085,12580,13075,13570,13835,14100,14365,14630,14895,15160,15425,15690] },
      "Ø±Ø§Ø¦Ø¯":  { inc: 265, steps: [13515,13780,14045,14310,14575,14840,15105,15370,15635,15900,16165,16430,16695,16960,17225] },
      "Ù…Ù‚Ø¯Ù…":   { inc: 470, steps: [14645,15115,15585,16055,16525,16995,17465,17935,18405,18875,19345,19815,20285,20755] },
      "Ø¹Ù‚ÙŠØ¯":   { inc: 590, steps: [16520,17110,17700,18290,18880,19470,20060,20650,21240,21830,22420,23010,23600] },
      "Ø¹Ù…ÙŠØ¯":   { inc: 650, steps: [18800,19450,20100,20750,21400,22050,22700,23350,24000,24650,25300,25950] },
      "Ù„ÙˆØ§Ø¡":    { inc: 730, steps: [21390,22120,22850,23580,24310,25040,25770,26500,27230,27960,28690] },
      // Ø§Ù„Ø£ÙØ±Ø§Ø¯
      "Ø¬Ù†Ø¯ÙŠ":   { inc: 130, steps: [3220,3350,3480,3610,3740,3870,4000,4130,4260,4390,4520,4650,4780,4910,5040] },
      "Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„":  { inc: 145, steps: [3395,3540,3685,3830,3975,4120,4265,4410,4555,4700,4845,4990,5135,5280,5425] },
      "Ø¹Ø±ÙŠÙ":   { inc: 175, steps: [3765,3940,4115,4290,4465,4640,4815,4990,5165,5340,5515,5690,5865,6040,6215] },
      "ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨":   { inc: 210, steps: [4455,4665,4875,5085,5295,5505,5715,5925,6135,6345,6555,6765,6975,7185,7395] },
      "Ø±Ù‚ÙŠØ¨":   { inc: 250, steps: [5260,5510,5760,6010,6260,6510,6760,7010,7260,7510,7760,8010,8260,8510,8760] },
      "Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„":  { inc: 300, steps: [6180,6480,6780,7080,7380,7680,7980,8280,8580,8880,9180,9480,9780,10080,10380] },
      "Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡":  { inc: 360, steps: [7215,7575,7935,8295,8655,9015,9375,9735,10095,10455,10815,11175,11535,11895,12255] }
  };

  function showPage(name) {
    ['landing','calculator','result','adminLogin','adminHub','admin','adminProducts','adminArchive','comingSoon'].forEach(id => {
      const el = document.getElementById(id + 'Page');
      if (!el) return;
      el.classList.toggle('active', id === name);
    });
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    if(name === 'admin') updateAdminFinanceTypeOptions();
  }

  function backToLanding() { showPage('landing'); }
  function startClientFlow() { showPage('calculator'); resetCalc(); }
  function backToFinanceType(){
    showPage('calculator'); hasStarted = true;
    const idx = generalQuestions.findIndex(q => q.id === 'financeType');
    step = idx >= 0 ? idx : 0; commitmentStep = 0; currentCommitment = {};
    document.getElementById('mainButton').style.display = 'none';
    document.getElementById('resetButtonContainer').style.display = 'block';
    document.getElementById('nextButton').style.display = 'inline-flex';
    showQuestion();
  }

  const bankLogoMap = {
    'Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ': 'img/alrajhi.png', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ': 'img/alahli.png', 'Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶': 'img/riyad.png',
    'Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯': 'img/bilad.png', 'Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©': 'img/jazira.png', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ': 'img/bsf.png',
    'Ø¨Ù†Ùƒ Ø³Ø§Ø¨': 'img/sab.png', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ': 'img/anb.png', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±': 'img/saib.png'
  };

  let bankConfigs = [];
  function loadBankConfigs() {
    try {
      const saved = localStorage.getItem('stBankConfigs');
      bankConfigs = saved ? JSON.parse(saved) : [];
    } catch (e) { bankConfigs = []; }
    renderBankTable();
  }
  function saveBankConfigs() { localStorage.setItem('stBankConfigs', JSON.stringify(bankConfigs)); }

  function renderBankTable() {
    const tbody = document.querySelector('#adminTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    bankConfigs.forEach((cfg, index) => {
      let fName = getFinanceProductNameById(cfg.financeType) || cfg.financeType;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${cfg.bankName || ''}</td>
        <td>${fName}</td>
        <td>${cfg.supportedType || ''}</td>
        <td>${(cfg.minSalary || 0).toLocaleString()}</td>
        <td>${(cfg.maxSalary || 0).toLocaleString()}</td>
        <td>${cfg.margin}</td>
        <td style="color:#d97706; font-size:11px;">${cfg.note || ''}</td> <td>
          <button class="btn small secondary" onclick="editBankConfig(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small secondary" onclick="deleteBankConfig(${index})">Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function clearAdminForm() {
    document.getElementById('adminBankName').value = '';
    document.getElementById('adminSupportedType').value = 'Ø§Ù„ÙƒÙ„';
    document.getElementById('adminMinSalary').value = '';
    document.getElementById('adminMaxSalary').value = '';
    document.getElementById('adminMargin').value = '';
    document.getElementById('adminNote').value = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    document.getElementById('adminJobType').value = '';
    document.getElementById('adminMinMonths').value = '';
    document.getElementById('adminMaxMonths').value = '';
    document.getElementById('adminProductDetail').value = '';
    document.getElementById('adminEtezaaz').value = '';
    document.getElementById('adminEditIndex').value = '';
  }

  function saveBankConfig(e) {
    e.preventDefault();
    const bankName = document.getElementById('adminBankName').value;
    const financeType = document.getElementById('adminFinanceType').value;
    const supportedType = document.getElementById('adminSupportedType').value;
    const minSalary = parseFloat(document.getElementById('adminMinSalary').value || '0');
    const maxSalary = parseFloat(document.getElementById('adminMaxSalary').value || '0');
    const margin = parseFloat(document.getElementById('adminMargin').value || '0');
    const note = document.getElementById('adminNote').value; // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    const jobType = document.getElementById('adminJobType').value;
    const minMonths = parseInt(document.getElementById('adminMinMonths').value || '0');
    const maxMonths = parseInt(document.getElementById('adminMaxMonths').value || '0');
    const productDetail = document.getElementById('adminProductDetail').value;
    const etezaaz = document.getElementById('adminEtezaaz').value;
    const editIndex = document.getElementById('adminEditIndex').value;

    if (!bankName || !margin || !minSalary || !maxSalary) { alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.'); return; }
    
    const cfg = { bankName, financeType, supportedType, minSalary, maxSalary, margin, note };
    if (jobType) cfg.jobType = jobType;
    if (minMonths) cfg.minMonths = minMonths;
    if (maxMonths) cfg.maxMonths = maxMonths;
    if (productDetail) cfg.productDetail = productDetail;
    if (etezaaz) cfg.etezaaz = etezaaz;

    if (editIndex === '') bankConfigs.push(cfg);
    else bankConfigs[parseInt(editIndex)] = cfg;

    saveBankConfigs();
    renderBankTable();
    clearAdminForm();
  }

  function editBankConfig(index) {
    const cfg = bankConfigs[index];
    document.getElementById('adminBankName').value = cfg.bankName || '';
    document.getElementById('adminFinanceType').value = cfg.financeType || '';
    document.getElementById('adminSupportedType').value = cfg.supportedType || 'Ø§Ù„ÙƒÙ„';
    document.getElementById('adminMinSalary').value = cfg.minSalary || '';
    document.getElementById('adminMaxSalary').value = cfg.maxSalary || '';
    document.getElementById('adminMargin').value = cfg.margin || '';
    document.getElementById('adminNote').value = cfg.note || ''; // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    document.getElementById('adminJobType').value = cfg.jobType || '';
    document.getElementById('adminMinMonths').value = cfg.minMonths || '';
    document.getElementById('adminMaxMonths').value = cfg.maxMonths || '';
    document.getElementById('adminProductDetail').value = cfg.productDetail || '';
    document.getElementById('adminEtezaaz').value = cfg.etezaaz || '';
    document.getElementById('adminEditIndex').value = index;
  }

  function deleteBankConfig(index) {
    if (!confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ')) return;
    bankConfigs.splice(index, 1);
    saveBankConfigs();
    renderBankTable();
  }

  function getMatchingBanksForAnswers() {
    const salary = parseFloat(answers.salary || '0');
    if (!salary) return [];
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const selectedProduct = findFinanceProduct(answers.financeType);
    let fType = answers.financeType; // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

    const supp = answers.supported || 'Ø§Ù„ÙƒÙ„';
    const jobType = answers.jobType || '';
    const months = parseInt(answers.months || '0');
    const mortgageDetail = answers.mortgageProductType || '';
    const wantsEtezaaz = (answers.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') && answers.supported === 'Ù…Ø¯Ø¹ÙˆÙ…' && answers.isEtezaaz === 'Ù†Ø¹Ù…');
    
    const list = bankConfigs.filter(cfg => {
      // Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø±Ù†Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±
      if (cfg.financeType !== fType) return false;
      if (!(salary >= cfg.minSalary && salary <= cfg.maxSalary)) return false;
      if (!(cfg.supportedType === 'Ø§Ù„ÙƒÙ„' || cfg.supportedType === supp)) return false;
      if (cfg.jobType && jobType && cfg.jobType !== jobType) return false;
      if (cfg.minMonths && months && months < cfg.minMonths) return false;
      if (cfg.maxMonths && months && months > cfg.maxMonths) return false;
      if (cfg.productDetail && mortgageDetail && cfg.productDetail !== mortgageDetail) return false;
      if (wantsEtezaaz && cfg.etezaaz && cfg.etezaaz !== 'Ù†Ø¹Ù…') return false;
      return true;
    });
    list.sort((a,b)=> a.margin - b.margin);
    return list;
  }

  const ADMIN_PIN = '11qq11qQ@';
  function handleAdminLogin() {
    const pin = document.getElementById('adminPin').value;
    const err = document.getElementById('adminLoginError');
    if (pin === ADMIN_PIN) {
      err.style.display = 'none';
      showPage('adminHub');
      renderArchiveTable();
      renderFinanceProductsTable();
    } else {
      err.style.display = 'block';
    }
  }

  function openMiniAdminTools(){
    document.getElementById('miniAdminPin').value = '';
    document.getElementById('miniAdminPinError').style.display = 'none';
    document.getElementById('miniAdminAuthModal').style.display = 'block';
  }
  function closeMiniAdminAuth(){ document.getElementById('miniAdminAuthModal').style.display = 'none'; }
  function verifyMiniAdminPin(){
    const pin = document.getElementById('miniAdminPin').value;
    if(pin === ADMIN_PIN){
      document.getElementById('miniAdminAuthModal').style.display = 'none';
      showPage('adminLogin'); // Ù†Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø± Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
    } else {
      document.getElementById('miniAdminPinError').style.display = 'block';
    }
  }

  // ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ======
  const FIN_PRODUCTS_KEY = 'stFinanceProducts';
  let financeProducts = [];
  function getDefaultFinanceProducts(){
    // Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø¹ Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹
    return [
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ', enabled:true, deductionRatio: 33 },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', enabled:true, deductionRatio: 60 },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±ÙŠ', enabled:true, deductionRatio: 33 },
      { name:'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ', enabled:true, deductionRatio: 33 },
      { name:'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ', enabled:true, deductionRatio: 33 },
      { name:'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', enabled:false, deductionRatio: 60, message:'Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø±ÙŠØ¨Ø§Ù‹' },
      { name:'Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù†', enabled:false, deductionRatio: 33, message:'Ù‚Ø±ÙŠØ¨Ø§Ù‹' }
    ];
  }

  function loadFinanceProducts(){
    try{
      const s = localStorage.getItem(FIN_PRODUCTS_KEY);
      financeProducts = s ? JSON.parse(s) : getDefaultFinanceProducts();
    }catch(e){ financeProducts = getDefaultFinanceProducts(); }
  }
  function saveFinanceProducts(){ localStorage.setItem(FIN_PRODUCTS_KEY, JSON.stringify(financeProducts)); }
  function getFinanceProductNames(){ return financeProducts.filter(p=>p.enabled).map(x=>x.name); }
  function findFinanceProduct(name){ return financeProducts.find(x=>x.name===name) || null; }
  function isFinanceProductEnabled(name){ const p = findFinanceProduct(name); return p ? p.enabled : true; }
  function getFinanceProductMessage(name){ const p = findFinanceProduct(name); return p ? p.message : ''; }
  
  // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
  function getFinanceProductNameById(name) { return name; }

  function updateAdminFinanceTypeOptions() {
    const sel = document.getElementById('adminFinanceType');
    sel.innerHTML = '';
    financeProducts.forEach(p => {
       const opt = document.createElement('option');
       opt.value = p.name;
       opt.text = p.name;
       sel.appendChild(opt);
    });
  }

  function clearFinanceProductForm(){
    document.getElementById('fpName').value = '';
    document.getElementById('fpEnabled').value = 'true';
    document.getElementById('fpDeduction').value = '';
    document.getElementById('fpMessage').value = '';
    document.getElementById('fpEditIndex').value = '';
  }

  function saveFinanceProduct(e){
    e.preventDefault();
    const name = (document.getElementById('fpName').value || '').trim();
    const enabled = (document.getElementById('fpEnabled').value === 'true');
    const deduction = parseFloat(document.getElementById('fpDeduction').value);
    const message = (document.getElementById('fpMessage').value || '').trim();
    const editIndex = document.getElementById('fpEditIndex').value;

    if(!name){ alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.'); return; }
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù†Ø³Ø¨Ø©ØŒ Ù†Ø¶Ø¹ 33 ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
    const finalDeduction = isNaN(deduction) ? 33 : deduction;

    const item = { name, enabled, deductionRatio: finalDeduction, message };
    if(editIndex === ''){
      if(financeProducts.some(x=>x.name===name)){ alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.'); return; }
      financeProducts.push(item);
    } else {
      financeProducts[parseInt(editIndex)] = item;
    }
    saveFinanceProducts();
    renderFinanceProductsTable();
    clearFinanceProductForm();
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¶Ø§ÙØ© Ù†Ø³Ø¨ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø¨".');
  }

  function renderFinanceProductsTable(){
    const tbody = document.querySelector('#financeProductsTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    financeProducts.forEach((p, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.enabled ? 'Ù…ÙØ¹Ù‘Ù„' : 'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'}</td>
        <td>${p.deductionRatio || 33}%</td>
        <td style="text-align:right;">${p.message || ''}</td>
        <td>
          <button class="btn small secondary" onclick="editFinanceProduct(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small secondary" onclick="deleteFinanceProduct(${idx})">Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function editFinanceProduct(idx){
    const p = financeProducts[idx];
    document.getElementById('fpName').value = p.name;
    document.getElementById('fpEnabled').value = p.enabled ? 'true' : 'false';
    document.getElementById('fpDeduction').value = p.deductionRatio || '';
    document.getElementById('fpMessage').value = p.message || '';
    document.getElementById('fpEditIndex').value = idx;
  }
  function deleteFinanceProduct(idx){
    if(!confirm('Ø­Ø°ÙØŸ')) return;
    financeProducts.splice(idx, 1);
    saveFinanceProducts();
    renderFinanceProductsTable();
  }

  // ====== Ø£Ø±Ø´ÙŠÙ ======
  function loadArchive(){ try{ return JSON.parse(localStorage.getItem('stClientArchive')||'[]'); }catch{ return []; } }
  function saveArchive(list){ localStorage.setItem('stClientArchive', JSON.stringify(list)); }
  function saveCurrentResultToArchive(){
    const lc = answers._lastCalc;
    if(!lc) return;
    const list = loadArchive();
    list.unshift({
      id: Date.now(),
      key: lc.clientName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', // Ù…ÙØªØ§Ø­ Ø¨Ø³ÙŠØ·
      clientName: lc.clientName,
      financeType: lc.financeType,
      calcDateTimeStr: lc.calcDateTimeStr,
      recommendedBankName: lc.recommendedBankName
    });
    saveArchive(list);
  }
  function renderArchiveTable(){
    const q = (document.getElementById('archiveSearch')?.value || '').trim();
    const list = loadArchive().filter(r => !q || String(r.clientName).includes(q) || String(r.key).includes(q));
    const tbody = document.querySelector('#archiveTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    list.forEach(r => {
        tbody.innerHTML += `<tr>
            <td>${r.id}</td><td>${r.clientName}</td><td>${r.financeType}</td><td>${r.calcDateTimeStr}</td><td>${r.recommendedBankName}</td>
            <td><button class="btn small secondary" onclick="alert('ØªÙØ§ØµÙŠÙ„...')">Ø¹Ø±Ø¶</button></td>
        </tr>`;
    });
  }

  // ====== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ======
  function getHijriNowParts(){ return {y:1446, m:1, d:1}; } // ØªØ¨Ø³ÙŠØ·
  function getHijriNowDisplay(){ return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura').format(new Date()); }
  function updateDateTime(){
     const now = new Date();
     document.getElementById('datetime').textContent = now.toLocaleString('ar-SA');
     document.getElementById('datetimeHijri').textContent = getHijriNowDisplay();
  }

  // ==========================================
  // 2. Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ù…ØªØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  // ==========================================
  function calculateDetailedMilitaryPension(rank, currentBasic, appointYear, appointMonth, appointDay) {
      const rankData = MILITARY_SALARY_TABLE[rank];
      if (!rankData) return 0;

      // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
      // Ù†Ø£Ø®Ø° Ø£Ù‚Ø±Ø¨ Ø±Ø§ØªØ¨ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ³Ø§ÙˆÙŠ Ø£Ùˆ ÙŠÙ‚Ù„ Ø¹Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…Ø¯Ø®Ù„
      let currentStepIndex = 0;
      let minDiff = Infinity;
      rankData.steps.forEach((step, idx) => {
          const diff = Math.abs(step - currentBasic);
          if (diff < minDiff) {
              minDiff = diff;
              currentStepIndex = idx;
          }
      });
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø£ÙƒØ¨Ø± Ù…Ù† Ø¢Ø®Ø± Ù…Ø±Ø¨ÙˆØ·ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø£Ø®ÙŠØ±
      if (currentBasic > rankData.steps[rankData.steps.length - 1]) {
          currentStepIndex = rankData.steps.length - 1;
      }

      // 2. Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ø¨Ù„ÙˆØº Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø£Ùˆ 35 Ø³Ù†Ø© Ø®Ø¯Ù…Ø© Ø£ÙŠÙ‡Ù…Ø§ Ø£Ù‚Ø±Ø¨ Ù„Ù„Ù†Ø¸Ø§Ù…ØŒ Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø·Ù„Ø¨Ùƒ: Ø¨Ù„ÙˆØº Ø§Ù„Ø³ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„ØªÙ…ÙˆÙŠÙ„)
      // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± Ã— Ø£Ø´Ù‡Ø± Ø§Ù„Ø®Ø¯Ù…Ø©) Ã· 420
      // Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³ÙŠØªÙ‚Ø§Ø¹Ø¯ Ø¨Ù†Ù‡Ø§ÙŠØ© ÙØªØ±Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø£Ùˆ Ø¹Ù†Ø¯ Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ø±Ø¨) Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ ÙˆÙ‚ØªÙ‡Ø§
      
      const now = new Date(); // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ
      const currentYearH = 1446; // ØªÙ‚Ø±ÙŠØ¨ÙŠ
      
      // ÙƒÙ… Ø³Ù†Ø© Ø³ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­ØªÙ‰ ÙŠØªÙ‚Ø§Ø¹Ø¯ØŸ
      // Ù‡Ù†Ø§ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ÙŠØ·Ù„Ø¨Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªÙ…ÙˆÙŠÙ„ Ù„Ù…Ø¹Ø±ÙØ© Ø±Ø§ØªØ¨Ù‡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø© (ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
      // Ø£Ùˆ Ù†Ø­Ø³Ø¨ Ù…ØªÙ‰ ÙŠØµÙ„ Ù„Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯. 
      // Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ: Ø³Ù†Ø­Ø³Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ "ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯".
      
      // Ø³Ù†Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ Ù„Ù„Ø±ØªØ¨Ø© Ø£Ùˆ 60 Ø³Ù†Ø©
      // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
      // Ù„ÙƒÙ†ØŒ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© ØªØ·Ù„Ø¨: Ø±Ø§ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ Ø£Ø®ÙŠØ±.
      // Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± = Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ + (Ø§Ù„Ø¹Ù„Ø§ÙˆØ© Ã— Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©)
      
      // Ø³Ù†Ø­Ø³Ø¨ Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: (Ù…Ù† Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯)
      const serviceYearsTotal = (currentYearH - appointYear); // Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
      // Ù„Ù†ÙØªØ±Ø¶ Ø£Ù†Ù†Ø§ Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ "Ø§Ù„Ø¢Ù†" Ø¥Ø°Ø§ ØªÙ‚Ø§Ø¹Ø¯ØŒ Ø£Ùˆ "Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹".
      // Ø·Ù„Ø¨Ùƒ: "Ø§Ø¸Ù‡Ø± Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡ ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ù‡ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©".
      // Ø³Ù†Ø­Ø³Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø© (Ø¨Ù„ÙˆØº Ø§Ù„Ø³Ù†).
      
      // Ù„Ù†Ø­Ø³Ø¨ ÙƒÙ… Ø³Ù†Ø© Ø¨Ø§Ù‚ÙŠ Ù„Ù‡ Ø­ØªÙ‰ ÙŠÙˆØµÙ„ Ø¢Ø®Ø± Ù…Ø±Ø¨ÙˆØ· Ø£Ùˆ ÙŠØªÙ‚Ø§Ø¹Ø¯
      // Ø³Ù†ÙØªØ±Ø¶ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®Ø¯Ù…Ø© 35 Ø³Ù†Ø© (420 Ø´Ù‡Ø±) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø±Ø§ØªØ¨
      
      // Ø§Ù„Ø­Ø³Ø¨Ø©:
      // 1. ÙƒÙ… Ø´Ù‡Ø± Ø®Ø¯Ù…Ø© Ù„Ø¯ÙŠÙ‡ Ø§Ù„Ø¢Ù†ØŸ
      const serviceMonthsNow = ((currentYearH - appointYear) * 12) + (1 - appointMonth); // ØªÙ‚Ø±ÙŠØ¨ÙŠ
      
      // 2. ÙƒÙ… Ø¨Ø§Ù‚ÙŠ Ù„Ù‡ Ù„Ø³Ù† Ø§Ù„Ø³ØªÙŠÙ†ØŸ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ¯Ø®Ù„ Ø¹Ù…Ø±Ù‡ØŒ Ù„ÙƒÙ† Ø£Ø¯Ø®Ù„ Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
      // Ø³Ù†Ø³ØªØ®Ø¯Ù… answers.birthYear
      const birthYear = parseInt(answers.birthYear || '1400');
      const yearTurn60 = birthYear + 60;
      const yearsRemaining = yearTurn60 - currentYearH;
      
      // Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø¨Ø¹Ø¯ yearsRemaining Ø¹Ù„Ø§ÙˆØ©)
      let futureStepIndex = currentStepIndex + yearsRemaining;
      if (futureStepIndex >= rankData.steps.length) futureStepIndex = rankData.steps.length - 1;
      
      const lastBasicSalary = rankData.steps[futureStepIndex];
      
      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø´Ù‡Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø¹Ù†Ø¯ Ø³Ù† Ø§Ù„Ø³ØªÙŠÙ†
      const totalServiceMonthsAt60 = serviceMonthsNow + (yearsRemaining * 12);
      
      // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯: (Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± Ã— Ø¹Ø¯Ø¯ Ø£Ø´Ù‡Ø± Ø§Ù„Ø®Ø¯Ù…Ø©) / 420
      let pension = (lastBasicSalary * totalServiceMonthsAt60) / 420;
      
      // Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø£Ø®ÙŠØ±
      if (pension > lastBasicSalary) pension = lastBasicSalary;
      
      return pension;
  }


  // ====== Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ======
  let answers = { commitments: [] }, step = 0, commitmentStep = 0, currentCommitment = {};
  let hasStarted = false;

  const generalQuestions = [
    { id:'clientName',label:'ØªØ¹Ø±ÙÙ†Ø§ Ø¨Ø£Ø³Ù…Ùƒ  ',type:'text' },
    { id:'birthYear',label:'Ø§Ø®ØªØ± Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù‡Ø¬Ø±ÙŠ:',type:'select',options:Array.from({length:61},(_,i)=>1430 - i),default:1412 },
    { id:'jobType',label:'Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©',type:'select',options:['Ø¹Ø³ÙƒØ±ÙŠ','Ù…Ø¯Ù†ÙŠ (Ù‚Ø·Ø§Ø¹ Ø­ÙƒÙˆÙ…ÙŠ)','Ø®Ø§Øµ (Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ)','Ø®Ø§Øµ (Ø´Ø±ÙƒØ© Ù…Ø¹ØªÙ…Ø¯Ø©)','Ø®Ø§Øµ (Ø´Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©)'] },
    {
      id:'militaryRank', label:'Ø§Ø°ÙƒØ± Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©', type:'select',
      options:['Ø¬Ù†Ø¯ÙŠ','Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„','Ø¹Ø±ÙŠÙ','ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨','Ø±Ù‚ÙŠØ¨','Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„','Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡','Ù…Ù„Ø§Ø²Ù…','Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„','Ù†Ù‚ÙŠØ¨','Ø±Ø§Ø¦Ø¯','Ù…Ù‚Ø¯Ù…','Ø¹Ù‚ÙŠØ¯','Ø¹Ù…ÙŠØ¯','Ù„ÙˆØ§Ø¡'],
      show:a=>a.jobType==='Ø¹Ø³ÙƒØ±ÙŠ'
    },
    {
      id:'financeType', label:'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ØªØ±ÙŠØ¯ Ø­Ø³Ø¨ØªÙ‡:', type:'select',
      options:[] // Ø³ØªØ¹Ø¨Ø£ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    },
    { id:'mortgageProductType', label:'Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ', type:'select', options:['ÙˆØ­Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚','Ø¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ','Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø®Ø§Ø±Ø·Ø©','ØªØ­Øª Ø§Ù„Ø§Ù†Ø´Ø§Ø¡ (Ø¨ÙŠØª ØªÙ…Ù„ÙƒÙ‡ Ø¹Ø¸Ù…)','Ø§Ø±Ø¶ ÙˆÙ‚Ø±Ø¶ (Ø§Ø±Ø¶ ÙˆØ¨Ù†Ø§Ø¡ Ø°Ø§ØªÙŠ)','Ø§Ø±Ø¶ (Ø³ÙƒÙ†ÙŠØ©)','Ø±Ù‡Ù†'], show:a=>a.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') },
    { id:'supported', label:'Ù‡Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ø¯Ø¹ÙˆÙ…ØŸ', type:'select', options:['Ù…Ø¯Ø¹ÙˆÙ…','ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'], show:a=>a.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') },
    { id:'isEtezaaz', label:'Ù‡Ù„ Ø£Ù†Øª Ù…Ù† Ù…Ù†Ø³ÙˆØ¨ÙŠ ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¯ÙØ§Ø¹ (Ù…Ø¤Ù‡Ù„ Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ø¹ØªØ²Ø§Ø²)ØŸ', type:'select', options:['Ù†Ø¹Ù…','Ù„Ø§'], show:a=>a.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') && a.supported==='Ù…Ø¯Ø¹ÙˆÙ…' && a.jobType==='Ø¹Ø³ÙƒØ±ÙŠ' },
    { id:'salary', label:'ÙƒÙ… Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØµØ§ÙÙŠØŸ', type:'number' },
    
    // === Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù…ØªØ¯ Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ ===
    {
      id:'extendAfterRetirement', label:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù…ØªØ¯ (Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯)ØŸ', type:'select', options:['Ù†Ø¹Ù…','Ù„Ø§'],
      show:a=> a.jobType==='Ø¹Ø³ÙƒØ±ÙŠ' && (a.financeType.includes('Ø´Ø®ØµÙŠ') || a.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') || a.financeType.includes('ØªØ£Ø¬ÙŠØ±'))
    },
    // === Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù…ØªØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„ØªØ¹ÙŠÙŠÙ†) ===
    { 
        id:'currentBasicSalary', label:'ÙƒÙ… Ø±Ø§ØªØ¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù„Ø§Øª)ØŸ', type:'number', 
        show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' 
    },
    { 
        id:'appointYear', label:'Ø³Ù†Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ):', type:'number', placeholder:'Ù…Ø«Ù„Ø§Ù‹ 1435',
        show:a=>a.extendAfterRetirement==='Ù†Ø¹Ù…' 
    },
    
    { id:'months', label:'Ø¹Ù„Ù‰ ÙƒÙ… Ø´Ù‡Ø± ØªØ±ÙŠØ¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ØŸ', type:'select', options:[], dynamic:true },
    { id:'calcMode', label:'ÙƒÙŠÙ ØªÙØ¶Ù‘Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø³Ø¨Ø©ØŸ', type:'select', options:['Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨Ù†ÙØ³ÙŠ','ØªØ±Ø´ÙŠØ­ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'] },
    { id:'profitMargin', label:'Ù†Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ (%)ØŸ', type:'number' },
    { id:'hasCommitments', label:'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŸ', type:'select', options:['Ù†Ø¹Ù…','Ù„Ø§'] }
  ];

  const commitmentQuestions = [
    { id:'type',label:'Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…',type:'select',options:['Ù‚Ø±Ø¶ Ø´Ø®ØµÙŠ','Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©','Ù‚Ø±Ø¶ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ','Ù‚Ø±Ø¶ Ø¹Ù‚Ø§Ø±ÙŠ'] },
    { id:'amount',label:'ÙƒÙ… Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØŸ',type:'number' },
    { id:'months',label:'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©ØŸ',type:'number' },
    { id:'more',label:'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø£Ø®Ø±Ù‰ØŸ',type:'select',options:['Ù†Ø¹Ù…','Ù„Ø§'] }
  ];

  function showQuestion(){
    const cont = document.getElementById('question');
    cont.innerHTML = '';
    let q;
    if(step < generalQuestions.length){
      q = generalQuestions[step];
      if(q.id === 'financeType') q.options = getFinanceProductNames();
      if(q.show && !q.show(answers)){ step++; showQuestion(); return; }
      
      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      if(q.id === 'salary' && !isFinanceProductEnabled(answers.financeType)){
          showComingSoonForProduct(answers.financeType); return;
      }
      
      if(q.id === 'profitMargin' && answers.calcMode === 'ØªØ±Ø´ÙŠØ­ Ø¨Ù†Ùƒ Ù…Ù†Ø§Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'){
         // ... (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø´ÙŠØ­ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
         const list = getMatchingBanksForAnswers();
         if(list[0]) { answers.profitMargin = list[0].margin; step++; showQuestion(); return; }
      }
    } else if(answers.hasCommitments === 'Ù†Ø¹Ù…'){
      q = commitmentQuestions[commitmentStep];
    } else {
      document.getElementById('nextButton').style.display = 'none';
      calculate(); return;
    }

    const div = document.createElement('div');
    div.classList.add('fade-in');
    div.innerHTML = `<label>${q.label}</label>`;
    if(q.type === 'select'){
      const sel = document.createElement('select'); sel.id = q.id;
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>';
      if(q.dynamic && q.id === 'months'){
         // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø¨Ø³ÙŠØ· (60 Ù„Ù„Ø´Ø®ØµÙŠØŒ 300 Ù„Ù„Ø¹Ù‚Ø§Ø±ÙŠØŒ Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø±)
         let limit = answers.financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') ? 300 : 60;
         for(let i=12; i<=limit; i+=12) sel.innerHTML += `<option value="${i}">${i} Ø´Ù‡Ø± (${i/12} Ø³Ù†Ø©)</option>`;
      } else {
         q.options.forEach(o => sel.innerHTML += `<option value="${o}">${o}</option>`);
      }
      div.appendChild(sel);
    } else {
      div.innerHTML += `<input type="${q.type}" id="${q.id}" placeholder="${q.placeholder||''}">`;
    }
    cont.appendChild(div);
  }

  function nextQuestion(){
    const q = step < generalQuestions.length ? generalQuestions[step] : commitmentQuestions[commitmentStep];
    const val = document.getElementById(q.id).value;
    if(!val){ alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©'); return; }
    
    if(step < generalQuestions.length){
      answers[q.id] = val;
      step++;
    } else {
      if(q.id === 'more'){
        if(val === 'Ù†Ø¹Ù…') { commitmentStep = 0; }
        else { document.getElementById('nextButton').style.display = 'none'; calculate(); return; }
      } else {
        currentCommitment[q.id] = val;
        commitmentStep++;
      }
    }
    showQuestion();
  }

  function showComingSoonForProduct(name){
      const msg = getFinanceProductMessage(name) || 'Ù‚Ø±ÙŠØ¨Ø§Ù‹';
      document.getElementById('comingSoonText').innerText = msg;
      showPage('comingSoon');
  }

  // ====== Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ======
  function calculate(){
    const salary = parseFloat(answers.salary);
    const months = parseInt(answers.months);
    const profitMargin = parseFloat(answers.profitMargin);
    const financeType = answers.financeType;
    
    // 1. ØªØ­Ø¯ÙŠØ¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ (Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬)
    const productConfig = findFinanceProduct(financeType);
    let deductionRatio = (productConfig && productConfig.deductionRatio) ? productConfig.deductionRatio : 33; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 33
    // Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ù‚Ø¯ ÙŠÙƒÙˆÙ† 65
    if(financeType.includes('Ø¹Ù‚Ø§Ø±ÙŠ') && answers.supported === 'Ù…Ø¯Ø¹ÙˆÙ…') deductionRatio = 65;

    // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ù…ØªØ¯ (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    let pensionSalary = 0;
    let isExtended = (answers.extendAfterRetirement === 'Ù†Ø¹Ù…');
    if(isExtended) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        pensionSalary = calculateDetailedMilitaryPension(
            answers.militaryRank, 
            parseFloat(answers.currentBasicSalary), 
            parseInt(answers.appointYear), 
            1, 1
        );
    }

    // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù‚Ø³Ø·
    // Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯
    const maxInstPre = (salary * deductionRatio / 100);
    // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù„Ù„Ù…Ù…ØªØ¯)
    const maxInstPost = isExtended ? (pensionSalary * deductionRatio / 100) : maxInstPre; 

    // Ø®ØµÙ… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    const totalCommitments = (answers.commitments||[]).reduce((s,c)=>s+parseFloat(c.amount||0),0);
    const netInstPre = maxInstPre - totalCommitments;
    
    if(netInstPre <= 0) {
        alert('Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­.'); showPage('landing'); return;
    }

    // 4. Ø§Ù„ØªÙ…ÙˆÙŠÙ„
    // Ù…Ø¹Ø§Ø¯Ù„Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: Ø§Ù„Ù‚Ø±Ø¶ = Ø§Ù„Ù‚Ø³Ø· * Ø§Ù„Ù…Ø¯Ø© / (1 + (Ø§Ù„Ù†Ø³Ø¨Ø© * Ø§Ù„Ø³Ù†ÙˆØ§Øª))
    const years = months / 12;
    const rateFactor = (profitMargin / 100) * years;
    
    // Ù„Ù„Ù…Ù…ØªØ¯ØŒ Ø§Ù„Ø­Ø³Ø¨Ø© Ù…Ø¹Ù‚Ø¯Ø© (Ù‚Ø³Ø·ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†)ØŒ Ù‡Ù†Ø§ Ø³Ù†Ø¨Ø³Ø·Ù‡Ø§ Ø¨Ø£Ø®Ø° Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ù…Ø§Ù† Ø£Ùˆ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
    // Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ: "ØªÙ‚ÙˆÙ„ Ù†Ø³Ø¨Ø© Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ Ù…Ø«Ù„Ø§ 33% Ø®Ù„ Ø§Ù„Ù…Ø³ÙˆÙˆÙ„ ÙŠØ³Ø¬Ù„ ÙˆØ§Ø°Ø§ Ø³ÙˆØ§ Ø­ÙØ¸ Ø§Ø¹ØªÙ…Ø¯Ù‡Ø§"
    
    const loanAmount = (netInstPre * months) / (1 + rateFactor);
    const totalAmount = loanAmount * (1 + rateFactor);
    const totalProfit = totalAmount - loanAmount;

    // Ø§Ù„Ø¹Ø±Ø¶
    showResult(loanAmount, totalAmount, totalProfit, netInstPre, profitMargin, pensionSalary);
  }

  function showResult(loan, total, profit, inst, margin, pension) {
      showPage('result');
      const card = document.getElementById('resultCard');
      const bank = answers.recommendedBank || {bankName: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', note: ''}; // Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±Ø´Ø­
      
      let html = `
        <h2 style="margin:0 0 6px; font-size:18px; text-align:right;">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø¨Ø©</h2>
        <div class="result-header">
            <div class="client-chip">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${answers.clientName || ''}</div>
            <div class="badge-mode">${answers.financeType}</div>
        </div>
      `;
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†Ùƒ Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
      if(bank.bankName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
          html += `
          <div class="bank-card">
            <div class="bank-logo"><img src="${bankLogoMap[bank.bankName]||''}" alt="bank"></div>
            <div>
                <div class="bank-text-main">${bank.bankName}</div>
                <div class="bank-text-sub">Ø§Ù„Ù†Ø³Ø¨Ø©: ${margin}% 
                   ${bank.note ? `<span class="promo-note">${bank.note}</span>` : ''}
                </div>
            </div>
          </div>`;
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      html += `
        <div class="result-main-block">
            <div class="result-main-title">Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ</div>
            <div class="result-amount-main">${Math.round(loan).toLocaleString()} Ø±ÙŠØ§Ù„</div>
            
            <div class="dual-main-grid">
                <div class="dual-box">
                    <div class="dual-box-title">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
                    <div class="dual-box-amount">${Math.round(inst).toLocaleString()}</div>
                </div>
                <div class="dual-box">
                    <div class="dual-box-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¯Ø§Ø¯</div>
                    <div class="dual-box-amount">${Math.round(total).toLocaleString()}</div>
                </div>
            </div>
            
            ${pension > 0 ? `
            <div class="notice-soft">
                <strong>Ø­Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ù…ØªØ¯:</strong><br>
                Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±ØªØ¨Ø© (${answers.militaryRank}) ÙˆØ³Ù†Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† (${answers.appointYear})<br>
                Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©: <strong>${Math.round(pension).toLocaleString()} Ø±ÙŠØ§Ù„</strong>
            </div>` : ''}
        </div>
      `;
      
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
      answers._lastResult = { loan, inst, bank: bank.bankName, margin, note: bank.note };

      card.innerHTML = html;
      saveCurrentResultToArchive(); // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  }

  // ÙˆØ§ØªØ³Ø§Ø¨
  function shareResultOnWhatsAppWithDetails() {
      const r = answers._lastResult;
      if(!r) return;
      const text = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… Ù…ÙˆØ¬Ù‡ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©
Ù…Ø´Ø§Ø±Ùƒ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø©:
Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„: ${answers.financeType}
Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±Ø´Ø­: ${r.bank}
Ø§Ù„Ù†Ø³Ø¨Ø©: ${r.margin}% ${r.note ? `(${r.note})` : ''}
Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ…ÙˆÙŠÙ„: ${Math.round(r.loan).toLocaleString()} Ø±ÙŠØ§Ù„
Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ: ${Math.round(r.inst).toLocaleString()} Ø±ÙŠØ§Ù„`;
      
      const phone = "966506214458"; // Ø±Ù‚Ù…Ùƒ
      window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(text)}`, '_blank');
  }

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  document.addEventListener('DOMContentLoaded', () => {
    loadFinanceProducts();
    loadBankConfigs();
    loadArchive();
    updateDateTime();
  });
</script>
</body>
</html>