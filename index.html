<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù | Ù…Ù†ØµØ© Ø§Ù„ØªØ±Ø´ÙŠØ­ ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚</title>

  <!-- Ø®Ø· Tajawal -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- QR + html2canvas (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --primary:#1e3a8a;
      --primary2:#0f172a;
      --danger:#b91c1c;
      --ok:#065f46;
      --line:#e5e7eb;
      --soft:#eef2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Tajawal', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
      font-size:18px;
      line-height:1.6;
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(135deg, var(--primary2), var(--primary));
      color:#fff;
      padding:14px 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.14);
    }
    .topbar .row{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand b{font-size:20px; letter-spacing:.2px}
    .brand small{opacity:.9}
    .chip{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.25);
      padding:8px 10px;
      border-radius:999px;
      display:flex; align-items:center; gap:8px;
      font-weight:700;
      user-select:none;
    }
    .container{max-width:1100px; margin:18px auto; padding:0 12px 26px}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #fff, #fafafa);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .head h2{
      margin:0; font-size:18px;
    }
    .card .body{padding:14px}
    .muted{color:var(--muted)}
    .btn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      font-size:18px;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition: transform .05s ease, opacity .2s ease;
      user-select:none;
      text-decoration:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.dark{background:var(--primary2); color:#fff}
    .btn.soft{background:var(--soft); color:var(--primary); border:1px solid #dbeafe}
    .btn.danger{background:var(--danger); color:#fff}
    .btn.ok{background:var(--ok); color:#fff}
    .btn.ghost{background:transparent; border:1px solid var(--line); color:var(--ink)}
    .btn.small{padding:9px 10px; border-radius:12px; font-size:16px; font-weight:800}
    .btn.full{width:100%}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-bottom:12px;
    }
    .field label{font-weight:800; font-size:16px}
    .field input, .field select, .field textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:18px;
      outline:none;
      background:#fff;
    }
    .field textarea{min-height:110px; resize:vertical}
    .hint{font-size:14px; color:var(--muted)}
    .hr{height:1px; background:var(--line); margin:14px 0}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#f9fafb;
      border:1px solid var(--line);
      padding:8px 10px; border-radius:999px; font-weight:800;
      font-size:15px;
    }
    .tag{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:14px; font-weight:900;
      background:#eef2ff; color:var(--primary);
      border:1px solid #dbeafe;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:16px;
    }
    .table th{
      background:#f9fafb;
      font-weight:900;
      text-align:right;
    }
    .table tr:last-child td{border-bottom:none}
    .finance-item{
      border:1px dashed #d1d5db;
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
      background:#fff;
    }
    .finance-item .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .finance-item .top b{font-size:16px}
    .two{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    @media (max-width: 680px){ .two{grid-template-columns:1fr} }

    /* Viewer */
    .viewer-wrap{
      max-width:900px;
      margin:18px auto 30px;
      padding:0 12px;
    }
    .doc{
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .doc .docHead{
      padding:16px 16px 12px;
      color:#fff;
      background: linear-gradient(135deg, var(--primary2), var(--primary));
    }
    .doc .docHead .title{
      font-size:20px; font-weight:900; margin:0;
    }
    .doc .docHead .meta{
      margin-top:6px; opacity:.95; font-size:14px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .doc .docBody{padding:16px}
    .notice{
      border:1px solid #fde68a;
      background:#fffbeb;
      border-radius:16px;
      padding:12px;
      font-weight:800;
      color:#92400e;
      margin:10px 0;
    }
    .warn{
      border:1px solid #fecaca;
      background:#fef2f2;
      border-radius:16px;
      padding:12px;
      font-weight:900;
      color:var(--danger);
      margin:10px 0;
    }
    .okbox{
      border:1px solid #bbf7d0;
      background:#f0fdf4;
      border-radius:16px;
      padding:12px;
      font-weight:900;
      color:var(--ok);
      margin:10px 0;
    }
    .footerNote{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed #e5e7eb;
      color:#374151;
      font-size:14px;
    }
    .qrRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--line);
    }
    .qrBox{
      display:flex; align-items:center; gap:12px;
    }
    .qrBox #qr{
      width:108px; height:108px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
      background:#fff;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <b>Ù…ÙˆÙ‚Ø¹ Ù…ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù</b>
        <small>Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ + Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù + Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù„Ø¹Ù…ÙŠÙ„ + QR Ù„Ù„ØªØ­Ù‚Ù‚</small>
      </div>
      <div class="chip" id="modeChip">ğŸ§¾ ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù</div>
    </div>
  </div>

  <!-- Employee App -->
  <div class="container" id="app">
    <div class="grid">
      <!-- Left: Create Document -->
      <div class="card">
        <div class="head">
          <h2>Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø¹Ù…ÙŠÙ„</h2>
          <span class="tag" id="dbStatus">Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</span>
        </div>
        <div class="body">
          <div class="two">
            <div class="field">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="employeeName" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø§ÙŠÙ" />
            </div>
            <div class="field">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
              <input id="docDate" disabled />
              <div class="hint">ÙŠØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="two">
            <div class="field">
              <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <input id="clientName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯" />
            </div>
            <div class="field">
              <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
              <input id="clientPhone" inputmode="tel" placeholder="05xxxxxxxx" />
            </div>
          </div>

          <div class="two">
            <div class="field">
              <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="clientId" inputmode="numeric" placeholder="10 Ø£Ø±Ù‚Ø§Ù…" />
            </div>
            <div class="field">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ø¹Ù…ÙŠÙ„ (ØªÙØ­ÙØ¸ + Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¨Ø­Ø«)</label>
              <input id="clientShortNote" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙØ¶Ù‘Ù„ Ø¨Ù†Ùƒ Ù…Ø¹ÙŠÙ‘Ù† / ÙŠØ¨ÙŠ Ù‚Ø³Ø· Ù…Ù†Ø®ÙØ¶..." />
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between">
            <b>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„Ø§Øª (ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ø£ÙƒØ«Ø± Ù…Ù† ØªÙ…ÙˆÙŠÙ„)</b>
            <button class="btn soft small" id="addFinanceBtn">â• Ø¥Ø¶Ø§ÙØ© ØªÙ…ÙˆÙŠÙ„</button>
          </div>

          <div id="financesWrap" style="margin-top:12px;"></div>

          <div class="hr"></div>

          <div class="field">
            <label>Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (ØªÙØ­ÙØ¸ + Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„Ù‡Ø§)</label>
            <textarea id="employeeMemo" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©â€¦ (ØªÙ‚Ø¯Ø± ØªØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø£ÙŠ ÙƒÙ„Ù…Ø©)"></textarea>
          </div>

          <div class="row">
            <button class="btn primary full" id="generateDocBtn">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© + ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· + QR</button>
          </div>

          <div class="hint" style="margin-top:10px">
            âœ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙƒÙˆÙ† Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù†ÙØ³Ù‡ (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±) â€” Ù…Ù†Ø§Ø³Ø¨ Ù„Ù€ GitHub Pages.
          </div>
        </div>
      </div>

      <!-- Right: Search & Saved -->
      <div class="card">
        <div class="head">
          <h2>Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª + Ø§Ù„Ø¨Ø­Ø«</h2>
          <span class="pill" id="countPill">0 ÙˆØ«ÙŠÙ‚Ø©</span>
        </div>
        <div class="body">
          <div class="field">
            <label>Ø§Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø© (ÙÙŠ Ø§Ù„Ù…Ø°ÙƒØ±Ø© / Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ø¨Ù†Ùƒ / Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„â€¦)</label>
            <input id="searchBox" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ / Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© / Ø¹Ù…ÙŠÙ„ Ù…Ø­Ù…Ø¯ / Ù‚Ø³Ø· Ù…ØªØºÙŠØ±..." />
          </div>
          <div class="row">
            <button class="btn ghost small" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)</button>
            <label class="btn ghost small" for="importFile" style="cursor:pointer">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© (JSON)</label>
            <input id="importFile" type="file" accept="application/json" class="hide" />
          </div>

          <div class="hr"></div>

          <div id="savedList"></div>

          <div class="hr"></div>

          <button class="btn danger full" id="wipeBtn">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª (Ù…Ø­Ù„ÙŠÙ‹Ø§)</button>
          <div class="hint" style="margin-top:8px">
            * Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ (LocalStorage). Ø¥Ø°Ø§ ØªØ¨ÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ø³ØªØ®Ø¯Ù… â€œØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯â€.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Viewer -->
  <div class="viewer-wrap hide" id="viewer">
    <div class="row" style="justify-content:space-between; margin-bottom:12px">
      <a class="btn ghost" href="#" id="backToApp">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù</a>
      <div class="row">
        <button class="btn soft" id="copyLinkBtn">ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
        <button class="btn ok" id="saveImageBtn">ğŸ–¼ï¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
      </div>
    </div>

    <div class="doc" id="docCanvas">
      <div class="docHead">
        <p class="title" id="docTitle">ÙˆØ«ÙŠÙ‚Ø© Ø¹Ù…ÙŠÙ„</p>
        <div class="meta">
          <span>ğŸ“… <span id="docMetaDate"></span></span>
          <span>ğŸ§‘â€ğŸ’¼ <span id="docMetaEmp"></span></span>
          <span class="mono">ID: <span id="docMetaId"></span></span>
        </div>
      </div>

      <div class="docBody">
        <div class="okbox" id="validBox">âœ… Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© â€œÙ…ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§â€ Ø¹Ø¨Ø± QR ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
        <div class="warn hide" id="invalidBox">âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚Ø©/Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø¹Ø¯Ù„Ø© Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙƒØªÙ…Ù„.</div>

        <div class="notice">
          âš ï¸ Ø§Ù„Ø­Ø³Ø¨Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ ÙˆÙ‚Ø¯ ØªØ®ØªÙ„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©.
        </div>

        <div class="notice">
          ØªÙ†Ø¨ÙŠÙ‡: Ù†Ø­Ù† Ù„Ø³Ù†Ø§ Ø¬Ù‡Ø© ØªÙ…ÙˆÙŠÙ„ÙŠØ©ØŒ ÙˆÙ†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ±Ø´ÙŠØ­ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙ‚Ø·.
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</b>
            <div class="muted" style="margin-top:6px">
              Ø§Ù„Ø§Ø³Ù…: <b id="vClientName"></b><br/>
              Ø§Ù„Ø¬ÙˆØ§Ù„: <b id="vClientPhone"></b><br/>
              Ø§Ù„Ù‡ÙˆÙŠØ©: <b id="vClientId"></b><br/>
              Ù…Ù„Ø§Ø­Ø¸Ø©: <b id="vClientShortNote"></b>
            </div>
          </div>
          <div>
            <b>Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ…ÙˆÙŠÙ„Ø§Øª</b>
            <div class="muted" style="margin-top:6px" id="vSummary"></div>
          </div>
        </div>

        <div class="hr"></div>

        <b>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„Ø§Øª</b>
        <div style="margin-top:10px; overflow:auto">
          <table class="table" id="vTable">
            <thead>
              <tr>
                <th>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</th>
                <th>Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ…ÙˆÙŠÙ„</th>
                <th>Ø§Ù„Ù‚Ø³Ø·</th>
                <th>Ø§Ù„Ù…Ø¯Ø© (Ø´Ù‡Ø±)</th>
                <th>Ø§Ù„Ù†Ø³Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</th>
                <th>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</th>
              </tr>
            </thead>
            <tbody id="vTbody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <b>Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù</b>
        <div class="muted" id="vMemo" style="margin-top:8px; white-space:pre-wrap"></div>

        <div class="qrRow">
          <div class="qrBox">
            <div id="qr"></div>
            <div>
              <b>Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (QR)</b><br/>
              <span class="muted">ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©.</span><br/>
              <span class="muted mono" id="vSig"></span>
            </div>
          </div>
          <div class="muted" style="max-width:380px">
            <div class="footerNote">
              ÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø£Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù.
            </div>
          </div>
        </div>

        <div class="footerNote">
          Â© Ù…ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù â€” Ù†Ø³Ø®Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
========================= */
const $ = (id)=>document.getElementById(id);

function nowKSA(){
  // Asia/Riyadh
  const d = new Date();
  const fmt = new Intl.DateTimeFormat('ar-SA', { dateStyle:'full', timeStyle:'medium', timeZone:'Asia/Riyadh' });
  return fmt.format(d);
}

function clampStr(s){ return (s ?? '').toString().trim(); }

function moneyFmt(v){
  const n = Number(String(v).replace(/[^\d.]/g,''));
  if(!isFinite(n)) return '';
  return new Intl.NumberFormat('ar-SA').format(Math.round(n)) + ' Ø±ÙŠØ§Ù„';
}

function base64UrlEncode(str){
  const b64 = btoa(unescape(encodeURIComponent(str)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function base64UrlDecode(b64url){
  const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
  const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
  const s = atob(b64 + pad);
  return decodeURIComponent(escape(s));
}

async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

function uid(){
  return 'DOC-' + Math.random().toString(16).slice(2,10).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
}

/* =========================
   Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
========================= */
const DB_KEY = 'EMP_OFFICE_DB_V1';
function loadDB(){
  try{
    const raw = localStorage.getItem(DB_KEY);
    if(!raw) return {docs:[]};
    const db = JSON.parse(raw);
    if(!db.docs) db.docs=[];
    return db;
  }catch(e){
    return {docs:[]};
  }
}
function saveDB(db){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function updateCounts(){
  const db = loadDB();
  $('countPill').textContent = `${db.docs.length} ÙˆØ«ÙŠÙ‚Ø©`;
}

/* =========================
   UI: Ø§Ù„ØªÙ…ÙˆÙŠÙ„Ø§Øª
========================= */
const financeTypes = [
  'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ',
  'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ',
  'ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ',
  'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© (Ø´Ø®ØµÙŠ)',
  'Ø´Ø±Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© (Ø¹Ù‚Ø§Ø±ÙŠ)',
  'ØªÙ…ÙˆÙŠÙ„ Ø³ÙŠØ§Ø±Ø©',
  'ØªÙ…ÙˆÙŠÙ„ Ø¢Ø®Ø±'
];

function financeTemplate(index){
  const wrap = document.createElement('div');
  wrap.className = 'finance-item';
  wrap.dataset.index = index;

  wrap.innerHTML = `
    <div class="top">
      <b>ØªÙ…ÙˆÙŠÙ„ #${index+1}</b>
      <button class="btn danger small" type="button" onclick="removeFinance(${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>

    <div class="two">
      <div class="field">
        <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„</label>
        <select class="fType">
          ${financeTypes.map(t=>`<option value="${t}">${t}</option>`).join('')}
        </select>
      </div>
      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
        <input class="fBank" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ / Ø§Ù„Ø£Ù‡Ù„ÙŠ..." />
      </div>
    </div>

    <div class="two">
      <div class="field">
        <label>Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ…ÙˆÙŠÙ„</label>
        <input class="fAmount" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 500000" />
      </div>
      <div class="field">
        <label>Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø´Ù‡ÙˆØ±)</label>
        <input class="fMonths" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 240" />
      </div>
    </div>

    <div class="two">
      <div class="field">
        <label>Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
        <input class="fInstall" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 3200" />
        <div class="hint">Ø¥Ø°Ø§ Ø§Ù„Ù‚Ø³Ø· Ù…ØªØºÙŠØ± Ø§Ø®ØªØ± â€œÙ‚Ø³Ø· Ù…ØªØºÙŠØ±â€ Ø£Ø¯Ù†Ø§Ù‡</div>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù†Ø³Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input class="fRate" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 4.15%" />
      </div>
    </div>

    <div class="field">
      <label>Ù‡Ù„ Ø§Ù„Ù‚Ø³Ø· Ù…ØªØºÙŠØ±ØŸ</label>
      <select class="fVarMode" onchange="toggleVar(${index})">
        <option value="fixed">Ù„Ø§ - Ø«Ø§Ø¨Øª</option>
        <option value="var2">Ù†Ø¹Ù… - ÙØªØ±ØªÙŠÙ†</option>
      </select>
      <div class="hint">Ù…Ø«Ø§Ù„: Ù…Ù† 1 Ø¥Ù„Ù‰ 24 = 0 Ø±ÙŠØ§Ù„ØŒ Ø«Ù… Ù…Ù† 25 Ø¥Ù„Ù‰ 60 = 1800 Ø±ÙŠØ§Ù„</div>
    </div>

    <div class="two fVarBox hide">
      <div class="field">
        <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±)</label>
        <input class="fV1M" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 24" />
      </div>
      <div class="field">
        <label>Ù‚Ø³Ø· Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</label>
        <input class="fV1I" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 0" />
      </div>
      <div class="field">
        <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡ÙˆØ±)</label>
        <input class="fV2M" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 36" />
      </div>
      <div class="field">
        <label>Ù‚Ø³Ø· Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</label>
        <input class="fV2I" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1800" />
      </div>
    </div>

    <div class="field">
      <label>ØªÙØ§ØµÙŠÙ„/Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="fMore" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø³Ø· Ù…ØªØºÙŠØ± + Ø±Ø³ÙˆÙ… Ø¥Ø¯Ø§Ø±ÙŠØ© + ØªØ£Ù…ÙŠÙ†..." />
    </div>
  `;
  return wrap;
}

function rebuildFinances(){
  const container = $('financesWrap');
  const items = Array.from(container.children);
  container.innerHTML = '';
  items.forEach((_,i)=>{
    container.appendChild(financeTemplate(i));
  });
}

window.removeFinance = function(i){
  const container = $('financesWrap');
  const kids = Array.from(container.children);
  if(kids[i]) kids[i].remove();
  rebuildFinances();
};

window.toggleVar = function(i){
  const container = $('financesWrap');
  const item = container.children[i];
  if(!item) return;
  const mode = item.querySelector('.fVarMode').value;
  const box = item.querySelector('.fVarBox');
  if(mode === 'var2') box.classList.remove('hide');
  else box.classList.add('hide');
};

function addFinance(){
  const container = $('financesWrap');
  const idx = container.children.length;
  container.appendChild(financeTemplate(idx));
}

function readFinances(){
  const container = $('financesWrap');
  const list = [];
  Array.from(container.children).forEach(item=>{
    const type = clampStr(item.querySelector('.fType').value);
    const bank = clampStr(item.querySelector('.fBank').value);
    const amount = clampStr(item.querySelector('.fAmount').value);
    const months = clampStr(item.querySelector('.fMonths').value);
    const install = clampStr(item.querySelector('.fInstall').value);
    const rate = clampStr(item.querySelector('.fRate').value);
    const more = clampStr(item.querySelector('.fMore').value);

    const varMode = item.querySelector('.fVarMode').value;
    let variable = null;
    if(varMode === 'var2'){
      variable = {
        v1m: clampStr(item.querySelector('.fV1M').value),
        v1i: clampStr(item.querySelector('.fV1I').value),
        v2m: clampStr(item.querySelector('.fV2M').value),
        v2i: clampStr(item.querySelector('.fV2I').value),
      };
    }

    list.push({type, bank, amount, months, install, rate, more, variable});
  });
  return list;
}

/* =========================
   Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© + Ø§Ù„Ø±Ø§Ø¨Ø· + Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
========================= */
function canonicalDocPayload(doc){
  // Ù†Ø­Ø°Ù Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø© Ø§Ù„ØªÙŠ Ù…Ø§ Ù†Ø¨ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ù„Ùˆ Ø§Ø­ØªØ¬Øª)
  const copy = JSON.parse(JSON.stringify(doc));
  delete copy.checksum;
  return JSON.stringify(copy);
}

async function buildDoc(){
  const doc = {
    id: uid(),
    createdAt: new Date().toISOString(),
    createdAtHuman: nowKSA(),
    employeeName: clampStr($('employeeName').value) || 'â€”',
    client: {
      name: clampStr($('clientName').value) || 'â€”',
      phone: clampStr($('clientPhone').value) || 'â€”',
      id: clampStr($('clientId').value) || 'â€”',
      shortNote: clampStr($('clientShortNote').value) || 'â€”'
    },
    financings: readFinances(),
    memo: clampStr($('employeeMemo').value) || 'â€”'
  };

  const payloadStr = canonicalDocPayload(doc);
  doc.checksum = await sha256Hex(payloadStr);

  return doc;
}

function buildShareLink(doc){
  // Ù†Ø®Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· (hash) Ø¹Ø´Ø§Ù† ØªØ´ØªØºÙ„ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±
  const payload = {
    doc: doc,
    sig: doc.checksum
  };
  const packed = base64UrlEncode(JSON.stringify(payload));
  const url = `${location.origin}${location.pathname}#pack=${packed}`;
  return url;
}

async function verifyPacked(packed){
  try{
    const decoded = base64UrlDecode(packed);
    const payload = JSON.parse(decoded);
    if(!payload?.doc?.checksum || !payload?.sig) return {ok:false, reason:'missing'};
    // Ù†ØªØ­Ù‚Ù‚: sig Ù„Ø§Ø²Ù… ÙŠØ·Ø§Ø¨Ù‚ doc.checksumØŒ Ø«Ù… Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ checksum
    if(payload.sig !== payload.doc.checksum) return {ok:false, reason:'sigMismatch'};
    const payloadStr = canonicalDocPayload(payload.doc);
    const re = await sha256Hex(payloadStr);
    if(re !== payload.doc.checksum) return {ok:false, reason:'hashMismatch'};
    return {ok:true, doc: payload.doc};
  }catch(e){
    return {ok:false, reason:'parseError'};
  }
}

/* =========================
   Ø­ÙØ¸ / Ø¹Ø±Ø¶ / Ù‚Ø§Ø¦Ù…Ø©
========================= */
function upsertDocToDB(doc){
  const db = loadDB();
  const idx = db.docs.findIndex(d => d.id === doc.id);
  if(idx >= 0) db.docs[idx] = doc;
  else db.docs.unshift(doc);
  saveDB(db);
  updateCounts();
}

function docMatches(doc, q){
  const hay = [
    doc.id,
    doc.employeeName,
    doc.createdAtHuman,
    doc.client?.name,
    doc.client?.phone,
    doc.client?.id,
    doc.client?.shortNote,
    doc.memo,
    ...(doc.financings||[]).flatMap(f=>[
      f.type, f.bank, f.amount, f.months, f.install, f.rate, f.more,
      f.variable ? JSON.stringify(f.variable) : ''
    ])
  ].join(' ').toLowerCase();
  return hay.includes(q);
}

function renderSavedList(){
  const db = loadDB();
  const q = clampStr($('searchBox').value).toLowerCase();
  const list = db.docs.filter(d => !q || docMatches(d, q));

  $('savedList').innerHTML = list.length ? '' : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`;

  list.slice(0, 40).forEach(d=>{
    const card = document.createElement('div');
    card.style.border = '1px solid var(--line)';
    card.style.borderRadius = '16px';
    card.style.padding = '12px';
    card.style.marginBottom = '10px';
    card.style.background = '#fff';

    const finCount = (d.financings||[]).length;
    const banks = (d.financings||[]).map(x=>x.bank).filter(Boolean).slice(0,3).join('ØŒ ') || 'â€”';
    const link = buildShareLink(d);

    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <b>${d.client?.name || 'â€”'}</b>
          <div class="muted" style="font-size:14px">
            ${d.createdAtHuman || ''} â€¢ ${finCount} ØªÙ…ÙˆÙŠÙ„ â€¢ Ø¨Ù†ÙˆÙƒ: ${banks}
          </div>
          <div class="muted mono" style="font-size:12px; margin-top:4px">${d.id}</div>
        </div>
        <span class="tag">Ù…Ø­ÙÙˆØ¸</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn soft small" type="button" data-act="open">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
        <button class="btn ghost small" type="button" data-act="copy">ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø·</button>
        <button class="btn danger small" type="button" data-act="del">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    `;

    card.querySelector('[data-act="open"]').onclick = ()=> openViewerFromDoc(d);
    card.querySelector('[data-act="copy"]').onclick = async ()=>{
      await navigator.clipboard.writeText(link);
      alert('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
    };
    card.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm('Ù…ØªØ£ÙƒØ¯ ØªØ­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©ØŸ')) return;
      const db2 = loadDB();
      db2.docs = db2.docs.filter(x=>x.id !== d.id);
      saveDB(db2);
      updateCounts();
      renderSavedList();
    };

    $('savedList').appendChild(card);
  });

  updateCounts();
}

/* =========================
   Viewer
========================= */
let currentShareLink = '';

async function openViewerFromPacked(packed){
  const res = await verifyPacked(packed);
  if(!res.ok){
    // Ø¹Ø±Ø¶ ÙˆØ«ÙŠÙ‚Ø© Ù„ÙƒÙ† Ø¨Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚Ø©
    $('validBox').classList.add('hide');
    $('invalidBox').classList.remove('hide');
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ Ø´ÙŠØ¡ Ø¥Ù† Ø£Ù…ÙƒÙ†
    try{
      const decoded = base64UrlDecode(packed);
      const payload = JSON.parse(decoded);
      if(payload?.doc) renderViewer(payload.doc, false);
      else throw new Error('no doc');
    }catch(e){
      alert('âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù†Ø§Ù‚Øµ.');
      backToApp();
      return;
    }
  }else{
    $('invalidBox').classList.add('hide');
    $('validBox').classList.remove('hide');
    renderViewer(res.doc, true);
  }
}

function openViewerFromDoc(doc){
  $('invalidBox').classList.add('hide');
  $('validBox').classList.remove('hide');
  renderViewer(doc, true);
}

function renderViewer(doc, verified){
  // mode switch
  $('app').classList.add('hide');
  $('viewer').classList.remove('hide');
  $('modeChip').textContent = 'ğŸ‘ï¸ ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©';
  currentShareLink = buildShareLink(doc);

  $('docTitle').textContent = `ÙˆØ«ÙŠÙ‚Ø© Ø¹Ù…ÙŠÙ„: ${doc.client?.name || 'â€”'}`;
  $('docMetaDate').textContent = doc.createdAtHuman || 'â€”';
  $('docMetaEmp').textContent = doc.employeeName || 'â€”';
  $('docMetaId').textContent = doc.id || 'â€”';

  $('vClientName').textContent = doc.client?.name || 'â€”';
  $('vClientPhone').textContent = doc.client?.phone || 'â€”';
  $('vClientId').textContent = doc.client?.id || 'â€”';
  $('vClientShortNote').textContent = doc.client?.shortNote || 'â€”';

  const fin = doc.financings || [];
  $('vSummary').innerHTML = `
    Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ„Ø§Øª: <b>${fin.length}</b><br/>
    Ø§Ù„Ø¨Ù†ÙˆÙƒ: <b>${fin.map(x=>x.bank).filter(Boolean).join('ØŒ ') || 'â€”'}</b>
  `;

  // table
  const tb = $('vTbody');
  tb.innerHTML = '';
  fin.forEach(f=>{
    const tr = document.createElement('tr');

    let installText = moneyFmt(f.install);
    let extra = clampStr(f.more);

    if(f.variable){
      const v1m = Number(f.variable.v1m||0);
      const v2m = Number(f.variable.v2m||0);
      const v1i = moneyFmt(f.variable.v1i);
      const v2i = moneyFmt(f.variable.v2i);
      installText = `Ù…ØªØºÙŠØ±: (1â†’${v1m}) = ${v1i} ØŒ Ø«Ù… (${v1m+1}â†’${v1m+v2m}) = ${v2i}`;
      extra = extra ? (extra + ' â€¢ ') : '';
      extra += 'Ù‚Ø³Ø· Ù…ØªØºÙŠØ± (ÙØªØ±ØªÙŠÙ†)';
    }

    tr.innerHTML = `
      <td><b>${clampStr(f.type)||'â€”'}</b></td>
      <td>${clampStr(f.bank)||'â€”'}</td>
      <td>${moneyFmt(f.amount) || 'â€”'}</td>
      <td>${installText || 'â€”'}</td>
      <td>${clampStr(f.months)||'â€”'}</td>
      <td>${clampStr(f.rate)||'â€”'}</td>
      <td>${extra || 'â€”'}</td>
    `;
    tb.appendChild(tr);
  });

  $('vMemo').textContent = doc.memo || 'â€”';

  // signature
  const sigShort = (doc.checksum||'').slice(0, 14) + 'â€¦' + (doc.checksum||'').slice(-10);
  $('vSig').textContent = `SIG: ${sigShort}`;

  // QR
  const qrEl = $('qr');
  qrEl.innerHTML = '';
  const qrData = currentShareLink; // QR ÙŠØ­Ù…Ù„ Ù†ÙØ³ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
  try{
    new QRCode(qrEl, {
      text: qrData,
      width: 92,
      height: 92,
      correctLevel: QRCode.CorrectLevel.M
    });
  }catch(e){
    qrEl.innerHTML = '<div class="muted">ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ QR (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª/CDN)</div>';
  }

  if(!verified){
    $('validBox').classList.add('hide');
    $('invalidBox').classList.remove('hide');
  }else{
    $('invalidBox').classList.add('hide');
    $('validBox').classList.remove('hide');
  }
}

function backToApp(){
  $('viewer').classList.add('hide');
  $('app').classList.remove('hide');
  $('modeChip').textContent = 'ğŸ§¾ ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù';
  currentShareLink = '';
  // Ù†Ø­Ø°Ù hash Ø­ØªÙ‰ Ù…Ø§ ÙŠØ¨Ù‚Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶
  if(location.hash) history.replaceState(null,'', location.pathname);
}

/* =========================
   Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø·)
========================= */
async function saveDocAsImage(){
  const el = $('docCanvas');

  // Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ± Ù„ØªÙ‚Ù„ÙŠÙ„ â€œØªÙ„Ø®Ø¨Ø· Ø§Ù„Ø®Ø·â€
  try{
    if(document.fonts && document.fonts.ready) await document.fonts.ready;
  }catch(e){}

  const scale = Math.min(2, window.devicePixelRatio || 1.5);

  const canvas = await html2canvas(el, {
    backgroundColor: '#ffffff',
    scale,
    useCORS: true,
    allowTaint: true,
    logging: false
  });

  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'ÙˆØ«ÙŠÙ‚Ø©-Ø§Ù„Ø¹Ù…ÙŠÙ„.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* =========================
   Export / Import
========================= */
function exportDB(){
  const db = loadDB();
  const blob = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'EMP_OFFICE_BACKUP.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function importDB(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !Array.isArray(obj.docs)) throw new Error('bad');
      saveDB({docs: obj.docs});
      updateCounts();
      renderSavedList();
      alert('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
    }catch(e){
      alert('âš ï¸ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
    }
  };
  reader.readAsText(file);
}

/* =========================
   Events
========================= */
(function init(){
  $('docDate').value = nowKSA();
  setInterval(()=> $('docDate').value = nowKSA(), 1000);

  $('addFinanceBtn').addEventListener('click', addFinance);

  $('generateDocBtn').addEventListener('click', async ()=>{
    // ìµœì†Œ ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·
    if(!$('financesWrap').children.length){
      addFinance();
      alert('Ø£Ø¶ÙØª Ù„Ùƒ ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ø­Ø¯ â€” Ø¹Ø¨Ù‘Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©.');
      return;
    }

    const doc = await buildDoc();

    // Ø­ÙØ¸
    upsertDocToDB(doc);
    renderSavedList();

    // Ø§ÙØªØ­ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±Ø©
    openViewerFromDoc(doc);

    // Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ hash Ù„Ù„Ø¹Ø±Ø¶/Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    const link = buildShareLink(doc);
    // ÙÙ‚Ø· Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ø§Ø¨Ø·
    location.hash = 'pack=' + link.split('#pack=')[1];
  });

  $('searchBox').addEventListener('input', renderSavedList);

  $('wipeBtn').addEventListener('click', ()=>{
    if(!confirm('Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§ØªØŸ')) return;
    localStorage.removeItem(DB_KEY);
    updateCounts();
    renderSavedList();
    alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­.');
  });

  $('exportBtn').addEventListener('click', exportDB);
  $('importFile').addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(f) importDB(f);
    e.target.value = '';
  });

  $('backToApp').addEventListener('click', (e)=>{
    e.preventDefault();
    backToApp();
  });

  $('copyLinkBtn').addEventListener('click', async ()=>{
    if(!currentShareLink) return;
    await navigator.clipboard.writeText(currentShareLink);
    alert('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
  });

  $('saveImageBtn').addEventListener('click', async ()=>{
    try{
      await saveDocAsImage();
    }catch(e){
      alert('âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (html2canvas).');
    }
  });

  // Ø¥Ù†Ø´Ø§Ø¡ ØªÙ…ÙˆÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆØ§Ø­Ø¯
  addFinance();

  // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø©
  updateCounts();
  renderSavedList();

  // Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø±Ø§Ø¨Ø· Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù€ hash Ø§ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶
  const hash = location.hash || '';
  const m = hash.match(/pack=([^&]+)/);
  if(m && m[1]){
    $('app').classList.add('hide');
    $('viewer').classList.remove('hide');
    $('modeChip').textContent = 'ğŸ‘ï¸ ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©';
    openViewerFromPacked(m[1]);
  }
})();
</script>
</body>
</html>