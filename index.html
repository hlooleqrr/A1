<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ù†ØµØ© FINO - ØªØ±Ø´ÙŠØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>

  <!-- Tajawal -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    body{
      font-family:'Tajawal',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:#f3f4f6;margin:0;color:#111827;
      text-align:center;font-size:20px;direction:rtl;
    }
    header{
      background:linear-gradient(135deg,#0f172a,#1e3a8a);
      color:#fff;padding:14px 10px;position:sticky;top:0;z-index:10;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    header h1{margin:0;font-size:24px;font-weight:900;letter-spacing:.2px}
    header p{margin:6px 0 0;font-size:14px;opacity:.95}
    .wrap{max-width:980px;margin:14px auto;padding:0 12px}
    .card{
      background:#fff;border-radius:18px;padding:16px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      border:1px solid rgba(15,23,42,.08);
      text-align:right;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .title{font-size:22px;font-weight:900;margin:0 0 10px}
    .muted{color:#6b7280;font-size:16px;line-height:1.6;margin:6px 0 0}
    .hr{height:1px;background:rgba(15,23,42,.10);margin:14px 0;border:0}
    .btn{
      width:100%;border:none;border-radius:16px;padding:14px 14px;
      font-size:20px;font-weight:900;cursor:pointer;
      background:#1e3a8a;color:#fff;transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{
      background:#e5edff;color:#1e3a8a;
      border:1px solid rgba(30,58,138,.25);
      font-size:16px;font-weight:800;border-radius:14px;padding:10px 12px;
      width:auto;display:inline-flex;gap:8px;align-items:center
    }
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:16px;font-weight:800}
    select,input{
      font-family:inherit;font-size:18px;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(15,23,42,.18);outline:none;background:#fff;
    }
    select:focus,input:focus{border-color:#1e3a8a;box-shadow:0 0 0 4px rgba(30,58,138,.12)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row .field{flex:1;min-width:160px}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      flex:1;min-width:210px;
      background:#f8fafc;border:1px solid rgba(15,23,42,.12);
      border-radius:16px;padding:12px;cursor:pointer;
      font-weight:900;font-size:18px;text-align:center;
    }
    .chip.active{border-color:#1e3a8a;box-shadow:0 0 0 4px rgba(30,58,138,.10);background:#eef2ff}
    .note{
      background:#fff7ed;border:1px solid rgba(251,146,60,.35);
      color:#9a3412;border-radius:14px;padding:12px;font-size:16px;line-height:1.7
    }
    .ok{
      background:#ecfdf5;border:1px solid rgba(16,185,129,.28);
      color:#065f46;border-radius:14px;padding:12px;font-size:16px;line-height:1.7
    }
    .bad{
      background:#fef2f2;border:1px solid rgba(239,68,68,.28);
      color:#991b1b;border-radius:14px;padding:12px;font-size:18px;line-height:1.7;font-weight:900
    }
    .hidden{display:none !important}
    .resultBox{
      background:#0b1220;color:#fff;border-radius:18px;padding:14px;
      border:1px solid rgba(255,255,255,.10);text-align:right
    }
    .resultBox h2{margin:0 0 10px;font-size:22px;font-weight:900}
    .lines{display:grid;gap:8px}
    .line{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:10px 10px;font-size:18px
    }
    .line b{font-weight:900}
    .blueName{color:#60a5fa;font-weight:900}
    footer{
      margin:12px auto 18px;max-width:980px;padding:0 12px;
      color:#6b7280;font-size:14px;line-height:1.7
    }
    .footCard{
      background:#fff;border:1px solid rgba(15,23,42,.08);
      border-radius:16px;padding:12px;box-shadow:0 8px 22px rgba(0,0,0,.06);
      text-align:center
    }
    .tiny{font-size:12px;color:#6b7280}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>

<body>
  <header>
    <h1>FINO â€” Smart Finance Match</h1>
    <p>Ù…Ù†ØµØ© Ø°ÙƒÙŠØ© ØªØ±Ø´Ù‘Ø­ Ù„Ùƒ Ø§Ù„Ø£ÙØ¶Ù„ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†Ù</p>
  </header>

  <div class="wrap">
    <div class="card" id="homeCard">
      <div class="title">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø¨Ø©</div>
      <div class="muted">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø³Ù†Ø§ Ø¬Ù‡Ø© ØªÙ…ÙˆÙŠÙ„ÙŠØ©ØŒ Ø¯ÙˆØ±Ù†Ø§ ÙŠÙ‚ØªØµØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ±Ø´ÙŠØ­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø¹ Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø±Ø®Ù‘ØµØ©.
      </div>
      <hr class="hr">
      <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø¨Ø©</button>
    </div>

    <div class="card hidden" id="formCard">
      <div class="title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>

      <!-- Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ -->
      <div class="field">
        <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ØªØ±ÙŠØ¯ Ø­Ø³Ø¨ØªÙ‡:</label>
        <div class="chips" id="financeTypeChips">
          <div class="chip active" data-val="mortgage">ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ</div>
          <div class="chip" data-val="personal">ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ Ø£Ùˆ ØªÙ…ÙˆÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ</div>
        </div>
      </div>

      <hr class="hr">

      <!-- Ø§Ù„Ø§Ø³Ù… -->
      <div class="field">
        <label>Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…</label>
        <input id="clientName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯" />
      </div>

      <hr class="hr">

      <!-- Ø§Ù„ÙˆØ¸ÙŠÙØ© -->
      <div class="field">
        <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
        <select id="jobType">
          <option value="military">Ø¹Ø³ÙƒØ±ÙŠ</option>
          <option value="civil">Ù…Ø¯Ù†ÙŠ</option>
          <option value="semi">Ø®Ø§Øµ Ø´Ø¨Ù‡ Ø­ÙƒÙˆÙ…ÙŠ</option>
          <option value="private_ok">Ø®Ø§Øµ Ù…Ø¹ØªÙ…Ø¯</option>
          <option value="private_no">Ø®Ø§Øµ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯</option>
        </select>
      </div>

      <hr class="hr">

      <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù‡Ø¬Ø±ÙŠ -->
      <div class="field">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù‡Ø¬Ø±ÙŠ)</label>
        <div class="row">
          <div class="field">
            <label>Ø§Ù„ÙŠÙˆÙ…</label>
            <select id="bdDay"></select>
          </div>
          <div class="field">
            <label>Ø§Ù„Ø´Ù‡Ø±</label>
            <select id="bdMonth"></select>
          </div>
          <div class="field">
            <label>Ø§Ù„Ø³Ù†Ø©</label>
            <select id="bdYear"></select>
          </div>
        </div>
        <div class="tiny">Ø§Ø®ØªÙŠØ§Ø± ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)</div>
      </div>

      <div id="militaryExtra" class="hidden">
        <hr class="hr">

        <!-- Ø§Ù„Ø±ØªØ¨Ø© -->
        <div class="field">
          <label>Ø§Ø°ÙƒØ± Ø§Ù„Ø±ØªØ¨Ø©</label>
          <select id="rank"></select>
          <div class="tiny">ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ØªØ¨ + ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ø¨Ø¯ÙˆÙ† Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</div>
        </div>

        <hr class="hr">

        <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† -->
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Ù‡Ø¬Ø±ÙŠ)</label>
          <div class="row">
            <div class="field">
              <label>Ø§Ù„ÙŠÙˆÙ…</label>
              <select id="apDay"></select>
            </div>
            <div class="field">
              <label>Ø§Ù„Ø´Ù‡Ø±</label>
              <select id="apMonth"></select>
            </div>
            <div class="field">
              <label>Ø§Ù„Ø³Ù†Ø©</label>
              <select id="apYear"></select>
            </div>
          </div>
        </div>

        <div class="note" id="retireNote" style="margin-top:10px"></div>

        <div class="field hidden" id="extendBlock" style="margin-top:10px">
          <label>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø³Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ù…ØªØ¯ØŸ</label>
          <select id="extendAfterRet">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù…</option>
          </select>
          <div class="tiny">ÙŠØªÙ… ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ ÙˆØ¨Ø¹Ø¯Ù‡ ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
        </div>
      </div>

      <hr class="hr">

      <!-- Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø³Ù…ÙˆØ­) -->
      <div class="field">
        <label>Ø±Ø§ØªØ¨Ùƒ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø´Ù‡Ø±ÙŠ)</label>
        <input id="netSalary" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 10000" />
      </div>

      <hr class="hr">

      <!-- Ù…Ø¯Ø¹ÙˆÙ…/Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© (Ù„Ù„Ù…Ù†Ø·Ù‚ 55/65) -->
      <div class="row">
        <div class="field">
          <label>Ù‡Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ø¯Ø¹ÙˆÙ…ØŸ</label>
          <select id="isSupported">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù…</option>
          </select>
        </div>
        <div class="field" id="sakaniBlock">
          <label>Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø³ÙƒÙ†ÙŠØŸ</label>
          <select id="sakaniDown">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù…</option>
          </select>
        </div>
      </div>

      <hr class="hr">

      <!-- Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ -->
      <div class="field">
        <label>Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±)</label>
        <select id="monthsSelect"></select>
        <div class="tiny" id="monthsHint"></div>
      </div>

      <hr class="hr">

      <!-- Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª -->
      <div class="field">
        <label>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŸ</label>
        <select id="hasObl">
          <option value="no">Ù„Ø§</option>
          <option value="yes">Ù†Ø¹Ù…</option>
        </select>
      </div>

      <div id="oblBlock" class="hidden">
        <hr class="hr">
        <div class="title" style="font-size:20px;margin:0 0 10px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</div>

        <div class="row">
          <div class="field">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label>
            <select id="oblType">
              <option value="car">Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©</option>
              <option value="consumer">Ù‚Ø±Ø¶ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ</option>
              <option value="other">Ø§Ù„ØªØ²Ø§Ù… Ø¢Ø®Ø±</option>
            </select>
          </div>
          <div class="field">
            <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
            <input id="oblPay" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1500" />
          </div>
          <div class="field">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</label>
            <select id="oblMonthsLeft"></select>
          </div>
        </div>

        <div id="balloonBlock" class="hidden" style="margin-top:10px">
          <div class="row">
            <div class="field">
              <label>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø¯ÙØ¹Ø© Ø£Ø®ÙŠØ±Ø©ØŸ</label>
              <select id="hasBalloon">
                <option value="no">Ù„Ø§</option>
                <option value="yes">Ù†Ø¹Ù…</option>
              </select>
            </div>
            <div class="field hidden" id="balloonAmountWrap">
              <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</label>
              <input id="balloonAmount" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 45000" />
            </div>
          </div>
          <div class="tiny">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ØªÙÙˆØ²Ù‘Ø¹ Ø¹Ù„Ù‰ 24 Ø´Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ù‚Ø³Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn" type="button" id="addOblBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
          <button class="btn secondary" type="button" id="clearOblBtn">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
        </div>

        <div class="muted" style="margin-top:10px" id="oblList"></div>

        <div class="field" style="margin-top:10px">
          <label>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù… Ø¢Ø®Ø±ØŸ</label>
          <select id="moreObl">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù…</option>
          </select>
        </div>
      </div>

      <hr class="hr">

      <button class="btn" id="calcBtn">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div class="card hidden" id="resultCard">
      <div class="resultBox">
        <h2 id="resultTitle">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø¨Ø© (Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)</h2>

        <div class="lines" id="resultLines"></div>

        <div id="negativeWarn" class="bad hidden" style="margin-top:10px">
          Ù†Ø¹ØªØ°Ø± Ù…Ù†Ùƒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙˆÙŠÙ„Ùƒ
        </div>
      </div>

      <div style="margin-top:12px;text-align:center">
        <button class="btn secondary" id="resetBtn">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø¨Ø©</button>
      </div>

      <div class="muted" style="margin-top:12px;text-align:right">
        ØªÙ†ÙˆÙŠÙ‡: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙˆÙ‚Ø¯ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©.
      </div>
    </div>
  </div>

  <footer>
    <div class="footCard">
      <div class="mono" id="todayLine">â€”</div>
      <div class="tiny">Â© FINO â€” Smart Finance Match</div>
    </div>
  </footer>

  <script>
    /***********************
     * Ø£Ø¯ÙˆØ§Øª ØªØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠ (Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Intl Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ)
     * - Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØªÙ… "Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¬Ø±ÙŠ" Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
     ***********************/
    function getTodayHijriParts(){
      const fmt = new Intl.DateTimeFormat('en-TN-u-ca-islamic-umalqura', {year:'numeric',month:'numeric',day:'numeric'});
      const parts = fmt.formatToParts(new Date());
      const obj = {};
      for(const p of parts){
        if(p.type==='year') obj.y = parseInt(p.value,10);
        if(p.type==='month') obj.m = parseInt(p.value,10);
        if(p.type==='day') obj.d = parseInt(p.value,10);
      }
      // fallback
      if(!obj.y || !obj.m || !obj.d){
        obj.y=1445; obj.m=1; obj.d=1;
      }
      return obj;
    }
    function hijriTotalMonths(h){ return (h.y*12 + (h.m-1)); }
    function monthsBetweenHijri(a,b){
      // ÙØ±Ù‚ Ø£Ø´Ù‡Ø± Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù‡Ø¬Ø±ÙŠÙŠÙ† (ØªÙ‚Ø±ÙŠØ¨ÙŠ/Ø¹Ù…Ù„ÙŠ Ù„Ù„Ø­Ø¯ÙˆØ¯)
      let months = hijriTotalMonths(b) - hijriTotalMonths(a);
      // Ø¥Ø°Ø§ ÙŠÙˆÙ… Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£Ù‚Ù„ Ù…Ù† ÙŠÙˆÙ… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù†Ù†Ù‚Øµ Ø´Ù‡Ø±
      if(b.d < a.d) months -= 1;
      return months;
    }
    function addHijriYears(h, years){
      return {y:h.y+years, m:h.m, d:h.d};
    }
    function hijriToTextMonths(totalMonths){
      const years = Math.floor(totalMonths/12);
      const months = totalMonths%12;
      const yTxt = years===0 ? "" : (years===1 ? "Ø³Ù†Ø©" : (years===2 ? "Ø³Ù†ØªÙŠÙ†" : (years<=10 ? years+" Ø³Ù†ÙˆØ§Øª" : years+" Ø³Ù†Ø©")));
      const mTxt = months===0 ? "" : (months===1 ? "Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯" : (months===2 ? "Ø´Ù‡Ø±ÙŠÙ†" : (months<=10 ? months+" Ø£Ø´Ù‡Ø±" : months+" Ø´Ù‡Ø±")));
      if(years>0 && months>0) return `${totalMonths} Ø´Ù‡Ø± (${yTxt} Ùˆ${mTxt})`;
      if(years>0) return `${totalMonths} Ø´Ù‡Ø± (${yTxt})`;
      return `${totalMonths} Ø´Ù‡Ø± (${mTxt || "0"})`;
    }

    /***********************
     * Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ØªØ¨ (Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ) â€” Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:
     * salary = grade1 + inc*(grade-1)  ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø© 15
     ***********************/
    const RANKS = [
      // Ø£ÙØ±Ø§Ø¯
      {name:'Ø¬Ù†Ø¯ÙŠ', inc:130, grade1:3220, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      {name:'Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„', inc:145, grade1:3395, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      {name:'Ø¹Ø±ÙŠÙ', inc:175, grade1:3765, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      {name:'ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨', inc:210, grade1:4455, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      {name:'Ø±Ù‚ÙŠØ¨', inc:250, grade1:5260, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      {name:'Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„', inc:300, grade1:6180, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      {name:'Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡', inc:360, grade1:7215, group:'Ø§Ù„Ø£ÙØ±Ø§Ø¯'},
      // Ø¶Ø¨Ø§Ø·
      {name:'Ù…Ù„Ø§Ø²Ù…', inc:380, grade1:7590, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„', inc:440, grade1:8835, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ù†Ù‚ÙŠØ¨', inc:265, grade1:10600, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ø±Ø§Ø¦Ø¯', inc:265, grade1:13515, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ù…Ù‚Ø¯Ù…', inc:310, grade1:14645, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ø¹Ù‚ÙŠØ¯', inc:360, grade1:16520, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ø¹Ù…ÙŠØ¯', inc:470, grade1:18805, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'},
      {name:'Ù„ÙˆØ§Ø¡', inc:635, grade1:21390, group:'Ø§Ù„Ø¶Ø¨Ø§Ø·'}
    ];

    /***********************
     * Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³Ù‡ÙˆÙ„Ø©)
     * (Ù„Ù… ØªØ²ÙˆØ¯Ù†ÙŠ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø³Ù† Ù„ÙƒÙ„ Ø±ØªØ¨Ø©Ø› ÙˆØ¶Ø¹Øª Ù‚ÙŠÙ… Ø¹Ù…Ù„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
     ***********************/
    const RET_AGE_BY_RANK = {
      'Ø¬Ù†Ø¯ÙŠ':44,'Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„':44,'Ø¹Ø±ÙŠÙ':46,'ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨':48,'Ø±Ù‚ÙŠØ¨':50,'Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„':52,'Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡':54,
      'Ù…Ù„Ø§Ø²Ù…':44,'Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„':46,'Ù†Ù‚ÙŠØ¨':48,'Ø±Ø§Ø¦Ø¯':50,'Ù…Ù‚Ø¯Ù…':52,'Ø¹Ù‚ÙŠØ¯':54,'Ø¹Ù…ÙŠØ¯':56,'Ù„ÙˆØ§Ø¡':58
    };

    function getRankInfo(name){ return RANKS.find(r=>r.name===name); }
    function salaryAtGrade(rankName, grade){
      const info = getRankInfo(rankName);
      if(!info) return 0;
      const g = Math.max(1, Math.min(15, grade));
      return info.grade1 + info.inc*(g-1);
    }
    function estimateGradeFromServiceYears(serviceYears){
      // Ø§Ù„Ø¯Ø±Ø¬Ø© 1 Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†ØŒ Ø«Ù… ØªØ²ÙŠØ¯ ÙƒÙ„ Ø³Ù†Ø© Ø­ØªÙ‰ 15
      const g = 1 + Math.floor(Math.max(0, serviceYears));
      return Math.max(1, Math.min(15, g));
    }

    /***********************
     * ÙˆØ§Ø¬Ù‡Ø©
     ***********************/
    const homeCard = document.getElementById('homeCard');
    const formCard = document.getElementById('formCard');
    const resultCard = document.getElementById('resultCard');

    const startBtn = document.getElementById('startBtn');
    const calcBtn  = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');

    const financeTypeChips = document.getElementById('financeTypeChips');
    let financeType = 'mortgage';

    const jobType = document.getElementById('jobType');
    const militaryExtra = document.getElementById('militaryExtra');
    const rankSel = document.getElementById('rank');
    const extendBlock = document.getElementById('extendBlock');
    const extendAfterRet = document.getElementById('extendAfterRet');
    const retireNote = document.getElementById('retireNote');

    const bdDay=document.getElementById('bdDay'), bdMonth=document.getElementById('bdMonth'), bdYear=document.getElementById('bdYear');
    const apDay=document.getElementById('apDay'), apMonth=document.getElementById('apMonth'), apYear=document.getElementById('apYear');

    const netSalary = document.getElementById('netSalary');
    const isSupported = document.getElementById('isSupported');
    const sakaniBlock = document.getElementById('sakaniBlock');
    const sakaniDown = document.getElementById('sakaniDown');

    const monthsSelect = document.getElementById('monthsSelect');
    const monthsHint = document.getElementById('monthsHint');

    const hasObl = document.getElementById('hasObl');
    const oblBlock = document.getElementById('oblBlock');
    const oblType = document.getElementById('oblType');
    const oblPay  = document.getElementById('oblPay');
    const oblMonthsLeft = document.getElementById('oblMonthsLeft');

    const balloonBlock = document.getElementById('balloonBlock');
    const hasBalloon = document.getElementById('hasBalloon');
    const balloonAmountWrap = document.getElementById('balloonAmountWrap');
    const balloonAmount = document.getElementById('balloonAmount');

    const addOblBtn = document.getElementById('addOblBtn');
    const clearOblBtn = document.getElementById('clearOblBtn');
    const oblList = document.getElementById('oblList');
    const moreObl = document.getElementById('moreObl');

    const clientName = document.getElementById('clientName');

    const resultLines = document.getElementById('resultLines');
    const negativeWarn = document.getElementById('negativeWarn');

    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    let obligations = []; // {type, pay, monthsLeft, balloonAmount}

    function setFinanceType(val){
      financeType = val;
      [...financeTypeChips.querySelectorAll('.chip')].forEach(c=>{
        c.classList.toggle('active', c.dataset.val===val);
      });
      // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø³ÙƒÙ†ÙŠ (ÙÙ‚Ø· Ù„Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø¹Ø§Ø¯Ø©)
      if(financeType==='mortgage'){
        sakaniBlock.classList.remove('hidden');
      }else{
        sakaniBlock.classList.add('hidden');
      }
      refreshMonthsOptions();
      refreshOblMonthsOptions();
      refreshRetirementUI();
    }

    financeTypeChips.addEventListener('click',(e)=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      setFinanceType(chip.dataset.val);
    });

    startBtn.addEventListener('click',()=>{
      homeCard.classList.add('hidden');
      formCard.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    resetBtn.addEventListener('click',()=>{
      resultCard.classList.add('hidden');
      formCard.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…/Ø§Ù„Ø£Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†ÙˆØ§Øª
    function fillDateSelects(){
      bdDay.innerHTML=''; bdMonth.innerHTML=''; bdYear.innerHTML='';
      apDay.innerHTML=''; apMonth.innerHTML=''; apYear.innerHTML='';

      for(let d=1; d<=30; d++){
        bdDay.append(new Option(d,d));
        apDay.append(new Option(d,d));
      }
      for(let m=1; m<=12; m++){
        bdMonth.append(new Option(m,m));
        apMonth.append(new Option(m,m));
      }
      // Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: 1370/01/01 Ø¥Ù„Ù‰ 1430/01/01 (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¹Ø§Ù…)
      for(let y=1370; y<=1430; y++){
        bdYear.append(new Option(y,y));
      }
      // Ø§ÙØªØ±Ø§Ø¶ÙŠ 1412/01/01
      bdYear.value = '1412';
      bdMonth.value = '1';
      bdDay.value = '1';

      // Ø§Ù„ØªØ¹ÙŠÙŠÙ†: Ù…Ù† (Ø§Ù„ÙŠÙˆÙ…-40 Ø³Ù†Ø©) Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… (Ù‡Ø¬Ø±ÙŠ)
      const todayH = getTodayHijriParts();
      const start = Math.max(1300, todayH.y-40);
      for(let y=start; y<=todayH.y; y++){
        apYear.append(new Option(y,y));
      }
      apYear.value = String(Math.max(start, todayH.y-20));
      apMonth.value = String(todayH.m);
      apDay.value = String(Math.min(30,todayH.d));
    }

    function fillRanks(){
      rankSel.innerHTML='';
      // ØªØ¬Ù…ÙŠØ¹
      const groups = {};
      for(const r of RANKS){
        if(!groups[r.group]) groups[r.group]=[];
        groups[r.group].push(r);
      }
      for(const gName of Object.keys(groups)){
        const og = document.createElement('optgroup');
        og.label = gName;
        for(const r of groups[gName]){
          og.appendChild(new Option(r.name, r.name));
        }
        rankSel.appendChild(og);
      }
      rankSel.value = 'Ø¬Ù†Ø¯ÙŠ';
    }

    // Ø£Ø´Ù‡Ø± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: 1..360 (Ø¹Ù…Ù„ÙŠ) Ù„ÙƒÙ† Ù†Ù‚ÙŠÙ‘Ø¯ Ø­Ø³Ø¨ Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    function refreshOblMonthsOptions(){
      oblMonthsLeft.innerHTML='';
      const term = parseInt(monthsSelect.value||'60',10);
      const max = Math.max(1, Math.min(360, term));
      for(let m=1; m<=max; m++){
        oblMonthsLeft.append(new Option(m,m));
      }
      oblMonthsLeft.value = String(Math.min(max, 60));
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ
    jobType.addEventListener('change', refreshRetirementUI);
    rankSel.addEventListener('change', refreshRetirementUI);
    bdDay.addEventListener('change', refreshMonthsOptions);
    bdMonth.addEventListener('change', refreshMonthsOptions);
    bdYear.addEventListener('change', refreshMonthsOptions);
    apDay.addEventListener('change', refreshRetirementUI);
    apMonth.addEventListener('change', refreshRetirementUI);
    apYear.addEventListener('change', refreshRetirementUI);
    extendAfterRet.addEventListener('change', refreshMonthsOptions);

    function getBirthHijri(){
      return {y:parseInt(bdYear.value,10), m:parseInt(bdMonth.value,10), d:parseInt(bdDay.value,10)};
    }
    function getAppHijri(){
      return {y:parseInt(apYear.value,10), m:parseInt(apMonth.value,10), d:parseInt(apDay.value,10)};
    }

    function refreshRetirementUI(){
      const isMil = jobType.value==='military';
      militaryExtra.classList.toggle('hidden', !isMil);

      if(!isMil){
        retireNote.textContent='';
        extendBlock.classList.add('hidden');
        extendAfterRet.value='no';
        refreshMonthsOptions();
        return;
      }

      const todayH = getTodayHijriParts();
      const birthH = getBirthHijri();
      const rName = rankSel.value;
      const retAge = RET_AGE_BY_RANK[rName] ?? 60;
      const retH = addHijriYears(birthH, retAge);
      const monthsToRet = monthsBetweenHijri(todayH, retH);
      const yearsToRet = monthsToRet/12;

      // Ø®Ø¯Ù…Ø© Ø­ØªÙ‰ Ø§Ù„ÙŠÙˆÙ… (Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…)
      const appH = getAppHijri();
      const serviceMonths = Math.max(0, monthsBetweenHijri(appH, todayH));
      const serviceYears = serviceMonths/12;

      const grade = estimateGradeFromServiceYears(serviceYears);
      const currentBasic = salaryAtGrade(rName, grade);
      const pensionExpected = Math.round(currentBasic * 0.55); // Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ: Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ = 55% Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨

      const retText = `ØªØ§Ø±ÙŠØ® ØªÙ‚Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ù‡Ø¬Ø±ÙŠ): ${retH.y}/${String(retH.m).padStart(2,'0')}/${String(retH.d).padStart(2,'0')}`;
      const monthsText = monthsToRet>=0 ? `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªÙ‚Ø§Ø¹Ø¯: ${hijriToTextMonths(monthsToRet)}` : `ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ØªØ¬Ø§ÙˆØ²Øª Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±ØªØ¨Ø©.`;
      const salText = `Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ) Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø©/Ø§Ù„Ø®Ø¯Ù…Ø©: ${fmtMoney(currentBasic)} Ø±ÙŠØ§Ù„ â€” Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: ${grade}/15`;
      const penText = `Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (ØªÙ‚Ø¯ÙŠØ±ÙŠ): ${fmtMoney(pensionExpected)} Ø±ÙŠØ§Ù„ â€” Ù‚Ø³Ø· Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (55%): ${fmtMoney(Math.round(pensionExpected*0.55))} Ø±ÙŠØ§Ù„`;

      retireNote.innerHTML =
        `<div class="${monthsToRet<0?'bad':'ok'}">
          <b>${retText}</b><br>
          ${monthsText}<br>
          ${salText}<br>
          ${penText}
        </div>`;

      // Ø´Ø±Ø·Ùƒ: Ø³Ø¤Ø§Ù„ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø§Ù„Ù…Ù…ØªØ¯ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ (Ø¹Ù‚Ø§Ø±ÙŠ + Ø¹Ø³ÙƒØ±ÙŠ + Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø£Ù‚Ù„ Ù…Ù† 25 Ø³Ù†Ø©)
      const showExtend = (financeType==='mortgage' && yearsToRet>0 && yearsToRet<25);
      extendBlock.classList.toggle('hidden', !showExtend);
      if(!showExtend) extendAfterRet.value='no';

      refreshMonthsOptions();
    }

    // Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙˆØ¯)
    function refreshMonthsOptions(){
      monthsSelect.innerHTML='';

      const todayH = getTodayHijriParts();
      const birthH = getBirthHijri();

      // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ø¹Ø§Ù…
      let maxByType = (financeType==='mortgage') ? 360 : 60;

      // Ø­Ø¯ Ø­Ø³Ø¨ Ø³Ù† Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯
      let maxByRet = 9999;

      if(jobType.value==='military'){
        const rName = rankSel.value;
        const retAge = RET_AGE_BY_RANK[rName] ?? 60;
        const retH = addHijriYears(birthH, retAge);
        const monthsToRet = monthsBetweenHijri(todayH, retH);

        if(financeType==='mortgage' && (extendAfterRet.value==='yes') && !extendBlock.classList.contains('hidden')){
          // Ù…Ù…ØªØ¯: Ø¥Ù„Ù‰ Ø¹Ù…Ø± 60 Ù‡Ø¬Ø±ÙŠ
          const age60H = addHijriYears(birthH, 60);
          maxByRet = monthsBetweenHijri(todayH, age60H);
        }else{
          // ØºÙŠØ± Ù…Ù…ØªØ¯: Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ ÙÙ‚Ø·
          maxByRet = monthsToRet;
        }
      }else{
        // Ù…Ø¯Ù†ÙŠ/Ø®Ø§Øµ: Ø¥Ù„Ù‰ Ø¹Ù…Ø± 60 Ù‡Ø¬Ø±ÙŠ
        const age60H = addHijriYears(birthH, 60);
        maxByRet = monthsBetweenHijri(todayH, age60H);
      }

      let max = Math.min(maxByType, maxByRet);
      if(!isFinite(max)) max = maxByType;
      max = Math.floor(max);

      // Ø¥Ù† ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 12 Ø´Ù‡Ø± Ø§Ø¹ØªØ¨Ø± ØºÙŠØ± Ù…Ø¤Ù‡Ù„
      if(max < 12) max = 12;

      for(let m=12; m<=max; m++){
        monthsSelect.append(new Option(m, m));
      }

      // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ØªÙƒ
      if(financeType==='mortgage'){
        monthsSelect.value = String(Math.min(240, max));
      }else{
        monthsSelect.value = String(Math.min(60, max));
      }

      monthsHint.textContent = `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯: ${hijriToTextMonths(parseInt(monthsSelect.value,10))}`;

      refreshOblMonthsOptions();
    }

    // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    hasObl.addEventListener('change', ()=>{
      oblBlock.classList.toggle('hidden', hasObl.value!=='yes');
      if(hasObl.value!=='yes'){
        obligations = [];
        renderOblList();
      }
    });

    oblType.addEventListener('change', ()=>{
      const isCar = oblType.value==='car';
      balloonBlock.classList.toggle('hidden', !isCar);
      if(!isCar){
        hasBalloon.value='no';
        balloonAmountWrap.classList.add('hidden');
        balloonAmount.value='';
      }
    });
    hasBalloon.addEventListener('change', ()=>{
      balloonAmountWrap.classList.toggle('hidden', hasBalloon.value!=='yes');
      if(hasBalloon.value!=='yes') balloonAmount.value='';
    });

    addOblBtn.addEventListener('click', ()=>{
      const pay = parseFloat(oblPay.value||'0');
      const mLeft = parseInt(oblMonthsLeft.value||'0',10);
      if(!(pay>0) || !(mLeft>0)){
        alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· + Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        return;
      }
      let bAmt = 0;
      if(oblType.value==='car' && hasBalloon.value==='yes'){
        bAmt = parseFloat(balloonAmount.value||'0');
        if(!(bAmt>0)){
          alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©');
          return;
        }
      }

      obligations.push({
        type:oblType.value,
        pay:Math.round(pay),
        monthsLeft:mLeft,
        balloonAmount:Math.round(bAmt)
      });

      // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¥Ø°Ø§ Ù‚Ø§Ù„ "Ù†Ø¹Ù…" Ø®Ù„Ù‡ ÙŠÙƒÙ…Ù„ØŒ ÙˆØ¥Ø°Ø§ "Ù„Ø§" Ø®Ù„Ø§Øµ
      moreObl.value = 'no';
      renderOblList();

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠ
      oblPay.value='';
      hasBalloon.value='no';
      balloonAmount.value='';
      balloonAmountWrap.classList.add('hidden');
    });

    clearOblBtn.addEventListener('click', ()=>{
      obligations = [];
      renderOblList();
    });

    moreObl.addEventListener('change', ()=>{
      // Ù…Ø§ Ù†Ø·Ù„Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø£Ù† ÙŠØ®ØªØ§Ø± "Ù„Ø§" ÙˆÙŠØ¶ØºØ· Ø§Ø­Ø³Ø¨
      // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ ØªØ­ÙƒÙ… Ø¨ØµØ±ÙŠ
      if(moreObl.value==='yes'){
        // ÙŠØ¨Ù‚Ù‰ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¨Ù„ÙˆÙƒØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒÙ…Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ²Ø§Ù… Ø¬Ø¯ÙŠØ¯
      }
    });

    function renderOblList(){
      if(obligations.length===0){
        oblList.innerHTML = '<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù…Ø¶Ø§ÙØ©.</span>';
        return;
      }
      const lines = obligations.map((o,i)=>{
        let t = (o.type==='car'?'Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©':(o.type==='consumer'?'Ù‚Ø±Ø¶ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ':'Ø§Ù„ØªØ²Ø§Ù… Ø¢Ø®Ø±'));
        let extra = (o.type==='car' && o.balloonAmount>0) ? ` + Ø¯ÙØ¹Ø© Ø£Ø®ÙŠØ±Ø© ${fmtMoney(o.balloonAmount)} ØªÙˆØ²Ø¹ 24 Ø´Ù‡Ø±` : '';
        return `â€¢ (${i+1}) ${t} â€” Ù‚Ø³Ø· ${fmtMoney(o.pay)} Ø±ÙŠØ§Ù„ â€” Ø¨Ø§Ù‚ÙŠ ${o.monthsLeft} Ø´Ù‡Ø±${extra}`;
      });
      oblList.innerHTML = lines.join('<br>');
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø³Ø¤Ø§Ù„ Ø¯ÙØ¹Ø© Ø³ÙƒÙ†ÙŠ
    isSupported.addEventListener('change', ()=>{
      sakaniBlock.classList.toggle('hidden', isSupported.value!=='yes' || financeType!=='mortgage');
    });

    monthsSelect.addEventListener('change', refreshOblMonthsOptions);

    /***********************
     * Ø­Ø³Ø§Ø¨
     ***********************/
    function fmtMoney(n){
      const x = Math.round(Number(n||0));
      return x.toLocaleString('en-US'); // Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¯ÙˆÙ† Ù‡Ù„Ø§Ù„Ø§Øª/ÙƒØ³ÙˆØ±
    }

    function buildObligationSchedule(term){
      // ÙŠØ­Ø³Ø¨ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ§Ù‹ (Ù…Ø¹ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø© ØªÙˆØ²Ø¹ 24 Ø´Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ù‚Ø³Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø©)
      const sched = new Array(term).fill(0);
      for(const o of obligations){
        const m = Math.min(term, o.monthsLeft);
        for(let i=0;i<m;i++){
          sched[i] += o.pay;
        }
        if(o.type==='car' && o.balloonAmount>0){
          const extra = o.balloonAmount / 24;
          const start = m; // Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
          const end = Math.min(term, start+24);
          for(let i=start;i<end;i++){
            sched[i] += extra;
          }
        }
      }
      return sched.map(v=>Math.round(v));
    }

    function compressSegments(values){
      // ÙŠØ±Ø¬Ø¹ ÙØªØ±Ø§Øª Ø«Ø§Ø¨ØªØ© (Ù…Ø¹ Ù…Ù†Ø¹ "Ù…Ù† 10 Ø¥Ù„Ù‰ 10")
      const segs=[];
      let start=1, curr=values[0];
      for(let i=2;i<=values.length;i++){
        const v = values[i-1];
        if(v!==curr){
          segs.push({s:start,e:i-1,val:curr});
          start=i; curr=v;
        }
      }
      segs.push({s:start,e:values.length,val:curr});
      return segs;
    }

    function allowedRateMortgage(salary, supported, sakaniNoDown){
      // Ø­Ø³Ø¨ Ø§ØªÙØ§Ù‚Ùƒ: 65% Ø¥Ø°Ø§ Ø§Ù„Ø±Ø§ØªØ¨ 15000+ Ø£Ùˆ Ø¥Ø°Ø§ Ù…Ø¯Ø¹ÙˆÙ… ÙˆØ§Ø®ØªØ± "Ù„Ø§" Ù„Ø¯ÙØ¹Ø© Ø³ÙƒÙ†ÙŠ
      if(salary>=15000) return 0.65;
      if(supported && sakaniNoDown) return 0.65;
      return 0.55;
    }

    calcBtn.addEventListener('click', ()=>{
      negativeWarn.classList.add('hidden');
      resultLines.innerHTML='';

      const term = parseInt(monthsSelect.value||'0',10);
      const salary = parseFloat(netSalary.value||'0');
      if(!(salary>0) || !(term>=12)){
        alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ + Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        return;
      }

      // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
      const hasO = hasObl.value==='yes';
      if(hasO && obligations.length===0){
        alert('Ø§Ø®ØªØ±Øª Ù†Ø¹Ù… Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŒ Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø«Ù… ØªØ¶ØºØ· Ø§Ø­Ø³Ø¨');
        return;
      }
      // Ù…Ù‡Ù…: Ù…Ø§ Ù†Ù…Ù†Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ùˆ moreObl="yes" Ù„ÙƒÙ† Ù…Ù†Ø·Ù‚Ùƒ ÙŠÙ‚ÙˆÙ„ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      if(hasO && moreObl.value==='yes'){
        alert('Ø£ÙƒÙ…Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø«Ù… Ø§Ø®ØªØ± (Ù„Ø§) ÙÙŠ "Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù… Ø¢Ø®Ø±ØŸ"');
        return;
      }

      const supported = (isSupported.value==='yes');
      const sakaniNoDown = (supported && sakaniDown.value==='no');

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ§Ù‹
      const oblSched = hasO ? buildObligationSchedule(term) : new Array(term).fill(0);

      // Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠ (Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯/Ù‚Ø³Ø· Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯) Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¬Ø±ÙŠ
      const todayH = getTodayHijriParts();
      const birthH = getBirthHijri();

      let militaryInfo = null;
      if(jobType.value==='military'){
        const appH = getAppHijri();
        const serviceMonths = Math.max(0, monthsBetweenHijri(appH, todayH));
        const serviceYears = serviceMonths/12;

        const rName = rankSel.value;
        const retAge = RET_AGE_BY_RANK[rName] ?? 60;
        const retH = addHijriYears(birthH, retAge);
        const monthsToRet = monthsBetweenHijri(todayH, retH);

        const grade = estimateGradeFromServiceYears(serviceYears);
        const basicNow = salaryAtGrade(rName, grade);
        const pensionExpected = Math.round(basicNow * 0.55);
        const pensionInstall = Math.round(pensionExpected * 0.55);

        militaryInfo = {
          rName, grade,
          basicNow,
          pensionExpected,
          pensionInstall,
          retH,
          monthsToRet
        };
      }

      // Ø¨Ù†Ø§Ø¡ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
      let paySched = new Array(term).fill(0);

      if(financeType==='personal'){
        // Ø´Ø®ØµÙŠ: Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª = Ø³Ù‚Ù 45%ØŒ ÙˆÙ‚Ø³Ø· Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 33.33%
        const totalCapRate = hasO ? 0.45 : (1/3);
        const personalCapRate = (1/3);
        const totalCap = Math.round(salary * totalCapRate);
        const personalCap = Math.round(salary * personalCapRate);

        for(let i=0;i<term;i++){
          const available = totalCap - oblSched[i];
          const p = Math.max(0, Math.min(personalCap, available));
          paySched[i] = Math.round(p);
        }
      }else{
        // Ø¹Ù‚Ø§Ø±ÙŠ
        const ratePre = allowedRateMortgage(salary, supported, sakaniNoDown);
        const capPre = Math.round(salary * ratePre);

        // Ø¥Ø°Ø§ Ø¹Ø³ÙƒØ±ÙŠ ÙˆØ§Ø®ØªØ§Ø± Ù…Ù…ØªØ¯ ÙˆÙƒØ§Ù†Øª Ø®Ø§Ù†ØªÙ‡ Ø¸Ø§Ù‡Ø±Ø© = Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØŒ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ 55% Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
        const isMil = jobType.value==='military';
        const extend = (isMil && !extendBlock.classList.contains('hidden') && extendAfterRet.value==='yes');

        let monthsToRet = (militaryInfo ? militaryInfo.monthsToRet : 9999);
        monthsToRet = Math.max(0, Math.min(term, monthsToRet));

        for(let i=0;i<term;i++){
          let cap = capPre;
          if(extend && i>=monthsToRet){
            // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯
            const capPost = militaryInfo ? militaryInfo.pensionInstall : Math.round(salary*0.55);
            cap = capPost;
          }
          const p = Math.max(0, cap - oblSched[i]);
          paySched[i] = Math.round(p);
        }
      }

      // ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø§Ù„Ø¨
      const anyNegative = paySched.some(v=>v<0);
      if(anyNegative){
        negativeWarn.classList.remove('hidden');
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      const name = (clientName.value||'').trim();
      const greetName = name ? name : 'Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„';

      const segs = compressSegments(paySched);

      const out = [];
      out.push(`<div class="line"><b class="blueName">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙˆÙ…Ø³Ù‡Ù„Ø§ ÙŠØ§ ${escapeHtml(greetName)}</b></div>`);

      // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø³ÙƒØ±ÙŠØ© + Ù‚Ø³Ø· Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯
      if(militaryInfo){
        out.push(`<div class="line"><b>Ø§Ù„Ø±ØªØ¨Ø©:</b> ${escapeHtml(militaryInfo.rName)} â€” <b>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©:</b> ${militaryInfo.grade}/15</div>`);
        out.push(`<div class="line"><b>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ):</b> ${fmtMoney(militaryInfo.basicNow)} Ø±ÙŠØ§Ù„</div>`);
        out.push(`<div class="line"><b>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (ØªÙ‚Ø¯ÙŠØ±ÙŠ):</b> ${fmtMoney(militaryInfo.pensionExpected)} Ø±ÙŠØ§Ù„</div>`);
        out.push(`<div class="line"><b>Ù‚Ø³Ø· Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯ (55%):</b> ${fmtMoney(militaryInfo.pensionInstall)} Ø±ÙŠØ§Ù„</div>`);
      }

      out.push(`<div class="line"><b>Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„:</b> ${hijriToTextMonths(term)}</div>`);

      // Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
      out.push(`<div class="line"><b>Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø§Øª):</b></div>`);
      for(const s of segs){
        const money = fmtMoney(s.val);
        if(s.s===s.e){
          out.push(`<div class="line">Ø§Ù„Ø´Ù‡Ø± ${s.s}: <b>${money}</b> Ø±ÙŠØ§Ù„</div>`);
        }else{
          out.push(`<div class="line">Ù…Ù† Ø§Ù„Ø´Ù‡Ø± ${s.s} Ø¥Ù„Ù‰ ${s.e}: <b>${money}</b> Ø±ÙŠØ§Ù„</div>`);
        }
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ø· "Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ…" ÙƒØ¹Ù†ÙˆØ§Ù† (Ø¨Ø¯ÙˆÙ† ÙƒØ³Ø±/Ù‡Ù„Ø§Ù„Ø§Øª)
      const firstPay = paySched[0]||0;
      out.push(`<div class="line"><b>ØªÙ…ÙˆÙŠÙ„Ùƒ Ø§Ù„ØµØ§ÙÙŠ ÙŠØ§ ${escapeHtml(greetName)} Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ…:</b> <span class="mono">${fmtMoney(estimateNetFromPayment(firstPay, term, financeType))}</span> Ø±ÙŠØ§Ù„</div>`);

      // Ø¹Ø±Ø¶
      formCard.classList.add('hidden');
      resultCard.classList.remove('hidden');
      resultLines.innerHTML = out.join('');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØµØ§ÙÙŠ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ø£Ù†Ù‡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†Ø§): Ø¯Ø§Ù„Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙÙ‚Ø·
    function estimateNetFromPayment(monthlyPay, term, type){
      // ØªÙ‚Ø¯ÙŠØ± Ø³Ø±ÙŠØ¹: (Ù‚Ø³Ø· * Ø£Ø´Ù‡Ø±) * Ù…Ø¹Ø§Ù…Ù„
      // (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ùƒ/Ø¨Ù†ÙˆÙƒÙƒ)
      const factor = (type==='mortgage') ? 0.78 : 0.70;
      return Math.max(0, Math.round(monthlyPay * term * factor));
    }

    function escapeHtml(s){
      return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    /***********************
     * ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
     ***********************/
    fillDateSelects();
    fillRanks();
    setFinanceType('mortgage');
    renderOblList();
    refreshRetirementUI();

    // ÙÙˆØªØ±: Ù…ÙŠÙ„Ø§Ø¯ÙŠ + Ù‡Ø¬Ø±ÙŠ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function updateFooter(){
      const d = new Date();
      const greg = new Intl.DateTimeFormat('ar-SA', {year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'}).format(d);
      const hijr = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
      const time = new Intl.DateTimeFormat('ar-SA', {hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
      document.getElementById('todayLine').textContent = `Ø§Ù„ÙŠÙˆÙ…: ${greg} â€” Ù‡Ø¬Ø±ÙŠ: ${hijr} â€” Ø§Ù„ÙˆÙ‚Øª: ${time}`;
    }
    updateFooter();
    setInterval(updateFooter, 1000);
  </script>
</body>
</html>